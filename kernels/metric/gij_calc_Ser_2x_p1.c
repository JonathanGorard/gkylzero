#include "gkyl_calc_metric_kernels.h"

static inline double calc_metric(double dxdz[2][2], int i, int j) 
{ double sum = 0;   for (int k=0; k<2; ++k) sum += dxdz[k][i-1]*dxdz[k][j-1]; return sum; } 

GKYL_CU_DH void gij_2x_Ser_p1( const double **xyz, double *gij) 
{ 
const double *xyzI = xyz[0];
const double *xyzL = xyz[1];
const double *xyzR = xyz[2];
const double *xyzB = xyz[3];
const double *xyzT = xyz[4];
const double *x1I  = &xyzI[0 * 4];
const double *x1L  = &xyzL[0 * 4];
const double *x1R  = &xyzR[0 * 4];
const double *x1B  = &xyzB[0 * 4];
const double *x1T  = &xyzT[0 * 4];
const double *x2I  = &xyzI[1 * 4];
const double *x2L  = &xyzL[1 * 4];
const double *x2R  = &xyzR[1 * 4];
const double *x2B  = &xyzB[1 * 4];
const double *x2T  = &xyzT[1 * 4];
double *g11  = &gij[0 * 4];
double *g12  = &gij[1 * 4];
double *g22  = &gij[2 * 4];
double g11_n[4], g12_n[4], g13_n[4], g22_n[4], g23_n[4], g33_n[4]; 
do { 
  double dxdz[2][2]; 
  dxdz[0][0] = 0.9375*x1L[3]+0.9375*x1I[3]+0.9742785792574913*x1L[2]-0.9742785792574933*x1I[2]-0.5412658773652739*x1L[1]-0.5412658773652748*x1I[1]-0.5625*x1L[0]+0.5625*x1I[0]; 
  dxdz[0][1] = 0.9375*x1I[3]+0.9375*x1B[3]-0.5412658773652748*x1I[2]-0.5412658773652739*x1B[2]-0.9742785792574933*x1I[1]+0.9742785792574913*x1B[1]+0.5625*x1I[0]-0.5625*x1B[0]; 
  dxdz[1][0] = 0.9375*x2L[3]+0.9375*x2I[3]+0.9742785792574913*x2L[2]-0.9742785792574933*x2I[2]-0.5412658773652739*x2L[1]-0.5412658773652748*x2I[1]-0.5625*x2L[0]+0.5625*x2I[0]; 
  dxdz[1][1] = 0.9375*x2I[3]+0.9375*x2B[3]-0.5412658773652748*x2I[2]-0.5412658773652739*x2B[2]-0.9742785792574933*x2I[1]+0.9742785792574913*x2B[1]+0.5625*x2I[0]-0.5625*x2B[0]; 
  g11_n[0] = calc_metric(dxdz, 1, 1); 
  g12_n[0] = calc_metric(dxdz, 1, 2); 
  g22_n[0] = calc_metric(dxdz, 2, 2); 
 } while (0); 
do { 
  double dxdz[2][2]; 
  dxdz[0][0] = 0.9375*x1R[3]+0.9375*x1I[3]-0.9742785792574913*x1R[2]+0.9742785792574933*x1I[2]-0.5412658773652739*x1R[1]-0.5412658773652748*x1I[1]+0.5625*x1R[0]-0.5625*x1I[0]; 
  dxdz[0][1] = (-0.9375*x1I[3])-0.9375*x1B[3]-0.5412658773652748*x1I[2]-0.5412658773652739*x1B[2]+0.9742785792574933*x1I[1]-0.9742785792574913*x1B[1]+0.5625*x1I[0]-0.5625*x1B[0]; 
  dxdz[1][0] = 0.9375*x2R[3]+0.9375*x2I[3]-0.9742785792574913*x2R[2]+0.9742785792574933*x2I[2]-0.5412658773652739*x2R[1]-0.5412658773652748*x2I[1]+0.5625*x2R[0]-0.5625*x2I[0]; 
  dxdz[1][1] = (-0.9375*x2I[3])-0.9375*x2B[3]-0.5412658773652748*x2I[2]-0.5412658773652739*x2B[2]+0.9742785792574933*x2I[1]-0.9742785792574913*x2B[1]+0.5625*x2I[0]-0.5625*x2B[0]; 
  g11_n[1] = calc_metric(dxdz, 1, 1); 
  g12_n[1] = calc_metric(dxdz, 1, 2); 
  g22_n[1] = calc_metric(dxdz, 2, 2); 
 } while (0); 
do { 
  double dxdz[2][2]; 
  dxdz[0][0] = (-0.9375*x1L[3])-0.9375*x1I[3]-0.9742785792574913*x1L[2]+0.9742785792574933*x1I[2]-0.5412658773652739*x1L[1]-0.5412658773652748*x1I[1]-0.5625*x1L[0]+0.5625*x1I[0]; 
  dxdz[0][1] = 0.9375*x1T[3]+0.9375*x1I[3]-0.5412658773652739*x1T[2]-0.5412658773652748*x1I[2]-0.9742785792574913*x1T[1]+0.9742785792574933*x1I[1]+0.5625*x1T[0]-0.5625*x1I[0]; 
  dxdz[1][0] = (-0.9375*x2L[3])-0.9375*x2I[3]-0.9742785792574913*x2L[2]+0.9742785792574933*x2I[2]-0.5412658773652739*x2L[1]-0.5412658773652748*x2I[1]-0.5625*x2L[0]+0.5625*x2I[0]; 
  dxdz[1][1] = 0.9375*x2T[3]+0.9375*x2I[3]-0.5412658773652739*x2T[2]-0.5412658773652748*x2I[2]-0.9742785792574913*x2T[1]+0.9742785792574933*x2I[1]+0.5625*x2T[0]-0.5625*x2I[0]; 
  g11_n[2] = calc_metric(dxdz, 1, 1); 
  g12_n[2] = calc_metric(dxdz, 1, 2); 
  g22_n[2] = calc_metric(dxdz, 2, 2); 
 } while (0); 
do { 
  double dxdz[2][2]; 
  dxdz[0][0] = (-0.9375*x1R[3])-0.9375*x1I[3]+0.9742785792574913*x1R[2]-0.9742785792574933*x1I[2]-0.5412658773652739*x1R[1]-0.5412658773652748*x1I[1]+0.5625*x1R[0]-0.5625*x1I[0]; 
  dxdz[0][1] = (-0.9375*x1T[3])-0.9375*x1I[3]-0.5412658773652739*x1T[2]-0.5412658773652748*x1I[2]+0.9742785792574913*x1T[1]-0.9742785792574933*x1I[1]+0.5625*x1T[0]-0.5625*x1I[0]; 
  dxdz[1][0] = (-0.9375*x2R[3])-0.9375*x2I[3]+0.9742785792574913*x2R[2]-0.9742785792574933*x2I[2]-0.5412658773652739*x2R[1]-0.5412658773652748*x2I[1]+0.5625*x2R[0]-0.5625*x2I[0]; 
  dxdz[1][1] = (-0.9375*x2T[3])-0.9375*x2I[3]-0.5412658773652739*x2T[2]-0.5412658773652748*x2I[2]+0.9742785792574913*x2T[1]-0.9742785792574933*x2I[1]+0.5625*x2T[0]-0.5625*x2I[0]; 
  g11_n[3] = calc_metric(dxdz, 1, 1); 
  g12_n[3] = calc_metric(dxdz, 1, 2); 
  g22_n[3] = calc_metric(dxdz, 2, 2); 
 } while (0); 
// Convert nodal to modal for gij 
  g11[0] = 0.5*g11_n[3]+0.5*g11_n[2]+0.5*g11_n[1]+0.5*g11_n[0]; 
  g11[1] = 0.2886751345948129*g11_n[3]-0.2886751345948129*g11_n[2]+0.2886751345948129*g11_n[1]-0.2886751345948129*g11_n[0]; 
  g11[2] = 0.2886751345948129*g11_n[3]+0.2886751345948129*g11_n[2]-0.2886751345948129*g11_n[1]-0.2886751345948129*g11_n[0]; 
  g11[3] = 0.1666666666666666*g11_n[3]-0.1666666666666666*g11_n[2]-0.1666666666666666*g11_n[1]+0.1666666666666666*g11_n[0]; 

  g12[0] = 0.5*g12_n[3]+0.5*g12_n[2]+0.5*g12_n[1]+0.5*g12_n[0]; 
  g12[1] = 0.2886751345948129*g12_n[3]-0.2886751345948129*g12_n[2]+0.2886751345948129*g12_n[1]-0.2886751345948129*g12_n[0]; 
  g12[2] = 0.2886751345948129*g12_n[3]+0.2886751345948129*g12_n[2]-0.2886751345948129*g12_n[1]-0.2886751345948129*g12_n[0]; 
  g12[3] = 0.1666666666666666*g12_n[3]-0.1666666666666666*g12_n[2]-0.1666666666666666*g12_n[1]+0.1666666666666666*g12_n[0]; 

  g22[0] = 0.5*g22_n[3]+0.5*g22_n[2]+0.5*g22_n[1]+0.5*g22_n[0]; 
  g22[1] = 0.2886751345948129*g22_n[3]-0.2886751345948129*g22_n[2]+0.2886751345948129*g22_n[1]-0.2886751345948129*g22_n[0]; 
  g22[2] = 0.2886751345948129*g22_n[3]+0.2886751345948129*g22_n[2]-0.2886751345948129*g22_n[1]-0.2886751345948129*g22_n[0]; 
  g22[3] = 0.1666666666666666*g22_n[3]-0.1666666666666666*g22_n[2]-0.1666666666666666*g22_n[1]+0.1666666666666666*g22_n[0]; 

 
}
