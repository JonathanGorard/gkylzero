#include "gkyl_calc_bmag_kernels.h"

static inline double magnitude(double B_R, double B_Z, double B_PHI) 
{ double mag = 0;  mag = sqrt(B_R*B_R + B_Z*B_Z + B_PHI*B_PHI); return mag; } 

GKYL_CU_DH void bmag_2x_Ser_p2( const double **psibyr, const double *psibyr2, const double *bphi, double *bmagout, double scale_factorR, double scale_factorZ) 
{ 
double B_R_n[8], B_Z_n[8], B_Z1_n[8], B_Z2_n[8], B_PHI_n[8]; 
const double *psibyrI = psibyr[0];
const double *psibyrL = psibyr[1];
const double *psibyrR = psibyr[2];
const double *psibyrB = psibyr[3];
const double *psibyrT = psibyr[4];
double bmag_n[8]; 
  B_R_n[0] = 1.77635683940025E-15*psibyrT[7]-1.161895003862241*psibyrI[7]+1.161895003862225*psibyrB[7]-1.77635683940025E-15*psibyrT[6]-2.662676050517599*psibyrI[6]-2.662676050517602*psibyrB[6]+0.6708203932499366*psibyrI[5]-0.6708203932499393*psibyrB[5]+2.096313728906043*psibyrI[4]-2.09631372890605*psibyrB[4]+2.0625*psibyrI[3]+2.0625*psibyrB[3]-1.190784930203602*psibyrI[2]-1.190784930203606*psibyrB[2]-1.623797632095826*psibyrI[1]+1.623797632095822*psibyrB[1]+0.9375*psibyrI[0]-0.9375*psibyrB[0]; 
  B_R_n[0] = B_R_n[0]*scale_factorZ; 
  B_Z1_n[0] = 1.77635683940025E-15*psibyrR[7]+2.662676050517602*psibyrL[7]+2.662676050517599*psibyrI[7]-1.77635683940025E-15*psibyrR[6]-1.161895003862225*psibyrL[6]+1.161895003862241*psibyrI[6]+2.09631372890605*psibyrL[5]-2.096313728906043*psibyrI[5]+0.6708203932499393*psibyrL[4]-0.6708203932499366*psibyrI[4]-2.0625*psibyrL[3]-2.0625*psibyrI[3]-1.623797632095822*psibyrL[2]+1.623797632095826*psibyrI[2]+1.190784930203606*psibyrL[1]+1.190784930203602*psibyrI[1]+0.9375*psibyrL[0]-0.9375*psibyrI[0]; 
  B_Z2_n[0] = 1.936491673103708*psibyr2[7]+1.936491673103708*psibyr2[6]-1.118033988749895*psibyr2[5]-1.118033988749895*psibyr2[4]-1.5*psibyr2[3]+0.8660254037844386*psibyr2[2]+0.8660254037844386*psibyr2[1]-0.5*psibyr2[0]; 
  B_Z_n[0] = B_Z1_n[0]*scale_factorR + B_Z2_n[0]; 
  B_PHI_n[0] = (-1.936491673103708*bphi[7])-1.936491673103708*bphi[6]+1.118033988749895*bphi[5]+1.118033988749895*bphi[4]+1.5*bphi[3]-0.8660254037844386*bphi[2]-0.8660254037844386*bphi[1]+0.5*bphi[0]; 
  bmag_n[0] = magnitude(B_R_n[0], B_Z_n[0], B_PHI_n[0]); 
  B_R_n[1] = 8.881784197001253E-16*psibyrT[6]+1.331338025258801*psibyrI[6]+1.331338025258799*psibyrB[6]+0.6708203932499366*psibyrI[5]-0.6708203932499393*psibyrB[5]-1.048156864453021*psibyrI[4]+1.048156864453025*psibyrB[4]-1.190784930203602*psibyrI[2]-1.190784930203606*psibyrB[2]+0.9375*psibyrI[0]-0.9375*psibyrB[0]; 
  B_R_n[1] = B_R_n[1]*scale_factorZ; 
  B_Z1_n[1] = (-0.9758102571499157*psibyrR[7])-0.9758102571499157*psibyrL[7]-4.523523517640695*psibyrI[7]-0.5764088495722758*psibyrR[6]+0.5764088495722758*psibyrL[6]+0.6550980402831419*psibyrR[5]-0.6550980402831419*psibyrL[5]+0.3327898044638359*psibyrR[4]-0.3327898044638359*psibyrL[4]+0.755859375*psibyrR[3]+0.755859375*psibyrL[3]+3.50390625*psibyrI[3]-0.5074367600299444*psibyrR[2]+0.5074367600299444*psibyrL[2]-0.4363956136257522*psibyrR[1]-0.4363956136257522*psibyrL[1]-2.022981216652712*psibyrI[1]+0.29296875*psibyrR[0]-0.29296875*psibyrL[0]; 
  B_Z2_n[1] = (-0.9682458365518543*psibyr2[6])-1.118033988749895*psibyr2[5]+0.5590169943749475*psibyr2[4]+0.8660254037844386*psibyr2[2]-0.5*psibyr2[0]; 
  B_Z_n[1] = B_Z1_n[1]*scale_factorR + B_Z2_n[1]; 
  B_PHI_n[1] = 0.9682458365518543*bphi[6]+1.118033988749895*bphi[5]-0.5590169943749475*bphi[4]-0.8660254037844386*bphi[2]+0.5*bphi[0]; 
  bmag_n[1] = magnitude(B_R_n[1], B_Z_n[1], B_PHI_n[1]); 
  B_R_n[2] = (-1.77635683940025E-15*psibyrT[7])+1.161895003862241*psibyrI[7]-1.161895003862225*psibyrB[7]-1.77635683940025E-15*psibyrT[6]-2.662676050517599*psibyrI[6]-2.662676050517602*psibyrB[6]+0.6708203932499366*psibyrI[5]-0.6708203932499393*psibyrB[5]+2.096313728906043*psibyrI[4]-2.09631372890605*psibyrB[4]-2.0625*psibyrI[3]-2.0625*psibyrB[3]-1.190784930203602*psibyrI[2]-1.190784930203606*psibyrB[2]+1.623797632095826*psibyrI[1]-1.623797632095822*psibyrB[1]+0.9375*psibyrI[0]-0.9375*psibyrB[0]; 
  B_R_n[2] = B_R_n[2]*scale_factorZ; 
  B_Z1_n[2] = 2.662676050517602*psibyrR[7]+1.77635683940025E-15*psibyrL[7]+2.662676050517599*psibyrI[7]+1.161895003862225*psibyrR[6]+1.77635683940025E-15*psibyrL[6]-1.161895003862241*psibyrI[6]-2.09631372890605*psibyrR[5]+2.096313728906043*psibyrI[5]-0.6708203932499393*psibyrR[4]+0.6708203932499366*psibyrI[4]-2.0625*psibyrR[3]-2.0625*psibyrI[3]+1.623797632095822*psibyrR[2]-1.623797632095826*psibyrI[2]+1.190784930203606*psibyrR[1]+1.190784930203602*psibyrI[1]-0.9375*psibyrR[0]+0.9375*psibyrI[0]; 
  B_Z2_n[2] = (-1.936491673103708*psibyr2[7])+1.936491673103708*psibyr2[6]-1.118033988749895*psibyr2[5]-1.118033988749895*psibyr2[4]+1.5*psibyr2[3]+0.8660254037844386*psibyr2[2]-0.8660254037844386*psibyr2[1]-0.5*psibyr2[0]; 
  B_Z_n[2] = B_Z1_n[2]*scale_factorR + B_Z2_n[2]; 
  B_PHI_n[2] = 1.936491673103708*bphi[7]-1.936491673103708*bphi[6]+1.118033988749895*bphi[5]+1.118033988749895*bphi[4]-1.5*bphi[3]-0.8660254037844386*bphi[2]+0.8660254037844386*bphi[1]+0.5*bphi[0]; 
  bmag_n[2] = magnitude(B_R_n[2], B_Z_n[2], B_PHI_n[2]); 
  B_R_n[3] = 0.5764088495722758*psibyrT[7]-0.5764088495722758*psibyrB[7]+0.9758102571499157*psibyrT[6]+4.523523517640695*psibyrI[6]+0.9758102571499157*psibyrB[6]-0.3327898044638359*psibyrT[5]+0.3327898044638359*psibyrB[5]-0.6550980402831419*psibyrT[4]+0.6550980402831419*psibyrB[4]-0.755859375*psibyrT[3]-3.50390625*psibyrI[3]-0.755859375*psibyrB[3]+0.4363956136257522*psibyrT[2]+2.022981216652712*psibyrI[2]+0.4363956136257522*psibyrB[2]+0.5074367600299444*psibyrT[1]-0.5074367600299444*psibyrB[1]-0.29296875*psibyrT[0]+0.29296875*psibyrB[0]; 
  B_R_n[3] = B_R_n[3]*scale_factorZ; 
  B_Z1_n[3] = (-8.881784197001253E-16*psibyrR[7])-1.331338025258799*psibyrL[7]-1.331338025258801*psibyrI[7]-1.048156864453025*psibyrL[5]+1.048156864453021*psibyrI[5]+0.6708203932499393*psibyrL[4]-0.6708203932499366*psibyrI[4]+1.190784930203606*psibyrL[1]+1.190784930203602*psibyrI[1]+0.9375*psibyrL[0]-0.9375*psibyrI[0]; 
  B_Z2_n[3] = (-0.9682458365518543*psibyr2[7])+0.5590169943749475*psibyr2[5]-1.118033988749895*psibyr2[4]+0.8660254037844386*psibyr2[1]-0.5*psibyr2[0]; 
  B_Z_n[3] = B_Z1_n[3]*scale_factorR + B_Z2_n[3]; 
  B_PHI_n[3] = 0.9682458365518543*bphi[7]-0.5590169943749475*bphi[5]+1.118033988749895*bphi[4]-0.8660254037844386*bphi[1]+0.5*bphi[0]; 
  bmag_n[3] = magnitude(B_R_n[3], B_Z_n[3], B_PHI_n[3]); 
  B_R_n[4] = (-0.5764088495722758*psibyrT[7])+0.5764088495722758*psibyrB[7]+0.9758102571499157*psibyrT[6]+4.523523517640695*psibyrI[6]+0.9758102571499157*psibyrB[6]-0.3327898044638359*psibyrT[5]+0.3327898044638359*psibyrB[5]-0.6550980402831419*psibyrT[4]+0.6550980402831419*psibyrB[4]+0.755859375*psibyrT[3]+3.50390625*psibyrI[3]+0.755859375*psibyrB[3]+0.4363956136257522*psibyrT[2]+2.022981216652712*psibyrI[2]+0.4363956136257522*psibyrB[2]-0.5074367600299444*psibyrT[1]+0.5074367600299444*psibyrB[1]-0.29296875*psibyrT[0]+0.29296875*psibyrB[0]; 
  B_R_n[4] = B_R_n[4]*scale_factorZ; 
  B_Z1_n[4] = (-1.331338025258799*psibyrR[7])-8.881784197001253E-16*psibyrL[7]-1.331338025258801*psibyrI[7]+1.048156864453025*psibyrR[5]-1.048156864453021*psibyrI[5]-0.6708203932499393*psibyrR[4]+0.6708203932499366*psibyrI[4]+1.190784930203606*psibyrR[1]+1.190784930203602*psibyrI[1]-0.9375*psibyrR[0]+0.9375*psibyrI[0]; 
  B_Z2_n[4] = 0.9682458365518543*psibyr2[7]+0.5590169943749475*psibyr2[5]-1.118033988749895*psibyr2[4]-0.8660254037844386*psibyr2[1]-0.5*psibyr2[0]; 
  B_Z_n[4] = B_Z1_n[4]*scale_factorR + B_Z2_n[4]; 
  B_PHI_n[4] = (-0.9682458365518543*bphi[7])-0.5590169943749475*bphi[5]+1.118033988749895*bphi[4]+0.8660254037844386*bphi[1]+0.5*bphi[0]; 
  bmag_n[4] = magnitude(B_R_n[4], B_Z_n[4], B_PHI_n[4]); 
  B_R_n[5] = (-1.161895003862225*psibyrT[7])+1.161895003862241*psibyrI[7]-1.77635683940025E-15*psibyrB[7]-2.662676050517602*psibyrT[6]-2.662676050517599*psibyrI[6]-1.77635683940025E-15*psibyrB[6]+0.6708203932499393*psibyrT[5]-0.6708203932499366*psibyrI[5]+2.09631372890605*psibyrT[4]-2.096313728906043*psibyrI[4]+2.0625*psibyrT[3]+2.0625*psibyrI[3]-1.190784930203606*psibyrT[2]-1.190784930203602*psibyrI[2]-1.623797632095822*psibyrT[1]+1.623797632095826*psibyrI[1]+0.9375*psibyrT[0]-0.9375*psibyrI[0]; 
  B_R_n[5] = B_R_n[5]*scale_factorZ; 
  B_Z1_n[5] = 1.77635683940025E-15*psibyrR[7]+2.662676050517602*psibyrL[7]+2.662676050517599*psibyrI[7]+1.77635683940025E-15*psibyrR[6]+1.161895003862225*psibyrL[6]-1.161895003862241*psibyrI[6]+2.09631372890605*psibyrL[5]-2.096313728906043*psibyrI[5]+0.6708203932499393*psibyrL[4]-0.6708203932499366*psibyrI[4]+2.0625*psibyrL[3]+2.0625*psibyrI[3]+1.623797632095822*psibyrL[2]-1.623797632095826*psibyrI[2]+1.190784930203606*psibyrL[1]+1.190784930203602*psibyrI[1]+0.9375*psibyrL[0]-0.9375*psibyrI[0]; 
  B_Z2_n[5] = 1.936491673103708*psibyr2[7]-1.936491673103708*psibyr2[6]-1.118033988749895*psibyr2[5]-1.118033988749895*psibyr2[4]+1.5*psibyr2[3]-0.8660254037844386*psibyr2[2]+0.8660254037844386*psibyr2[1]-0.5*psibyr2[0]; 
  B_Z_n[5] = B_Z1_n[5]*scale_factorR + B_Z2_n[5]; 
  B_PHI_n[5] = (-1.936491673103708*bphi[7])+1.936491673103708*bphi[6]+1.118033988749895*bphi[5]+1.118033988749895*bphi[4]-1.5*bphi[3]+0.8660254037844386*bphi[2]-0.8660254037844386*bphi[1]+0.5*bphi[0]; 
  bmag_n[5] = magnitude(B_R_n[5], B_Z_n[5], B_PHI_n[5]); 
  B_R_n[6] = 1.331338025258799*psibyrT[6]+1.331338025258801*psibyrI[6]+8.881784197001253E-16*psibyrB[6]+0.6708203932499393*psibyrT[5]-0.6708203932499366*psibyrI[5]-1.048156864453025*psibyrT[4]+1.048156864453021*psibyrI[4]-1.190784930203606*psibyrT[2]-1.190784930203602*psibyrI[2]+0.9375*psibyrT[0]-0.9375*psibyrI[0]; 
  B_R_n[6] = B_R_n[6]*scale_factorZ; 
  B_Z1_n[6] = (-0.9758102571499157*psibyrR[7])-0.9758102571499157*psibyrL[7]-4.523523517640695*psibyrI[7]+0.5764088495722758*psibyrR[6]-0.5764088495722758*psibyrL[6]+0.6550980402831419*psibyrR[5]-0.6550980402831419*psibyrL[5]+0.3327898044638359*psibyrR[4]-0.3327898044638359*psibyrL[4]-0.755859375*psibyrR[3]-0.755859375*psibyrL[3]-3.50390625*psibyrI[3]+0.5074367600299444*psibyrR[2]-0.5074367600299444*psibyrL[2]-0.4363956136257522*psibyrR[1]-0.4363956136257522*psibyrL[1]-2.022981216652712*psibyrI[1]+0.29296875*psibyrR[0]-0.29296875*psibyrL[0]; 
  B_Z2_n[6] = 0.9682458365518543*psibyr2[6]-1.118033988749895*psibyr2[5]+0.5590169943749475*psibyr2[4]-0.8660254037844386*psibyr2[2]-0.5*psibyr2[0]; 
  B_Z_n[6] = B_Z1_n[6]*scale_factorR + B_Z2_n[6]; 
  B_PHI_n[6] = (-0.9682458365518543*bphi[6])+1.118033988749895*bphi[5]-0.5590169943749475*bphi[4]+0.8660254037844386*bphi[2]+0.5*bphi[0]; 
  bmag_n[6] = magnitude(B_R_n[6], B_Z_n[6], B_PHI_n[6]); 
  B_R_n[7] = 1.161895003862225*psibyrT[7]-1.161895003862241*psibyrI[7]+1.77635683940025E-15*psibyrB[7]-2.662676050517602*psibyrT[6]-2.662676050517599*psibyrI[6]-1.77635683940025E-15*psibyrB[6]+0.6708203932499393*psibyrT[5]-0.6708203932499366*psibyrI[5]+2.09631372890605*psibyrT[4]-2.096313728906043*psibyrI[4]-2.0625*psibyrT[3]-2.0625*psibyrI[3]-1.190784930203606*psibyrT[2]-1.190784930203602*psibyrI[2]+1.623797632095822*psibyrT[1]-1.623797632095826*psibyrI[1]+0.9375*psibyrT[0]-0.9375*psibyrI[0]; 
  B_R_n[7] = B_R_n[7]*scale_factorZ; 
  B_Z1_n[7] = 2.662676050517602*psibyrR[7]+1.77635683940025E-15*psibyrL[7]+2.662676050517599*psibyrI[7]-1.161895003862225*psibyrR[6]-1.77635683940025E-15*psibyrL[6]+1.161895003862241*psibyrI[6]-2.09631372890605*psibyrR[5]+2.096313728906043*psibyrI[5]-0.6708203932499393*psibyrR[4]+0.6708203932499366*psibyrI[4]+2.0625*psibyrR[3]+2.0625*psibyrI[3]-1.623797632095822*psibyrR[2]+1.623797632095826*psibyrI[2]+1.190784930203606*psibyrR[1]+1.190784930203602*psibyrI[1]-0.9375*psibyrR[0]+0.9375*psibyrI[0]; 
  B_Z2_n[7] = (-1.936491673103708*psibyr2[7])-1.936491673103708*psibyr2[6]-1.118033988749895*psibyr2[5]-1.118033988749895*psibyr2[4]-1.5*psibyr2[3]-0.8660254037844386*psibyr2[2]-0.8660254037844386*psibyr2[1]-0.5*psibyr2[0]; 
  B_Z_n[7] = B_Z1_n[7]*scale_factorR + B_Z2_n[7]; 
  B_PHI_n[7] = 1.936491673103708*bphi[7]+1.936491673103708*bphi[6]+1.118033988749895*bphi[5]+1.118033988749895*bphi[4]+1.5*bphi[3]+0.8660254037844386*bphi[2]+0.8660254037844386*bphi[1]+0.5*bphi[0]; 
  bmag_n[7] = magnitude(B_R_n[7], B_Z_n[7], B_PHI_n[7]); 
  bmagout[0] = (-0.1666666666666666*bmag_n[7])+0.6666666666666666*bmag_n[6]-0.1666666666666666*bmag_n[5]+0.6666666666666666*bmag_n[4]+0.6666666666666666*bmag_n[3]-0.1666666666666666*bmag_n[2]+0.6666666666666666*bmag_n[1]-0.1666666666666666*bmag_n[0]; 
  bmagout[1] = 0.09622504486493762*bmag_n[7]-4.158640611673197E-18*bmag_n[6]-0.09622504486493762*bmag_n[5]+0.3849001794597504*bmag_n[4]-0.3849001794597504*bmag_n[3]+0.09622504486493762*bmag_n[2]-4.158640611673197E-18*bmag_n[1]-0.09622504486493762*bmag_n[0]; 
  bmagout[2] = 0.0962250448649376*bmag_n[7]+0.3849001794597504*bmag_n[6]+0.09622504486493759*bmag_n[5]+3.326912489338558E-17*bmag_n[4]+5.614164825758817E-17*bmag_n[3]-0.09622504486493762*bmag_n[2]-0.3849001794597504*bmag_n[1]-0.09622504486493762*bmag_n[0]; 
  bmagout[3] = 0.1666666666666666*bmag_n[7]-0.1666666666666666*bmag_n[5]-0.1666666666666666*bmag_n[2]+8.317281223346395E-18*bmag_n[1]+0.1666666666666666*bmag_n[0]; 
  bmagout[4] = 0.1490711984999859*bmag_n[7]-0.2981423969999719*bmag_n[6]+0.1490711984999859*bmag_n[5]-3.118980458754898E-18*bmag_n[4]+1.663456244669279E-17*bmag_n[3]+0.1490711984999859*bmag_n[2]-0.2981423969999719*bmag_n[1]+0.1490711984999859*bmag_n[0]; 
  bmagout[5] = 0.1490711984999859*bmag_n[7]-3.425906660311778E-17*bmag_n[6]+0.1490711984999859*bmag_n[5]-0.2981423969999719*bmag_n[4]-0.2981423969999719*bmag_n[3]+0.1490711984999859*bmag_n[2]+2.911048428171238E-17*bmag_n[1]+0.1490711984999859*bmag_n[0]; 
  bmagout[6] = 0.08606629658238706*bmag_n[7]-0.1721325931647741*bmag_n[6]+0.08606629658238706*bmag_n[5]+6.237960917509796E-18*bmag_n[4]-1.663456244669279E-17*bmag_n[3]-0.08606629658238706*bmag_n[2]+0.172132593164774*bmag_n[1]-0.08606629658238704*bmag_n[0]; 
  bmagout[7] = 0.08606629658238706*bmag_n[7]-0.08606629658238706*bmag_n[5]-0.1721325931647741*bmag_n[4]+0.172132593164774*bmag_n[3]+0.08606629658238706*bmag_n[2]-2.079320305836598E-17*bmag_n[1]-0.08606629658238704*bmag_n[0]; 
 
}
