// Test the FEM Poisson solver with spatially varying permittivity.
//
#include <acutest.h>

#include <math.h>
#include <gkyl_proj_on_basis.h>
#include <gkyl_range.h>
#include <gkyl_rect_decomp.h>
#include <gkyl_rect_grid.h>
#include <gkyl_array_rio.h>
#include <gkyl_fem_poisson.h>

void evalFunc2x_periodicx_periodicy_sol(double t, const double *xn, double* restrict fout, void *ctx)
{
  // These values have to match those in the test below.
  double gxx = 3.0;
  double gxy = 2.44948;
  double gyy = 2.0;

  double x = xn[0], y = xn[1];
  double amn[] = {0., 10., 0., 10., 0., 0., 10., 0., 0.};
  double bmn[] = {0., 10., 0., 10., 0., 0., 10., 0., 0.};
  fout[0] = 0.;
  for (int m=1; m<4; m++) {
    for (int n=1; n<4; n++) {
      double a = amn[(m-1)*3+(n-1)];
      double b = bmn[(m-1)*3+(n-1)];
      double t1 = a*cos(m*x)*cos(n*y);
      double t2 = b*sin(m*x)*sin(n*y);
      fout[0] += t1+t2;
    }
  }
}
void evalFunc2x_periodicx_periodicy(double t, const double *xn, double* restrict fout, void *ctx)
{
  // These values have to match those in the test below.
  double gxx = 3.0;
  double gxy = 2.44948;
  double gyy = 2.0;

  double x = xn[0], y = xn[1];
  double amn[] = {0., 10., 0., 10., 0., 0., 10., 0., 0.};
  double bmn[] = {0., 10., 0., 10., 0., 0., 10., 0., 0.};
  fout[0] = 0.;
  for (int m=1; m<4; m++) {
    for (int n=1; n<4; n++) {
      double a = amn[(m-1)*3+(n-1)];
      double b = bmn[(m-1)*3+(n-1)];
      double t1 = (a*gxx*pow(m,2) - 2*b*gxy*m*n + a*gyy*pow(n,2))*cos(m*x)*cos(n*y);
      double t2 = (b*gxx*pow(m,2) - 2*a*gxy*m*n + b*gyy*pow(n,2))*sin(m*x)*sin(n*y);
      fout[0] = fout[0] + (t1+t2);
    }
  }
}

void evalFunc2x_dirichletx_periodicy_sol(double t, const double *xn, double* restrict fout, void *ctx)
{
  // These values have to match those in the test below.
  double gxx = 3.0;
  double gxy = 2.44948;
  double gyy = 2.0;

  double x = xn[0], y = xn[1];
  double m = 5.;
  // RHSsource: (2*(2*M_PI - 45*x + 5*(M_PI - 9*x)*sin(m*y))*gxx)/15.
  //           +(m*((3*pow(M_PI,2) + 2*M_PI*x - 9*pow(x,2))*cos(m*y)*2.*gxy
  //                +m*(M_PI - 3*x)*(M_PI - x)*(M_PI + x)*sin(m*y)*gyy))/3.;
  fout[0] = ((x-4.*M_PI/5.) + (x-M_PI)*sin(m*y))*(x+M_PI)*(x-M_PI/3.);
}
void evalFunc2x_dirichletx_periodicy(double t, const double *xn, double* restrict fout, void *ctx)
{
  // These values have to match those in the test below.
  double gxx = 3.0;
  double gxy = 2.44948;
  double gyy = 2.0;

  double x = xn[0], y = xn[1];
  double m = 5.;
  // Expected solution: ((x-4.*M_PI/5.) + (x-M_PI)*sin(m*y))*(x+M_PI)*(x-M_PI/3.);
  fout[0] = (2*(2*M_PI - 45*x + 5*(M_PI - 9*x)*sin(m*y))*gxx)/15.
           +(m*((3*pow(M_PI,2) + 2*M_PI*x - 9*pow(x,2))*cos(m*y)*2.*gxy
                +m*(M_PI - 3*x)*(M_PI - x)*(M_PI + x)*sin(m*y)*gyy))/3.;
}

void evalFunc2x_periodicx_dirichlety_sol(double t, const double *xn, double* restrict fout, void *ctx)
{
  // These values have to match those in the test below.
  double gxx = 3.0;
  double gxy = 2.44948;
  double gyy = 2.0;

  double x = xn[0], y = xn[1];
  double m = 5.;
  // RHSsource: (2*(2*M_PI - 45*y + 5*(M_PI - 9*y)*sin(m*x))*gxx)/15.
  //           +(m*((3*pow(M_PI,2) + 2*M_PI*y - 9*pow(y,2))*cos(m*x)*2.*gxy
  //                +m*(M_PI - 3*y)*(M_PI - y)*(M_PI + y)*sin(m*x)*gyy))/3.;
  fout[0] = ((y-4.*M_PI/5.) + (y-M_PI)*sin(m*x))*(y+M_PI)*(y-M_PI/3.);
}
void evalFunc2x_periodicx_dirichlety(double t, const double *xn, double* restrict fout, void *ctx)
{
  // These values have to match those in the test below.
  double gxx = 3.0;
  double gxy = 2.44948;
  double gyy = 2.0;

  double x = xn[0], y = xn[1];
  double m = 5.;
  // Expected solution: ((y-4.*M_PI/5.) + (y-M_PI)*sin(m*x))*(y+M_PI)*(y-M_PI/3.);
  fout[0] = (5*pow(m,2)*(M_PI - 3*y)*(M_PI - y)*(M_PI + y)*sin(m*x)*gxx
    +5*m*(3*pow(M_PI,2) + 2*M_PI*y - 9*pow(y,2))*cos(m*x)*(gxy + gxy)
    +2*(2*M_PI - 45*y + 5*(M_PI - 9*y)*sin(m*x))*gyy)/15.;
}

void evalFunc2x_dirichletx_neumanny_dirichlety_sol(double t, const double *xn, double* restrict fout, void *ctx)
{
  // These values have to match those in the test below.
  double gxx = 3.0;
  double gxy = 2.44948;
  double gyy = 2.0;

  double x = xn[0], y = xn[1];
  double a = 2.;
  double c[] = {a/12.-0.5, 0.};
  double b = 5.;
  double d[] = {0., b/12.-0.5};
  // RHSsource:  (-3*((6 - 6*a*pow(x,2))*pow(y,2) + b*(-1 + a*pow(x,2))*pow(y,4)
  //     +4*(9*x - 5*a*pow(x,3) + 6*c[0])*d[0] - 12*(-1 + a*pow(x,2))*d[1])*gxx
  //     -4*y*(-3 + b*pow(y,2))*(-3*x + a*pow(x,3) - 3*c[0])*(gxy + gxy)
  //     -3*(-1 + b*pow(y,2))*(-6*pow(x,2) + a*pow(x,4) - 12*x*c[0] - 12*c[1])*gyy)/36.
  fout[0] = (pow(x,2)/2 - (a*pow(x,4))/12 + c[0]*x + c[1])*(pow(y,2)/2 - (b*pow(y,4))/12 + d[0]*x + d[1]);
}
void evalFunc2x_dirichletx_neumanny_dirichlety(double t, const double *xn, double* restrict fout, void *ctx)
{
  // These values have to match those in the test below.
  double gxx = 3.0;
  double gxy = 2.44948;
  double gyy = 2.0;

  double x = xn[0], y = xn[1];
  double a = 2.;
  double c[] = {a/12.-0.5, 0.};
  double b = 5.;
  double d[] = {0., b/12.-0.5};
  // Expected solution: (x^2/2 - (a*x^4)/12 + c*x + q)*(y^2/2 - (b*y^4)/12 + f*x + h)
  fout[0] = (-3*((6 - 6*a*pow(x,2))*pow(y,2) + b*(-1 + a*pow(x,2))*pow(y,4)
    +4*(9*x - 5*a*pow(x,3) + 6*c[0])*d[0] - 12*(-1 + a*pow(x,2))*d[1])*gxx
    -4*y*(-3 + b*pow(y,2))*(-3*x + a*pow(x,3) - 3*c[0])*(gxy + gxy)
    -3*(-1 + b*pow(y,2))*(-6*pow(x,2) + a*pow(x,4) - 12*x*c[0] - 12*c[1])*gyy)/36.;
}

// allocate array (filled with zeros)
static struct gkyl_array*
mkarr(long nc, long size)
{
  struct gkyl_array* a = gkyl_array_new(GKYL_DOUBLE, nc, size);
  return a;
}

static struct gkyl_array*
mkarr_cu(long nc, long size)
{
  struct gkyl_array* a = gkyl_array_cu_dev_new(GKYL_DOUBLE, nc, size);
  return a;
}

struct skin_ghost_ranges {
  struct gkyl_range lower_skin[GKYL_MAX_DIM];
  struct gkyl_range lower_ghost[GKYL_MAX_DIM];

  struct gkyl_range upper_skin[GKYL_MAX_DIM];
  struct gkyl_range upper_ghost[GKYL_MAX_DIM];
};

// Create ghost and skin sub-ranges given a parent range
static void
skin_ghost_ranges_init(struct skin_ghost_ranges *sgr,
  const struct gkyl_range *parent, const int *ghost)
{
  int ndim = parent->ndim;

  for (int d=0; d<ndim; ++d) {
    gkyl_skin_ghost_ranges(&sgr->lower_skin[d], &sgr->lower_ghost[d],
      d, GKYL_LOWER_EDGE, parent, ghost);
    gkyl_skin_ghost_ranges(&sgr->upper_skin[d], &sgr->upper_ghost[d],
      d, GKYL_UPPER_EDGE, parent, ghost);
  }
}

// Apply periodic BCs in one direction.
void
apply_periodic_bc(struct gkyl_array *buff, struct gkyl_array *fld, const int dir, const struct skin_ghost_ranges sgr)
{
  gkyl_array_copy_to_buffer(buff->data, fld, sgr.lower_skin[dir]);
  gkyl_array_copy_from_buffer(fld, buff->data, sgr.upper_ghost[dir]);

  gkyl_array_copy_to_buffer(buff->data, fld, sgr.upper_skin[dir]);
  gkyl_array_copy_from_buffer(fld, buff->data, sgr.lower_ghost[dir]);
}

void
test_2x(int poly_order, const int *cells, struct gkyl_poisson_bc bcs, bool use_gpu)
{
  // Determinant of g tensor has to be >0. Diagonal entries have to be  >0.
  double gxx = 3.0;
  double gxy = 2.44948;
  double gyy = 2.0;

  double lower[] = {-M_PI,-M_PI}, upper[] = {M_PI,M_PI};
  if ((bcs.lo_type[0]==GKYL_POISSON_DIRICHLET && bcs.up_type[0]==GKYL_POISSON_DIRICHLET) &&
             (bcs.lo_type[1]==GKYL_POISSON_NEUMANN && bcs.up_type[1]==GKYL_POISSON_DIRICHLET)) {
    lower[0] = 0.;  lower[1] = 0.;
    upper[0] = 1.;  upper[1] = 1.;
  }
  int dim = sizeof(lower)/sizeof(lower[0]);

  // Grids.
  struct gkyl_rect_grid grid;
  gkyl_rect_grid_init(&grid, dim, lower, upper, cells);

  // Basis functions.
  struct gkyl_basis basis;
  gkyl_cart_modal_serendip(&basis, dim, poly_order);

  int ghost[] = { 1, 1 };
  struct gkyl_range localRange, localRange_ext; // Local, local-ext ranges.
  gkyl_create_grid_ranges(&grid, ghost, &localRange_ext, &localRange);
  struct skin_ghost_ranges skin_ghost; // Skin/ghost.
  skin_ghost_ranges_init(&skin_ghost, &localRange_ext, ghost);

  // Projection updater for DG field.
  gkyl_proj_on_basis *projob, *projob_sol;
  if (bcs.lo_type[0] == GKYL_POISSON_PERIODIC && bcs.lo_type[1] == GKYL_POISSON_PERIODIC) {
    projob = gkyl_proj_on_basis_new(&grid, &basis,
      poly_order+1, 1, evalFunc2x_periodicx_periodicy, NULL);
    projob_sol = gkyl_proj_on_basis_new(&grid, &basis,
      poly_order+1, 1, evalFunc2x_periodicx_periodicy_sol, NULL);
  } else if ((bcs.lo_type[0]==GKYL_POISSON_DIRICHLET && bcs.up_type[0]==GKYL_POISSON_DIRICHLET) &&
             (bcs.lo_type[1]==GKYL_POISSON_PERIODIC && bcs.up_type[1]==GKYL_POISSON_PERIODIC)) {
    projob = gkyl_proj_on_basis_new(&grid, &basis,
      poly_order+1, 1, evalFunc2x_dirichletx_periodicy, NULL);
    projob_sol = gkyl_proj_on_basis_new(&grid, &basis,
      poly_order+1, 1, evalFunc2x_dirichletx_periodicy_sol, NULL);
  } else if ((bcs.lo_type[0]==GKYL_POISSON_PERIODIC && bcs.up_type[0]==GKYL_POISSON_PERIODIC) &&
             (bcs.lo_type[1]==GKYL_POISSON_DIRICHLET && bcs.up_type[1]==GKYL_POISSON_DIRICHLET)) {
    projob = gkyl_proj_on_basis_new(&grid, &basis,
      poly_order+1, 1, evalFunc2x_periodicx_dirichlety, NULL);
    projob_sol = gkyl_proj_on_basis_new(&grid, &basis,
      poly_order+1, 1, evalFunc2x_periodicx_dirichlety_sol, NULL);
  } else if ((bcs.lo_type[0]==GKYL_POISSON_DIRICHLET && bcs.up_type[0]==GKYL_POISSON_DIRICHLET) &&
             (bcs.lo_type[1]==GKYL_POISSON_NEUMANN && bcs.up_type[1]==GKYL_POISSON_DIRICHLET)) {
    projob = gkyl_proj_on_basis_new(&grid, &basis,
      poly_order+1, 1, evalFunc2x_dirichletx_neumanny_dirichlety, NULL);
    projob_sol = gkyl_proj_on_basis_new(&grid, &basis,
      poly_order+1, 1, evalFunc2x_dirichletx_neumanny_dirichlety_sol, NULL);
  }

  // Create DG field we wish to make continuous.
  struct gkyl_array *rho = mkarr(basis.num_basis, localRange_ext.volume);
  // Create array holding continuous field we'll compute.
  struct gkyl_array *phi = mkarr(basis.num_basis, localRange_ext.volume);
  // Create DG field for permittivity tensor.
  int epsnum = dim+ceil((pow(3.,dim-1)-dim)/2);
  struct gkyl_array *eps = use_gpu? mkarr_cu(epsnum*basis.num_basis, localRange_ext.volume)
                                  : mkarr(epsnum*basis.num_basis, localRange_ext.volume);
  // Device copies:
  struct gkyl_array *rho_cu, *phi_cu;
  if (use_gpu) {
    rho_cu = mkarr_cu(basis.num_basis, localRange_ext.volume);
    phi_cu = mkarr_cu(basis.num_basis, localRange_ext.volume);
  }

  // Project distribution function on basis.
  gkyl_proj_on_basis_advance(projob, 0.0, &localRange, rho);
  if (use_gpu) gkyl_array_copy(rho_cu, rho);
//  gkyl_grid_sub_array_write(&grid, &localRange, rho, "ctest_fem_poisson_vareps_2x_rho_1.gkyl");

  // Project the expected solution.
  if (projob_sol != NULL) {
    struct gkyl_array *phisol = mkarr(basis.num_basis, localRange_ext.volume);
    gkyl_proj_on_basis_advance(projob_sol, 0.0, &localRange, phisol);
//    gkyl_grid_sub_array_write(&grid, &localRange, phisol, "ctest_fem_poisson_vareps_2x_phisol_1.gkyl");
    gkyl_array_release(phisol);
    gkyl_proj_on_basis_release(projob_sol);
  }

  // Project the permittivity onto the basis.
  double dg0norm = pow(sqrt(2.),dim);
  gkyl_array_shiftc(eps, gxx*dg0norm, 0*basis.num_basis);
  gkyl_array_shiftc(eps, gxy*dg0norm, 1*basis.num_basis);
  gkyl_array_shiftc(eps, gyy*dg0norm, 2*basis.num_basis);
//  gkyl_grid_sub_array_write(&grid, &localRange, eps, "ctest_fem_poisson_vareps_2x_eps_1.gkyl");

  // FEM poisson solver.
  gkyl_fem_poisson *poisson = gkyl_fem_poisson_new(&grid, basis, &bcs, 0, eps, use_gpu);

  // Set the RHS source.
  if (use_gpu)
    gkyl_fem_poisson_set_rhs(poisson, rho_cu);
  else
    gkyl_fem_poisson_set_rhs(poisson, rho);

  // Solve the problem.
  if (use_gpu) {
    gkyl_fem_poisson_solve(poisson, phi_cu);
    gkyl_array_copy(phi, phi_cu);
#ifdef GKYL_HAVE_CUDA
    cudaDeviceSynchronize();
#endif
  } else {
    gkyl_fem_poisson_solve(poisson, phi);
  }

  if (bcs.lo_type[0] == GKYL_POISSON_PERIODIC && bcs.lo_type[1] == GKYL_POISSON_PERIODIC) {
    struct gkyl_array *sol_cellavg = gkyl_array_new(GKYL_DOUBLE, 1, localRange_ext.volume);
    double* sol_avg = (double*) gkyl_malloc(sizeof(double));
    gkyl_array_clear(sol_cellavg, 0.0);
    // Factor accounting for normalization when subtracting a constant from a
    // DG field and the 1/N to properly compute the volume averaged RHS.
    double mavgfac = -pow(sqrt(2.),dim)/localRange.volume;
    // Subtract the volume averaged sol from the sol.
    gkyl_dg_calc_average_range(basis, 0, sol_cellavg, 0, phi, localRange);
    gkyl_array_reduce_range(sol_avg, sol_cellavg, GKYL_SUM, localRange);
    gkyl_array_shiftc(phi, mavgfac*sol_avg[0], 0);

    gkyl_free(sol_avg);
    gkyl_array_release(sol_cellavg);
  }
//  gkyl_grid_sub_array_write(&grid, &localRange, phi, "ctest_fem_poisson_vareps_2x_phi_16x16_p1.gkyl");

  if (poly_order == 1) {
    if (bcs.lo_type[0] == GKYL_POISSON_PERIODIC && bcs.lo_type[1] == GKYL_POISSON_PERIODIC) {
      // Solution with N=8x8:
      const double sol[256] = {
        -1.0487258355542172e+01, -3.4672194615719323e+00, 1.2487089948838117e+00, -7.3829839001277786e-01, -1.5453564258762444e+00, -3.3771781285781359e+00,
        3.9139004912760469e+00, 7.9028377785493853e-01, 5.2215272976960074e+00, 4.6956135527195275e-01, -7.0383518967097811e-03, 1.4306322986482731e+00,
        1.4932886788449311e+00, 3.3046036633858393e+00, -2.1454612183001176e+00, 2.0618014110525743e-01, -2.9431153863741066e-02, 2.4254609580711044e+00,
        1.2663185129853838e+00, -7.1375341867481512e-01, 5.9015118519390191e+00, 8.6215062070894122e-01, 2.1579130279631680e+00, -1.8882422542815416e-01,
        5.2951622117098962e+00, 5.7219714822887291e-01, -2.5079891559724854e+00, 2.1419510039319974e-02, -5.8494441049077164e+00, -7.8957615551664595e-01,
        -3.9263523009390977e+00, -8.0763969353204146e-01, -6.7270067596276100e+00, 5.6382017326939247e+00, -3.3771781285781368e+00, -1.9324587859588025e+00,
        -9.4839930397771006e+00, -1.2061958574561431e+00, 1.7854313575817238e+00, -2.0191560051551658e+00, -3.6051177810056378e+00, -5.5656272675016334e+00,
        1.6087388556022115e+00, -4.9776289294830867e-01, -3.0508358878078150e+00, -5.9281552051739945e+00, -1.2887240553575130e+00, 2.8845729054441199e-01,
        -3.7896827497783017e+00, -4.5964432291930963e+00, 8.6215062070894188e-01, 4.8040697727120762e-01, 5.1278376137143153e+00, -1.3088316504130526e+00,
        4.2863821616574915e+00, 1.4176964527283813e+00, 1.4121807290411542e+01, 4.5238687640008095e+00, 9.0628865226698430e-01, 1.9498147016359040e+00,
        7.4069913138705905e+00, 8.4431827130431927e+00, -4.7830894638817023e+00, 3.1300226188237157e-01, 1.0319933757546561e+01, 4.2038539637561216e+00,
        -3.0271020005688309e+00, 2.1345753327018371e+00, 3.6051177810055952e+00, 8.7631975132878779e+00, -8.4969881104589473e-01, 4.9776289294830606e-01,
        2.2148951700382993e+00, 8.9258133114739593e+00, 4.7053412370420863e-02, -4.0387661809108605e-01, -3.5530500339743374e+00, 5.6382017326939149e+00,
        -3.3771781285781279e+00, -1.4942268119085045e+00, -1.4676089183609335e+01, -1.6888264558869253e+00, -3.0447115186703853e+00, -2.7360348851286194e+00,
        -1.4121807290411509e+01, -9.8049560167887009e+00, 3.3647263189150864e+00, -1.9498147016359004e+00, 2.1412602560244745e+00, -1.1440840819343155e+01,
        6.0247601068687962e+00, 1.0053361705178678e+00, 1.4069739543380248e+01, -4.5964432291930901e+00, 8.6215062070893500e-01, 2.9462786205960989e+00,
        -1.4932886788448974e+00, -1.1024221117403657e+01, 3.1297644834797150e-01, -2.0618014110525401e-01, 2.0475705720427344e+00, -9.6624478136581367e+00,
        1.7313395933145797e+00, 9.9240032459797578e-01, 1.1825413219478111e+01, -3.3771781285781262e+00, 3.9139004912760385e+00, 2.6364018200123627e+00,
        1.7756356225280861e+01, 6.6647897073581737e+00, -4.8966895032749230e-01, 3.1613310132590238e+00, 5.8494441049076764e+00, 1.3539248625272847e+01,
        -6.3847899675871842e+00, 8.0763969353203824e-01, -1.2564260081448641e+01, 1.0704206317158961e+01, -4.2463671011837762e+00, -2.4444521332855680e+00,
        -1.6181568645540896e+01, 8.6215062070893345e-01, 2.1579130279631737e+00, -3.2378613724391472e+00, -7.2396667158749599e+00, -7.7065482108590002e+00,
        3.0046964581966891e+00, -1.7092792045714316e+00, -7.2396667158749564e+00, 7.7065482108589975e+00, -3.0046964581966829e+00, -1.7092792045714302e+00,
        -1.6181568645540882e+01, -8.6215062070893089e-01, -2.1579130279631746e+00, -3.2378613724391458e+00, -1.2564260081448637e+01, -1.0704206317158961e+01,
        4.2463671011837727e+00, -2.4444521332855706e+00, 5.8494441049076782e+00, -1.3539248625272851e+01, 6.3847899675871851e+00, 8.0763969353203946e-01,
        1.7756356225280864e+01, -6.6647897073581719e+00, 4.8966895032749130e-01, 3.1613310132590242e+00, 1.1825413219478115e+01, 3.3771781285781279e+00,
        -3.9139004912760367e+00, 2.6364018200123640e+00, 2.0475705720427291e+00, 9.6624478136581367e+00, -1.7313395933145861e+00, 9.9240032459797478e-01,
        -1.4932886788449089e+00, 1.1024221117403654e+01, -3.1297644834796867e-01, -2.0618014110525504e-01, 1.4069739543380248e+01, 4.5964432291930901e+00,
        -8.6215062070892989e-01, 2.9462786205960971e+00, 2.1412602560244904e+00, 1.1440840819343155e+01, -6.0247601068687908e+00, 1.0053361705178696e+00,
        -1.4121807290411496e+01, 9.8049560167887044e+00, -3.3647263189150931e+00, -1.9498147016358995e+00, -1.4676089183609333e+01, 1.6888264558869279e+00,
        3.0447115186703857e+00, -2.7360348851286211e+00, -3.5530500339743369e+00, -5.6382017326939131e+00, 3.3771781285781262e+00, -1.4942268119085040e+00,
        2.2148951700383011e+00, -8.9258133114739593e+00, -4.7053412370418296e-02, -4.0387661809108694e-01, 3.6051177810055952e+00, -8.7631975132878761e+00,
        8.4969881104589007e-01, 4.9776289294830811e-01, 1.0319933757546551e+01, -4.2038539637561172e+00, 3.0271020005688305e+00, 2.1345753327018371e+00,
        7.4069913138705923e+00, -8.4431827130431909e+00, 4.7830894638817041e+00, 3.1300226188237157e-01, 1.4121807290411557e+01, -4.5238687640008104e+00,
        -9.0628865226697919e-01, 1.9498147016359024e+00, 5.1278376137143313e+00, 1.3088316504130499e+00, -4.2863821616574942e+00, 1.4176964527283822e+00,
        -3.7896827497782946e+00, 4.5964432291930963e+00, -8.6215062070894288e-01, 4.8040697727120818e-01, -3.0508358878078097e+00, 5.9281552051739954e+00,
        1.2887240553575130e+00, 2.8845729054441255e-01, -3.6051177810056338e+00, 5.5656272675016352e+00, -1.6087388556022122e+00, -4.9776289294830967e-01,
        -9.4839930397771006e+00, 1.2061958574561427e+00, -1.7854313575817249e+00, -2.0191560051551658e+00, -6.7270067596276117e+00, -5.6382017326939247e+00,
        3.3771781285781368e+00, -1.9324587859588018e+00, -5.8494441049077155e+00, 7.8957615551664562e-01, 3.9263523009390977e+00, -8.0763969353204135e-01,
        5.2951622117098980e+00, -5.7219714822887602e-01, 2.5079891559724858e+00, 2.1419510039318492e-02, 5.9015118519390226e+00, -8.6215062070894533e-01,
        -2.1579130279631680e+00, -1.8882422542815386e-01, -2.9431153863737514e-02, -2.4254609580711071e+00, -1.2663185129853838e+00, -7.1375341867481512e-01,
        1.4932886788449364e+00, -3.3046036633858407e+00, 2.1454612183001189e+00, 2.0618014110525712e-01, 5.2215272976960128e+00, -4.6956135527195375e-01,
        7.0383518967087558e-03, 1.4306322986482738e+00, -1.5453564258762436e+00, 3.3771781285781368e+00, -3.9139004912760487e+00, 7.9028377785493842e-01,
        -1.0487258355542172e+01, 3.4672194615719323e+00, -1.2487089948838108e+00, -7.3829839001277808e-01,
      };
      for (int j=0; j<cells[0]; j++) {
        for (int k=0; k<cells[1]; k++) {
          int idx0[] = {j+1,k+1};
          long linidx = gkyl_range_idx(&localRange, idx0);
          const double *phi_p = gkyl_array_cfetch(phi, linidx);
          for (int m=0; m<basis.num_basis; m++) {
            TEST_CHECK( gkyl_compare(sol[(j*cells[1]+k)*basis.num_basis+m], phi_p[m], 1e-10) );
            TEST_MSG("Expected: %.13e in cell (%d,%d)", sol[(j*cells[1]+k)*basis.num_basis+m], j, k);
            TEST_MSG("Produced: %.13e", phi_p[m]);
          }
        }
      }
    } else if ((bcs.lo_type[0]==GKYL_POISSON_DIRICHLET && bcs.up_type[0]==GKYL_POISSON_DIRICHLET) &&
              (bcs.lo_type[1]==GKYL_POISSON_PERIODIC && bcs.up_type[1]==GKYL_POISSON_PERIODIC)) {
      // Solution with N=8x8:
      const double sol[256] = {
        22.734370830726306 ,  13.125695118976289 ,  -3.945074572528958 , -2.2776898664234544,
         4.1430157490856105,   2.391971257991416 ,  -6.788649288456215 , -3.919428494123271 ,
        15.846526665407206 ,   9.148996435993684 ,  13.545674466458212 ,  7.8205987995639585,
        17.886617881804142 ,  10.32684364895111  , -12.367827253500051 , -7.1405683940987394,
         3.297982298775476 ,   1.9040909679812303,   3.945074572529099 ,  2.277689866423136 ,
        21.88933738041535  ,  12.63781482896598  ,   6.788649288455599 ,  3.9194284941235193,
        10.185826464094799 ,   5.880789650963231 , -13.545674466456994 , -7.820598799564486 ,
         8.145735247698687 ,   4.702942438005926 ,  12.367827253499309 ,  7.1405683940993345,
        52.060758559828486 ,   3.8059027307801987,   1.6206081646797366,  5.491038292974948 ,
        14.900603982252303 ,   3.8189252042585258, -23.075033413171454 , -5.48351976440672  ,
        28.648555703845823 ,  -1.7577415244777435,  31.012417040439452 ,  2.263829727390006 ,
        46.36617050189349  ,   6.115833722657592 , -20.78314736738853  ,  2.2819810610283544,
         7.561727639998614 ,   0.5575835525299617,  -1.620608164679934 , -5.4910382929748245,
        44.721882217574105 ,   0.5445610790518283,  23.075033413171248 ,  5.48351976440671  ,
        30.973930495980493 ,   6.121227807787921 , -31.0124170404393   , -2.2638297273900965,
        13.256315697933521 ,  -1.7523474393476068,  20.78314736738878  , -2.2819810610283753,
        52.42701650766966  ,  -3.594443606001256 ,  15.739268866564824 ,  2.6603742638553998,
        23.899287301995784 ,   1.3764670327475685, -32.20976100282939  ,  0.2095823315438092,
        19.74661058849544  ,  -3.381798884181076 ,  29.81221198443248  , -2.9567684395583833,
        54.14711152255226  ,  -1.6235053298316517,  -9.951073509896792 ,  3.971919696476408 ,
         9.650133262681052 ,   0.648157995902873 , -15.739268866564776 , -2.6603742638553802,
        38.177862468354775 ,  -4.322752642845835 ,  32.209761002829254 , -0.2095823315437611,
        42.3305391818548   ,   0.4355132740828546, -29.81221198443252  ,  2.956768439558362 ,
         7.930038247798141 ,  -1.322780280266687 ,   9.951073509896931 , -3.9719196964764536,
        35.07594487422056  ,  -6.423202272299062 ,  20.102030185321045 , -0.1415328420614093,
        23.825570505411957 ,  -1.4190274450990383, -26.597436855636765 ,  3.030694525617292 ,
         8.089869666290408 ,  -3.3482236251277255,  17.512425740282517 , -4.144516459476453 ,
        41.59388557523048  ,  -5.624103050052774 ,   1.8311268636775433,  2.830536860852845 ,
         9.947752721965076 ,  -0.4763273209691713, -20.102030185320988 ,  0.1415328420613958,
        21.198127090773767 ,  -5.480502148169174 ,  26.59743685563675  , -3.030694525617267 ,
        36.93382792989518  ,  -3.5513059681404244, -17.51242574028258  ,  4.144516459476464 ,
         3.429812020955032 ,  -1.2754265432153953,  -1.8311268636775244, -2.8305368608528676,
        12.487424458224453 ,  -6.618286070471654 ,  16.734971692483434 , -1.8024392851556001,
        16.8072546664208   ,  -2.6329990938003207, -14.240916558927797 ,  4.103345793934705 ,
        -1.9615785556745362,  -2.45498271156932  ,   3.404725645775862 , -4.000567987733473 ,
        20.261729728735126 ,  -6.692022870316367 ,   9.425907374512102 ,  1.5543117115136114,
         7.602058974220037 ,  -0.8779595957278498, -16.734971692483423 ,  1.8024392851555864,
         3.2822287660237572,  -4.863246572399208 ,  14.240916558927825 , -4.103345793934706 ,
        22.0510619881191   ,  -5.041262954630193 ,  -3.4047256457758874,  4.000567987733484 ,
        -0.1722462962906359,  -0.8042227958831216,  -9.425907374512114 , -1.5543117115136071,
        -6.229569715633301 ,  -4.18797555422578  ,   8.147483378324223 , -3.155549404686988 ,
         7.600917434960932 ,  -2.6822821850335097,  -0.1624478989049808,  4.02486187670718  ,
        -6.39439128250139  ,  -0.1043029095313632,  -7.917747356513808 , -2.536464848030739 ,
        -0.4325230352620455,  -5.25580953365556  ,  11.359833593930528 , -0.4377588881395075,
         5.131430749872889 ,  -0.5484582746664621,  -8.147483378324235 ,  3.1555494046869876,
        -8.699056400721336 ,  -2.0541516438587415,   0.1624478989049978, -4.024861876707185 ,
         5.296252316741011 ,  -4.632130919360892 ,   7.9177473565138055,  2.5364648480307412,
        -0.6656159304983422,   0.5193757047633152, -11.35983359393053  ,  0.4377588881395105,
        -10.810726987224193,   1.5430431702727658,  -2.4776533786098813, -2.978876162105506 ,
         0.4878062472448956,  -1.4244744739700843,   9.000864582978544 ,  1.2655790513769316,
        -1.6783429198783772,   2.8271147012030537, -10.251491387722048 ,  1.189077103392979 ,
        -9.91347862407862  ,  -0.2180227277225759,   5.496933572088938 , -2.947188017702597 ,
         3.898911143907491 ,  -0.1631372516191521,   2.477653378609876 ,  2.9788761621055095,
        -7.399622090561606 ,   2.804380392623697 ,  -9.000864582978544 , -1.2655790513769358,
        -5.233472923438328 ,  -1.4472087825494466,  10.251491387722051 , -1.1890771033929781,
         3.001662780761924 ,   1.5979286463761837,  -5.4969335720889365,  2.9471880177025964,
         4.199291539060148 ,   7.122995066418769 ,  -3.818609120416201 ,  2.2046750036022527,
         7.27861249020183  ,   5.345148286355863 ,   5.596455900479105 , -3.2311153206494816,
         9.87752213879506  ,   3.844667101141045 ,  -4.095974715264289 ,  2.364812104451738 ,
         3.122787915230512 ,   7.744514723420415 ,   0.1961270929849189, -0.1132340299302217,
        10.076515015827935 ,   3.729778510019296 ,   3.8186091204161996, -2.2046750036022535,
         6.997194064686247 ,   5.5076252900822045,  -5.59645590047911  ,  3.231115320649484 ,
         4.398284416093016 ,   7.008106475297023 ,   4.095974715264291 , -2.3648121044517394,
        11.15301863965757  ,   3.108258853017651 ,  -0.1961270929849173,  0.1132340299302219,
      };
      for (int j=0; j<cells[0]; j++) {
        for (int k=0; k<cells[1]; k++) {
          int idx0[] = {j+1,k+1};
          long linidx = gkyl_range_idx(&localRange, idx0);
          const double *phi_p = gkyl_array_cfetch(phi, linidx);
          for (int m=0; m<basis.num_basis; m++) {
            TEST_CHECK( gkyl_compare(sol[(j*cells[1]+k)*basis.num_basis+m], phi_p[m], 1e-10) );
            TEST_MSG("Expected: %.13e in cell (%d,%d)", sol[(j*cells[1]+k)*basis.num_basis+m], j, k);
            TEST_MSG("Produced: %.13e", phi_p[m]);
          }
        }
      }
    } else if ((bcs.lo_type[0]==GKYL_POISSON_PERIODIC && bcs.up_type[0]==GKYL_POISSON_PERIODIC) &&
               (bcs.lo_type[1]==GKYL_POISSON_DIRICHLET && bcs.up_type[1]==GKYL_POISSON_DIRICHLET)) {
      // Solution with N=8x8:
      const double sol[256] = {
        22.546296767842215 ,  -2.171251024451982 ,  13.017110508143     ,  -1.253572363445537 ,
        50.92375002609591  ,   3.97827034412882  ,   3.3666197694257964 ,   4.80400018098302  ,
        51.06156064013447  ,  14.536294440523537 ,  -3.2870547743134426 ,   1.2916778731810277,
        35.161182830840765 ,  15.854518698111484 ,  -5.893032634099033  ,  -0.5306007432103331,
        13.982658785388029 ,  12.365469949376859 ,  -6.334393924582068  ,  -1.4838024910873295,
        -4.468909270163868 ,   5.717608387446057 ,  -4.318623859261521  ,  -2.3543421712287853,
        -9.9733872194679   ,  -2.794128262242933 ,   1.1406120334824776 ,  -2.559911274740357 ,
         4.269445835204085 ,  -3.6140123264807964,   7.082491464655293  ,   2.0865509895483414,
         5.175875409986401 ,  -7.857566422443296 ,   2.9882930612475262 ,  -4.5365680891731825,
        16.900646445855752 , -23.621518354846998 ,   3.781006652498372  ,  -4.564753802492417 ,
        24.254534337939802 , -30.01333829226902  ,   0.4647625015866842 ,   0.8744348410101994,
        21.61051037682827  , -23.678003087136048 ,  -1.9912904472782482 ,   2.783272645079833 ,
        13.53329016180549  , -12.624913045167608 ,  -2.672094818169042  ,   3.5982318660278167,
         5.1232524875614045,  -0.1795712145129375,  -2.183442696950677  ,   3.5870895900575697,
        -0.2648319678107458,   8.399365250229547 ,  -0.9273693137748725 ,   1.3659616872222011,
         7.332799079755453 ,   5.382640146845442 ,   5.3138636442906755 ,  -3.1076687377321153,
        14.573916587816605 ,  13.28352802631875  ,   8.414254665123067  ,   7.6692484817833   ,
        26.95707706022673  ,  29.427601277140873 ,  -1.2648336329587488 ,   1.6515365553958905,
        20.609671279804072 ,  27.908975624495028 ,  -2.3998428030240584 ,  -2.5283154847492426,
        11.13719978498403  ,  17.631234397628216 ,  -3.06909116440135   ,  -3.405541179243627 ,
         1.173272122316551 ,   5.488853302880039 ,  -2.6835851538256796 ,  -3.604865814412256 ,
        -4.651104356342016 ,  -5.463656340470164 ,  -0.6791201739895689 ,  -2.7185685764779564,
        -1.4512915163426436,  -9.08436798995704  ,   2.526532978519627  ,   0.6281497309886949,
         9.730736432805806 ,  -3.99819037056196  ,   3.9294138680071504 ,   2.308356286715305 ,
        18.653500652244155 , -10.9281790685398   ,  10.769603622902233  ,  -6.309387126973994 ,
        46.75824007655975  , -17.99539447939334  ,   5.456675249230666  ,   2.2291284070966295,
        52.57131235180712  ,  -9.455913547831864 ,  -2.1004964062978475 ,   2.7011432074800648,
        39.499370120928276 ,  -1.2563277193687856,  -5.446592959531293  ,   2.0328898778265354,
        19.102345888520077 ,   4.862502262358224 ,  -6.3296344717169015 ,   1.4998182592491074,
        -0.4202381019451584,   7.906348111351493 ,  -4.941734650455281  ,   0.2575469610388816,
        -9.481939583259177 ,   4.44787116675563  ,  -0.2900411390973994 ,  -2.254299555987418 ,
         3.2761876618493564,   0.2716549001526837,   7.655949338416311  ,  -0.1568400297298874,
         3.4860563616592164,   2.1712510244519323,   2.0126755788141875 ,   1.2535723634455773,
         8.698736173730346 ,  -3.9782703441288323,   0.9968665138844068 ,  -4.804000180983039 ,
        11.015589130215647 , -14.536294440523559 ,   0.340769164215163  ,  -1.2916778731810132,
         9.86251476534455  , -15.85451869811148  ,  -1.0064969591691462 ,   0.5306007432103317,
         6.106824647056244 , -12.365469949376868 ,  -1.1618517416174248 ,   1.483802491087325 ,
         3.3707703044033037,  -5.717608387446074 ,  -0.4178099696306948 ,   2.3543421712287853,
         3.061571376151134 ,   2.794128262242935 ,   0.2392938851711605 ,   2.559911274740368 ,
        10.006360719683936 ,   3.614012326480878 ,   3.7702821117827483 ,  -2.0865509895483068,
        20.85647771951526  ,   7.8575664224434805,  12.041493025709583  ,   4.536568089173095 ,
        42.721839753970514 ,  23.62151835484702  ,   0.5824796308117849 ,   4.564753802492409 ,
        37.822615432410274 ,  30.01333829226901  ,  -3.4110481116849485 ,  -0.8744348410102045,
        23.41318721935705  ,  23.678003087136048 ,  -4.908239145989923  ,  -2.7832726450798257,
         6.556193270638787 ,  12.62491304516762  ,  -4.824150848030459  ,  -3.5982318660278167,
        -6.221391453322001 ,   0.1795712145129341,  -2.5529911319415532 ,  -3.5870895900575777,
        -6.6469838755060575,  -8.399365250229572 ,   2.307275232428523  ,  -1.3659616872222047,
         6.943007475132667 ,  -5.3826401468454685,   5.538909932147433  ,   3.1076687377321184,
        11.45843654168509  , -13.283528026318917 ,   6.615531421834127  ,  -7.669248481783164 ,
        32.66540913959966  , -29.427601277140827 ,   5.628319916268867  ,  -1.651536555395904 ,
        41.467478490546014 , -27.90897562449502  ,  -0.5464428070742327 ,   2.5283154847492315,
        33.886497811201274 , -17.631234397628223 ,  -3.830438428866806  ,   3.4055411792436296,
        18.916211310127746 ,  -5.488853302880039 ,  -4.812660512373815  ,   3.604865814412259 ,
         3.5529653905814294,   5.463656340470172 ,  -4.057313654902672  ,   2.718568576477959 ,
        -5.460524326974218 ,   9.08436798995703  ,  -1.1466270598660062 ,  -0.6281497309887072,
         4.54507012208222  ,   3.9981903705619337,   6.923359708430967  ,  -2.3083562867153025,
         7.3788524772573085,  10.92817906853983  ,   4.260182464055043  ,   6.3093871269739035,
        12.864246123266621 ,  17.995394479393287 ,  -1.093188965920503  ,  -2.2291284070965895,
         9.505837418543004 ,   9.455913547831882 ,  -0.8457892038004596 ,  -2.7011432074800634,
         5.524327475257027 ,   1.2563277193687925,  -1.452936633736871  ,  -2.032889877826542 ,
         0.9871375439242183,  -4.862502262358228 ,  -1.166611194482586  ,  -1.4998182592491058,
        -0.6779008638153945,  -7.906348111351482 ,   0.2053008215630547 ,  -0.2575469610388753,
         2.570123739942353 ,  -4.447871166755599 ,   1.6699470577510085 ,   2.2542995559874233,
        10.999618893038576 ,  -0.2716549001527133,   3.1968242380217413 ,   0.156840029729847 ,
      };
      for (int j=0; j<cells[0]; j++) {
        for (int k=0; k<cells[1]; k++) {
          int idx0[] = {j+1,k+1};
          long linidx = gkyl_range_idx(&localRange, idx0);
          const double *phi_p = gkyl_array_cfetch(phi, linidx);
          for (int m=0; m<basis.num_basis; m++) {
            TEST_CHECK( gkyl_compare(sol[(j*cells[1]+k)*basis.num_basis+m], phi_p[m], 1e-10) );
            TEST_MSG("Expected: %.13e in cell (%d,%d)", sol[(j*cells[1]+k)*basis.num_basis+m], j, k);
            TEST_MSG("Produced: %.13e", phi_p[m]);
          }
        }
      }
    } else {
      TEST_CHECK( gkyl_compare(1., 2., 1e-10) );
      TEST_MSG("This BC combination is not available");
    }
  } else if (poly_order == 2) {
    if (bcs.lo_type[0] == GKYL_POISSON_PERIODIC && bcs.lo_type[1] == GKYL_POISSON_PERIODIC) {
      // Solution with N=8x8:
      const double sol[512] = {
        -2.1055183187473453e+01, -5.6960053628737226e+00, 3.8393108916532830e+00, -1.6199865671305258e+00, -5.0628141590584352e-01, 1.6107399622456251e+00,
        -4.8925064333966484e-01, 2.8533276751408687e-01, 5.1858175004515497e+00, -6.5507355610382758e+00, 8.6071381884585936e+00, 1.3050637591200724e+00,
        -1.9423809627420625e+00, -4.8361430357980550e-01, -3.3988181660932626e-01, 4.2364157446457607e-01, 1.9307135289495562e+01, 1.4237688169116351e+00,
        -1.7079115122656434e+00, 2.5311481566680722e+00, -2.0458214044106584e+00, -1.4547416014946468e+00, 2.8016044976686794e-01, -1.7114822825457343e-01,
        1.9294569151566443e-01, 6.4965350024656203e+00, -6.8633995246341426e+00, 1.8492573241138191e-02, -4.8046522865811059e-01, 4.5407487347050113e-01,
        6.2359835968150901e-01, -4.6481501607667941e-01, -9.9523675366444131e+00, 2.7718165640288226e+00, 2.0425310004928692e+00, -1.5705184304155917e+00,
        1.1715022813050320e+00, 1.2569681780583184e+00, 3.3016552688822687e-01, -1.2643505423602566e-03, 7.6579305454496573e+00, -5.0888069607267306e-01,
        5.5928842792949549e+00, 1.6486681682650925e-02, 1.6668374583201608e+00, -7.0422930106180925e-01, -4.4183629099451172e-02, 2.6216025043043689e-01,
        1.1700415434622263e+01, 1.5004199819332511e+00, -4.1739303798805034e+00, 6.5935684087803981e-01, 1.3806005390114717e+00, -1.4129665388092891e+00,
        -1.2107533331542997e-01, -1.1292018871715381e-01, -1.3036693737416885e+01, 5.6308125464531433e-01, -7.3366229431194112e+00, -1.3400430140438562e+00,
        7.5600873308001226e-01, 7.3376873117110675e-01, -2.3953291397273174e-01, -2.2098680881833371e-01, -2.3622486592410571e+01, 8.7552583778672481e+00,
        -6.5794472800424346e+00, -3.2001707637442136e+00, 3.0115387663363169e+00, 1.5213199948472833e+00, 4.3648184555345537e-01, -3.3695940976244687e-01,
        -2.3454873379319217e+01, -3.4914825460446455e+00, 5.8670018000693345e+00, -2.9552064655813575e+00, 3.0874566856601326e+00, 8.9450319136408574e-01,
        -3.9265061439553373e-01, 3.7201493221621273e-01, -4.6581210525804884e-01, -8.7010578192946273e+00, 4.8357086162180192e+00, -4.4645021121903543e-02,
        1.1599456712750884e+00, -1.0962337178653425e+00, -7.2019838862564134e-01, 3.7813285137455588e-01, 8.7046619753618626e-01, -6.7459576998612683e+00,
        -3.1873673791330877e+00, 6.3604115204390721e-01, -9.7666360081639436e-01, -4.1703591022715947e-01, -5.1337354976942640e-01, -3.8121029385150496e-02,
        -7.3850641317072405e+00, -5.8310695790223193e+00, 6.9760538789625404e-01, 9.6657661981126974e-03, -2.3463179009371360e+00, 1.3463881454566500e+00,
        -2.7739672910201180e-01, 5.2890992790714852e-02, 1.0611125333417913e+01, -3.5681337110662690e+00, 8.3330206676841900e+00, 1.6336560247786223e+00,
        -2.8119131812382241e+00, 2.9334041327753013e-01, 8.5851686867588969e-03, 3.1378689267879872e-01, 3.1473362829375780e+01, 5.7768690204496957e+00,
        1.0461332759281459e+00, 3.2351500186680004e+00, -1.8251665366742689e+00, -1.7714744224385899e+00, 5.6111327217419982e-01, -9.4064434402826969e-02,
        1.1973281848365051e+01, 1.3805573956972166e+01, -1.1012655088620420e+01, 6.8550928875883277e-01, 7.0112009639448569e-01, -7.7080769441445973e-01,
        8.9743899547819916e-01, -6.4768079550985869e-01, 1.9965893086268906e+01, 7.7637190920066006e+00, -7.9984011794568355e+00, 2.5942857510310846e+00,
        -3.6862323043438461e+00, 9.5566989841210148e-02, 6.0174080796833174e-01, -4.8619947147572762e-01, 4.6581210525840011e-01, 1.1818723885415153e+01,
        -1.9681206332353183e+00, 4.4645021121926781e-02, -1.1599456712750962e+00, 1.0962337178653341e+00, 8.5681145968406458e-01, -2.5554575843695271e-01,
        2.6185140955145840e+00, 1.1018194245823352e+01, 1.0559679997454556e+00, -2.7512043749361204e-01, 1.5754392195000968e+00, -5.7303427097814530e-01,
        7.2246374334222785e-01, -7.6063509874369384e-02, -5.8445752972248339e+00, 8.7552583778673423e+00, -6.5794472800425243e+00, -1.3682013534830941e+00,
        3.5827918626752542e+00, -1.0666942877560484e+00, 4.3648184555345626e-01, -3.3695940976244909e-01, -3.2809641132170270e+01, -7.0410283489569281e-01,
        -6.2016212882966819e+00, -3.9158361918338302e+00, 3.9617758087657560e+00, 1.0922766148004119e+00, -2.1767536225955730e-01, -1.9960235341928123e-01,
        -3.1473362829376207e+01, -1.4742912684260107e+01, 7.8499625253815193e+00, -3.2351500186680293e+00, 1.8251665366742769e+00, 1.7714744224385992e+00,
        -1.0158965761355097e+00, 5.3961417540868561e-01, 1.0225233950386722e+01, -1.8077810502934248e+01, 1.3144054468008058e+01, 1.5966708782963670e+00,
        -1.8509827239220087e+00, -6.1480933366348278e-01, -1.1065291890510007e+00, 7.6186533476937779e-01, 3.6852126021342571e+01, -5.8310695790223797e+00,
        6.9760538789632731e-01, 4.5587063510291861e+00, -4.2480127280744373e+00, -1.8010138525478823e+00, -2.7739672910201296e-01, 5.2890992790716518e-02,
        -1.9294569151607144e-01, -1.4023246702244311e+01, -5.9570275180648502e-02, -1.8492573241165825e-02, 4.8046522865812202e-01, -4.5407487347048825e-01,
        -9.5341148862819858e-01, 1.6886359373483151e-01, 1.5292239943095500e+00, -1.3085907974956481e+01, 3.1031222880583682e+00, 6.9917874640692146e-01,
        -2.6170745007495793e+00, 1.1332726811086977e+00, -8.3495390797089808e-01, 2.7693021383601302e-01, 2.4281244389184572e+01, -6.5507355610383557e+00,
        8.6071381884586700e+00, 3.2633083581072779e+00, -4.6519496662695241e+00, 2.8988596488549678e-02, -3.3988181660932693e-01, 4.2364157446457562e-01,
        4.1891542471279102e+01, 8.8136714289942564e+00, -9.7172290867058742e-01, 4.8503134702055455e+00, -4.1566144892544088e+00, -1.9322088826315809e+00,
        6.2586371439809296e-01, -1.6274567457648992e-01, 1.3036693737417270e+01, 2.1082862959355285e+01, -1.4140452192572930e+01, 1.3400430140438870e+00,
        -7.5600873308002603e-01, -7.3376873117112851e-01, 1.3374769343369795e+00, -8.5466541862984968e-01, -3.2536774718427473e+01, 1.6010096773801383e+01,
        -8.9849641802045159e+00, -3.8896837439530452e+00, 3.2822953661487722e+00, 1.7344354591952476e+00, 9.9403902442233716e-01, -5.6099863080773993e-01,
        -3.7124992435085780e+01, -5.0888069607260489e-01, 5.5928842792949158e+00, -4.5848587989099991e+00, 4.9274931706914282e+00, 1.1588550081530569e+00,
        -4.4183629099453725e-02, 2.6216025043044233e-01, -1.0883991747161211e+01, -1.1737860227839144e+01, 6.8535648008167245e+00, -1.6598084726594220e+00,
        3.4913936238552177e+00, -9.3549925767235820e-01, -7.8494883084953226e-01, 4.4681409154821727e-01, -1.0883991747161195e+01, 1.1737860227839370e+01,
        -6.8535648008169412e+00, -1.6598084726594260e+00, 3.4913936238552186e+00, -9.3549925767235553e-01, 7.8494883084954370e-01, -4.4681409154822904e-01,
        -3.7124992435086313e+01, 5.0888069607270747e-01, -5.5928842792949904e+00, -4.5848587989100480e+00, 4.9274931706914433e+00, 1.1588550081530800e+00,
        4.4183629099451505e-02, -2.6216025043044144e-01, -3.2536774718428056e+01, -1.6010096773801425e+01, 8.9849641802045515e+00, -3.8896837439530723e+00,
        3.2822953661487810e+00, 1.7344354591952582e+00, -9.9403902442234049e-01, 5.6099863080774659e-01, 1.3036693737416901e+01, -2.1082862959355367e+01,
        1.4140452192573010e+01, 1.3400430140438768e+00, -7.5600873308002070e-01, -7.3376873117111607e-01, -1.3374769343369779e+00, 8.5466541862984524e-01,
        4.1891542471279116e+01, -8.8136714289943683e+00, 9.7172290867070843e-01, 4.8503134702055508e+00, -4.1566144892544088e+00, -1.9322088826315902e+00,
        -6.2586371439809696e-01, 1.6274567457649522e-01, 2.4281244389184916e+01, 6.5507355610382714e+00, -8.6071381884585936e+00, 3.2633083581072806e+00,
        -4.6519496662695277e+00, 2.8988596488547458e-02, 3.3988181660932781e-01, -4.2364157446457673e-01, 1.5292239943101598e+00, 1.3085907974956429e+01,
        -3.1031222880583029e+00, 6.9917874640694755e-01, -2.6170745007495921e+00, 1.1332726811086875e+00, 8.3495390797089153e-01, -2.7693021383600680e-01,
        -1.9294569151546725e-01, 1.4023246702244418e+01, 5.9570275180559962e-02, -1.8492573241108392e-02, 4.8046522865810043e-01, -4.5407487347051267e-01,
        9.5341148862820035e-01, -1.6886359373483195e-01, 3.6852126021343210e+01, 5.8310695790224907e+00, -6.9760538789643034e-01, 4.5587063510292465e+00,
        -4.2480127280744560e+00, -1.8010138525479076e+00, 2.7739672910201563e-01, -5.2890992790721292e-02, 1.0225233950386755e+01, 1.8077810502934451e+01,
        -1.3144054468008258e+01, 1.5966708782963559e+00, -1.8509827239220089e+00, -6.1480933366347124e-01, 1.1065291890510089e+00, -7.6186533476938623e-01,
        -3.1473362829376690e+01, 1.4742912684260212e+01, -7.8499625253816108e+00, -3.2351500186680662e+00, 1.8251665366742946e+00, 1.7714744224386161e+00,
        1.0158965761355114e+00, -5.3961417540868917e-01, -3.2809641132170846e+01, 7.0410283489566261e-01, 6.2016212882967103e+00, -3.9158361918338600e+00,
        3.9617758087657693e+00, 1.0922766148004239e+00, 2.1767536225955242e-01, 1.9960235341928756e-01, -5.8445752972251830e+00, -8.7552583778674418e+00,
        6.5794472800426256e+00, -1.3682013534831063e+00, 3.5827918626752551e+00, -1.0666942877560404e+00, -4.3648184555345848e-01, 3.3695940976245353e-01,
        2.6185140955146124e+00, -1.1018194245823448e+01, -1.0559679997453570e+00, -2.7512043749360404e-01, 1.5754392195000948e+00, -5.7303427097815152e-01,
        -7.2246374334222718e-01, 7.6063509874368496e-02, 4.6581210525872974e-01, -1.1818723885415245e+01, 1.9681206332354051e+00, 4.4645021121922049e-02,
        -1.1599456712750968e+00, 1.0962337178653363e+00, -8.5681145968406436e-01, 2.5554575843695337e-01, 1.9965893086269553e+01, -7.7637190920066717e+00,
        7.9984011794569154e+00, 2.5942857510311130e+00, -3.6862323043438567e+00, 9.5566989841200378e-02, -6.0174080796833818e-01, 4.8619947147573656e-01,
        1.1973281848365744e+01, -1.3805573956972246e+01, 1.1012655088620505e+01, 6.8550928875886941e-01, 7.0112009639446882e-01, -7.7080769441447927e-01,
        -8.9743899547820727e-01, 6.4768079550986690e-01, 3.1473362829376391e+01, -5.7768690204495927e+00, -1.0461332759282804e+00, 3.2351500186680466e+00,
        -1.8251665366742902e+00, -1.7714744224386076e+00, -5.6111327217419404e-01, 9.4064434402818808e-02, 1.0611125333417949e+01, 3.5681337110664368e+00,
        -8.3330206676843588e+00, 1.6336560247786172e+00, -2.8119131812382241e+00, 2.9334041327753324e-01, -8.5851686867530752e-03, -3.1378689267880400e-01,
        -7.3850641317077024e+00, 5.8310695790224178e+00, -6.9760538789635351e-01, 9.6657661980786500e-03, -2.3463179009371222e+00, 1.3463881454566655e+00,
        2.7739672910201407e-01, -5.2890992790719071e-02, 8.7046619753558563e-01, 6.7459576998612381e+00, 3.1873673791331085e+00, 6.3604115204387313e-01,
        -9.7666360081638093e-01, -4.1703591022714370e-01, 5.1337354976942440e-01, 3.8121029385151051e-02, -4.6581210525837857e-01, 8.7010578192945207e+00,
        -4.8357086162179010e+00, -4.4645021121907096e-02, 1.1599456712750904e+00, -1.0962337178653403e+00, 7.2019838862563668e-01, -3.7813285137454988e-01,
        -2.3454873379319199e+01, 3.4914825460445620e+00, -5.8670018000692536e+00, -2.9552064655813530e+00, 3.0874566856601318e+00, 8.9450319136408307e-01,
        3.9265061439553617e-01, -3.7201493221621629e-01, -2.3622486592410262e+01, -8.7552583778673565e+00, 6.5794472800425332e+00, -3.2001707637442247e+00,
        3.0115387663363178e+00, 1.5213199948472917e+00, -4.3648184555345715e-01, 3.3695940976244865e-01, -1.3036693737416577e+01, -5.6308125464543024e-01,
        7.3366229431195347e+00, -1.3400430140438684e+00, 7.5600873308001537e-01, 7.3376873117111230e-01, 2.3953291397272691e-01, 2.2098680881833999e-01,
        1.1700415434622929e+01, -1.5004199819333131e+00, 4.1739303798805487e+00, 6.5935684087808211e-01, 1.3806005390114564e+00, -1.4129665388093109e+00,
        1.2107533331542447e-01, 1.1292018871715899e-01, 7.6579305454501920e+00, 5.0888069607277087e-01, -5.5928842792950695e+00, 1.6486681682687045e-02,
        1.6668374583201444e+00, -7.0422930106182391e-01, 4.4183629099455723e-02, -2.6216025043044228e-01, -9.9523675366444024e+00, -2.7718165640286627e+00,
        -2.0425310004930370e+00, -1.5705184304155926e+00, 1.1715022813050326e+00, 1.2569681780583182e+00, -3.3016552688822121e-01, 1.2643505423549639e-03,
        1.9294569151517549e-01, -6.4965350024655244e+00, 6.8633995246340387e+00, 1.8492573241105727e-02, -4.8046522865809577e-01, 4.5407487347051401e-01,
        -6.2359835968150668e-01, 4.6481501607667730e-01, 1.9307135289494944e+01, -1.4237688169116791e+00, 1.7079115122656794e+00, 2.5311481566680309e+00,
        -2.0458214044106442e+00, -1.4547416014946284e+00, -2.8016044976687038e-01, 1.7114822825457676e-01, 5.1858175004512272e+00, 6.5507355610381603e+00,
        -8.6071381884584799e+00, 1.3050637591200762e+00, -1.9423809627420634e+00, -4.8361430357980417e-01, 3.3988181660931938e-01, -4.2364157446456985e-01,
        -2.1055183187473450e+01, 5.6960053628736542e+00, -3.8393108916532168e+00, -1.6199865671305218e+00, -5.0628141590584441e-01, 1.6107399622456211e+00,
        4.8925064333967161e-01, -2.8533276751409536e-01,
      };
      for (int j=0; j<cells[0]; j++) {
        for (int k=0; k<cells[1]; k++) {
          int idx0[] = {j+1,k+1};
          long linidx = gkyl_range_idx(&localRange, idx0);
          const double *phi_p = gkyl_array_cfetch(phi, linidx);
          for (int m=0; m<basis.num_basis; m++) {
            TEST_CHECK( gkyl_compare(sol[(j*cells[1]+k)*basis.num_basis+m], phi_p[m], 1e-10) );
            TEST_MSG("Expected: %.13e in cell (%d,%d)", sol[(j*cells[1]+k)*basis.num_basis+m], j, k);
            TEST_MSG("Produced: %.13e", phi_p[m]);
          }
        }
      }
    } else if ((bcs.lo_type[0]==GKYL_POISSON_DIRICHLET && bcs.up_type[0]==GKYL_POISSON_DIRICHLET) &&
               (bcs.lo_type[1]==GKYL_POISSON_PERIODIC && bcs.up_type[1]==GKYL_POISSON_PERIODIC)) {
      // Solution with N=8x8:
      const double sol[512] = {
        7.5711738636379700e+00, 2.5568324740391297e+00, 5.1167331614558211e+00, 2.4727832928346594e+00, -1.4054179675134042e+00, 6.1419700713567691e+00,
        -3.7286293196278525e-01, 3.5460680740521866e+00, 2.0758894207673666e+01, 1.1267795520680716e+01, -1.0031441046941417e+01, -4.6769211349736635e+00,
        -5.5566283720313869e-01, -3.5626741185393747e+00, 8.6346928519268240e-01, -2.0569108613736473e+00, 1.3594715095713351e+01, 7.1655480313952662e+00,
        9.0698668172746899e+00, 4.1413820063944256e+00, -5.2933177934331999e-01, -1.1035880146021995e+00, -8.4826704184926838e-01, -6.3715683730558981e-01,
        1.0538674015081105e+01, 4.2560390203120635e+00, -2.7952876149664085e+00, -1.1798774654372435e+00, -1.4163246487905283e+00, 5.1233832560628052e+00,
        3.3616146990464424e-01, 2.9579867020494177e+00, 2.2024747870440134e+01, 1.2472953612918014e+01, -5.1167331614558895e+00, -2.4727832928346856e+00,
        -1.8825836094986273e-01, -6.1419700713565017e+00, 3.7286293196286846e-01, -3.5460680740524686e+00, 8.8370275264048548e+00, 3.7619905662762716e+00,
        1.0031441046941339e+01, 4.6769211349739148e+00, -1.0380134912601533e+00, 3.5626741185393436e+00, -8.6346928519278077e-01, 2.0569108613736105e+00,
        1.6001206638363609e+01, 7.8642380555622040e+00, -9.0698668172749777e+00, -4.1413820063947195e+00, -1.0643445491199175e+00, 1.1035880146025827e+00,
        8.4826704184939872e-01, 6.3715683730530448e-01, 1.9057247718996599e+01, 1.0773747066644622e+01, 2.7952876149668433e+00, 1.1798774654373116e+00,
        -1.7735167967268334e-01, -5.1233832560626400e+00, -3.3616146990475915e-01, -2.9579867020495270e+00, 1.0547053185519411e+01, 5.6121235077038900e-01,
        8.0357928214499879e+00, -4.5108902511093207e-01, -3.2104452298288144e-01, 1.3775209244937894e+01, -1.1230845198426297e-01, 8.6098461760367073e-01,
        4.3173120529816174e+01, 1.3313117726991164e+00, -1.5775484413258026e+01, 1.8666732294070940e-02, -8.2038303621019348e-01, -6.8107509670996524e+00,
        -1.7598477304427174e-01, 1.8163281850877949e-01, 3.4608182327383652e+01, 5.0049655083846334e+00, 1.4274111188784909e+01, 4.2469027913556817e-01,
        -4.9960076306725493e-01, -4.1433528573200746e+00, 3.6118850479460851e-01, -1.1178522129107362e+00, 1.4094766749853889e+01, -9.6046485001291515e-01,
        -4.4111572207434300e+00, -6.1926948485557964e-01, -4.5391689108755867e-01, 1.2670336771618857e+01, -3.3481290900950705e-01, 1.3992489417184601e+00,
        5.1670055472623496e+01, 3.8022739325395261e+00, -8.0357928214498031e+00, 4.5108902511095250e-01, -8.3930591556586931e-01, -1.3775209244937987e+01,
        1.1230845198422829e-01, -8.6098461760359934e-01, 1.9043988128327072e+01, 3.0321745106108899e+00, 1.5775484413258118e+01, -1.8666732294083995e-02,
        -3.3996740233860129e-01, 6.8107509670996196e+00, 1.7598477304428253e-01, -1.8163281850874280e-01, 2.7608926330759374e+01, -6.4147922507440869e-01,
        -1.4274111188785204e+01, -4.2469027913545798e-01, -6.6074967548153596e-01, 4.1433528573199894e+00, -3.6118850479461617e-01, 1.1178522129107504e+00,
        4.8122341908288419e+01, 5.3239511333231038e+00, 4.4111572207434486e+00, 6.1926948485546185e-01, -7.0643354746118825e-01, -1.2670336771618837e+01,
        3.3481290900953997e-01, -1.3992489417184355e+00, 1.2834086265285496e+01, 6.6660597862113313e-01, 5.4592934411306917e+00, -5.3613267888178739e-01,
        -3.9277282123210222e-01, 1.3651686305630548e+01, 2.7523845597608154e-01, -9.3230061986385970e-01, 3.8079683584953059e+01, -3.4752185565637603e+00,
        -1.5203332332988003e+01, 3.2483479157023204e-01, -2.0319184059141193e-01, -5.1861881128342349e+00, -1.6578382576994696e-01, 7.5630898271682545e-01,
        4.2060635144023266e+01, -7.8152890802934238e-01, 1.6041465337446521e+01, 7.6746911112531901e-02, -5.6097905910266699e-01, -6.3173087394422609e+00,
        -4.0784721150132874e-02, -1.3728180083887725e-01, 1.1185122138368454e+01, -4.4915680662569779e-01, -7.4827255075668804e+00, -4.3337131413575919e-01,
        -2.4457250288101104e-01, 1.4120211809851538e+01, 2.2346213155806885e-01, -5.6216319810350202e-01, 5.0868739817121380e+01, -3.6128915887194353e+00,
        -5.4592934411306455e+00, 5.3613267888173377e-01, -3.3425172740217313e-01, -1.3651686305630527e+01, -2.7523845597607949e-01, 9.3230061986385515e-01,
        2.5623142497454019e+01, 5.2893294646533351e-01, 1.5203332332988076e+01, -3.2483479157024980e-01, -5.2383270804286930e-01, 5.1861881128342597e+00,
        1.6578382576994177e-01, -7.5630898271682989e-01, 2.1642190938384100e+01, -2.1647567020690461e+00, -1.6041465337446517e+01, -7.6746911112476141e-02,
        -1.6604548953164397e-01, 6.3173087394422121e+00, 4.0784721150120259e-02, 1.3728180083888500e-01, 5.2517703944038566e+01, -2.4971288034724965e+00,
        7.4827255075667578e+00, 4.3337131413577545e-01, -4.8245204575329603e-01, -1.4120211809851520e+01, -2.2346213155805197e-01, 5.6216319810347881e-01,
        1.1389883870962576e+01, -1.3868221174744275e+00, 4.4760604474563914e+00, -4.1951753830011562e-01, -3.0478289812702114e-01, 9.5116421105830735e+00,
        -2.5289856897649846e-02, -1.4579550106037478e+00, 2.4658979651651553e+01, -4.0728807035622605e+00, -1.2842002664550789e+01, 1.4765469333527865e+00,
        -4.8003126436937500e-02, -2.9027088989601997e+00, 1.7354172720537125e-01, 5.6205835610226373e-01, 3.1718420671373405e+01, -4.6314885092856359e+00,
        1.3685273888782918e+01, -1.6686351603278100e+00, -1.2870540135553579e-01, -5.4065918180524992e+00, -2.2013520735383832e-01, 6.6308446055880155e-01,
        8.4657676578212353e+00, -1.1554391882963218e+00, -6.5118972737563556e+00, 8.8325954103543369e-01, -2.7135492134138733e-01, 1.0548784374265418e+01,
        1.3777646859023468e-01, -1.4998013932233591e+00, 3.4290543891020292e+01, -5.5127074757936700e+00, -4.4760604474564500e+00, 4.1951753830011534e-01,
        1.1084239407202070e-02, -9.5116421105830771e+00, 2.5289856897656619e-02, 1.4579550106037384e+00, 2.1021448110331136e+01, -2.8266488897059010e+00,
        1.2842002664550764e+01, -1.4765469333528143e+00, -2.4569553228286417e-01, 2.9027088989602130e+00, -1.7354172720536756e-01, -5.6205835610226673e-01,
        1.3962007090609443e+01, -2.2680410839826166e+00, -1.3685273888782840e+01, 1.6686351603278042e+00, -1.6499325736427489e-01, 5.4065918180524877e+00,
        2.2013520735383085e-01, -6.6308446055878967e-01, 3.7214660104161752e+01, -5.7440904049718569e+00, 6.5118972737563618e+00, -8.8325954103540005e-01,
        -2.2343737378438464e-02, -1.0548784374265438e+01, -1.3777646859023721e-01, 1.4998013932233598e+00, 5.2864798717669776e+00, -1.5541361622449834e+00,
        1.9459080267195821e+00, -1.0078353910637479e+00, 1.4668586129324565e-01, 4.0836858666066682e+00, 6.0587942565820945e-04, -1.6758769880055386e+00,
        9.0769379769636984e+00, -4.8410921221688952e+00, -5.8399824469108212e+00, 2.2436644081508579e+00, 1.5764095609959970e-02, -6.2779560686890912e-01,
        -7.6193596085684684e-02, 7.5136344546970124e-01, 1.5638698717011067e+01, -4.3964175120957218e+00, 6.3130743537226452e+00, -2.1651852443570010e+00,
        6.9378934107321086e-02, -3.1958488049744180e+00, 1.0714813752469497e-01, 6.1328861315091376e-01, 2.5685095801924365e+00, -1.7383264165802581e+00,
        -3.0880529243934101e+00, 8.1836992946892340e-01, 1.2447786804319297e-01, 5.1474083301575693e+00, -7.5336753184758354e-02, -1.6186845198367033e+00,
        1.4490787580215658e+01, -5.9421095039544918e+00, -1.9459080267195892e+00, 1.0078353910637696e+00, -7.0586300985872683e-03, -4.0836858666066851e+00,
        -6.0587942565855347e-04, 1.6758769880055411e+00, 1.0700329475018780e+01, -2.6551535440305218e+00, 5.8399824469107600e+00, -2.2436644081508517e+00,
        1.2386313558470298e-01, 6.2779560686891089e-01, 7.6193596085687210e-02, -7.5136344546970324e-01, 4.1385687349712983e+00, -3.0998281541037285e+00,
        -6.3130743537226417e+00, 2.1651852443569783e+00, 7.0248297087352390e-02, 3.1958488049744251e+00, -1.0714813752469037e-01, -6.1328861315091387e-01,
        1.7208757871790073e+01, -5.7579192496192562e+00, 3.0880529243934753e+00, -8.1836992946892850e-01, 1.5149363151478083e-02, -5.1474083301575719e+00,
        7.5336753184751998e-02, 1.6186845198367106e+00, 2.0851644586908202e+00, -1.5289639520143722e-01, -1.0190853525359438e+00, -4.4200250843767624e-01,
        2.5609590421969947e-01, -1.3111543673389618e+00, 2.0355162130222118e-01, -1.4388354732979942e+00, -5.2199298577201665e+00, -2.9026745735353474e+00,
        3.8255692666894958e-01, 1.3001259421911353e+00, 4.1122187447099579e-01, 1.4627303288154059e+00, -1.1398960061933343e-01, 4.5560226624553257e-01,
        1.2352101112731999e+00, -3.8277001636926316e+00, 4.7806815846104928e-01, -1.3966532318021432e+00, 1.4044070210636231e-01, -7.5745870176624008e-01,
        -4.2345982136870186e-02, 7.9451656932564751e-01, -5.8864206348251669e-01, 2.3026174978385772e-01, -1.0586474001031971e+00, 6.7504000015566690e-01,
        3.6825713824841150e-01, -3.9152195984007238e-01, 1.7387586286930351e-01, -1.5792183741160062e+00, -4.4644655511723803e+00, -4.5835374336907790e+00,
        1.0190853525359791e+00, 4.4200250843767314e-01, 3.1685721688944901e-01, 1.3111543673389592e+00, -2.0355162130222612e-01, 1.4388354732980002e+00,
        2.8406287652386411e+00, -1.8337592553568307e+00, -3.8255692666896990e-01, -1.3001259421911211e+00, 1.6173124663814459e-01, -1.4627303288154128e+00,
        1.1398960061933365e-01, -4.5560226624553479e-01, -3.6145112037548346e+00, -9.0873366519952370e-01, -4.7806815846107620e-01, 1.3966532318021447e+00,
        4.3251241900278042e-01, 7.5745870176624530e-01, 4.2345982136871282e-02, -7.9451656932564774e-01, -1.7906590289991435e+00, -4.9666955786760303e+00,
        1.0586474001032093e+00, -6.7504000015567955e-01, 2.0469598286073923e-01, 3.9152195984007748e-01, -1.7387586286929990e-01, 1.5792183741160046e+00,
        1.9980167436569440e+00, 2.6279956734987525e-01, -9.1824150266946936e-01, 7.6348475138740574e-02, 3.8020017828485891e-01, -4.0973051386771191e+00,
        -1.2478151566869267e-01, -1.6974942453697403e-01, -7.0245946979708958e+00, 2.0099206798419127e+00, 3.1949717001217537e+00, 7.4112012303711705e-01,
        5.2676833384458188e-01, 1.7012769926403721e+00, 2.0940267973572577e-01, -3.1787728567190099e-01, -7.7041224392599732e+00, -7.4960990094331026e-01,
        -3.6001308070409044e+00, -1.1244506044854634e+00, 5.9266262324759322e-01, 1.6913361423317976e+00, -1.7135859401083814e-01, 6.1929579310452265e-01,
        2.2794863501078102e+00, 1.4058345596943498e+00, 1.8963821135127572e+00, 8.4909317204483359e-01, 3.5290586993119349e-01, -4.0931875036577843e+00,
        3.2934967943583970e-02, -5.5793922405711172e-01, -1.1159940859954022e+01, 1.1171063513037944e+00, 9.1824150266947813e-01, -7.6348475138740976e-02,
        6.2607883273876874e-01, 4.0973051386771173e+00, 1.2478151566869694e-01, 1.6974942453696854e-01, -2.1373294183261322e+00, -6.3001476118826361e-01,
        -3.1949717001217364e+00, -7.4112012303711539e-01, 4.7951067717904555e-01, -1.7012769926403750e+00, -2.0940267973573007e-01, 3.1787728567190571e-01,
        -1.4578016770370641e+00, 2.1295158195969872e+00, 3.6001308070408862e+00, 1.1244506044854694e+00, 4.1361638777603105e-01, -1.6913361423317970e+00,
        1.7135859401084064e-01, -6.1929579310452432e-01, -1.1441410466404900e+01, -2.5928641040681811e-02, -1.8963821135127661e+00, -8.4909317204484103e-01,
        6.5337314109243083e-01, 4.0931875036577887e+00, -3.2934967943586656e-02, 5.5793922405711294e-01, 7.5087282814798053e+00, 3.8201328875905691e+00,
        -7.4192744296018398e-01, 3.0744537382085513e-01, 1.0783609380268158e+00, -2.1956598832653493e+00, 9.3653876830995159e-02, 1.2676648246521331e+00,
        5.9367957061953227e+00, 5.4565665660586538e+00, 3.4117284350768085e+00, -1.4280377956224548e+00, 5.1377448012734850e-01, 5.7534869164227787e-01,
        -4.1961802028007000e-01, -3.3217772199756690e-01, 2.9704312624447171e+00, 6.9899600377174531e+00, -4.0829851810593842e+00, 1.7121050443297883e+00,
        6.5261151279673846e-01, 1.3819939604512403e+00, 4.9977561846523150e-01, -7.9789458508496924e-01, 8.7374366650226367e+00, 3.1849805151751132e+00,
        2.3624845829457257e+00, -9.9324437827614753e-01, 1.0208527561355243e+00, -2.5297832936301354e+00, -2.8717143749686075e-01, 1.4605710655687689e+00,
        3.5480238541686964e+00, 7.0326406888475326e+00, 7.4192744296022595e-01, -3.0744537382083909e-01, 3.6124396291129257e-01, 2.1956598832653560e+00,
        -9.3653876830993660e-02, -1.2676648246521234e+00, 5.1199564294532207e+00, 5.3962070103794693e+00, -3.4117284350768302e+00, 1.4280377956224359e+00,
        9.2583042081076283e-01, -5.7534869164227420e-01, 4.1961802028007011e-01, 3.3217772199756546e-01, 8.0863208732038245e+00, 3.8628135387206504e+00,
        4.0829851810593940e+00, -1.7121050443297823e+00, 7.8699338814137187e-01, -1.3819939604512455e+00, -4.9977561846523177e-01, 7.9789458508496636e-01,
        2.3193154706258663e+00, 7.6677930612630050e+00, -2.3624845829457559e+00, 9.9324437827614442e-01, 4.1875214480258355e-01, 2.5297832936301310e+00,
        2.8717143749685969e-01, -1.4605710655687754e+00,        
      };
      for (int j=0; j<cells[0]; j++) {
        for (int k=0; k<cells[1]; k++) {
          int idx0[] = {j+1,k+1};
          long linidx = gkyl_range_idx(&localRange, idx0);
          const double *phi_p = gkyl_array_cfetch(phi, linidx);
          for (int m=0; m<basis.num_basis; m++) {
            TEST_CHECK( gkyl_compare(sol[(j*cells[1]+k)*basis.num_basis+m], phi_p[m], 1e-10) );
            TEST_MSG("Expected: %.13e in cell (%d,%d)", sol[(j*cells[1]+k)*basis.num_basis+m], j, k);
            TEST_MSG("Produced: %.13e", phi_p[m]);
          }
        }
      }
    } else if ((bcs.lo_type[0]==GKYL_POISSON_PERIODIC && bcs.up_type[0]==GKYL_POISSON_PERIODIC) &&
               (bcs.lo_type[1]==GKYL_POISSON_DIRICHLET && bcs.up_type[1]==GKYL_POISSON_DIRICHLET)) {
      // Solution with N=8x8:
      const double sol[512] = {
        7.2565136902344483e+00, 4.8231040378017838e+00, 2.4660327201331449e+00, 2.2399474225899145e+00, 6.1343565305018393e+00, -1.3350308469482448e+00,
        3.5416723941906159e+00, -4.2190188540145057e-01, 1.1949813331139318e+01, 6.9702547633583389e+00, 1.5068482148949991e+00, -2.4695883553587722e-01,
        1.3436531385394451e+01, -3.5655791455018548e-01, 6.7424022395134853e-01, 1.6162543991040532e-01, 1.4716264229951848e+01, 6.6338750059206353e+00,
        -1.8320658369255069e-01, -7.0972051070675959e-02, 1.3403839983501085e+01, -5.6846396898344476e-01, -6.9311461363466975e-01, 6.5790834873097587e-02,
        1.0549934521247797e+01, 5.3526143020031389e+00, -1.6852857041035738e+00, -7.7274514171037867e-01, 9.7561428635705152e+00, -1.5255258254589169e-01,
        -1.4128843004794656e+00, -1.4752486265131429e-02, 4.5889680258859959e+00, 2.1817893301442188e+00, -1.4933184581198531e+00, -9.7285807268042979e-01,
        4.3495411425699286e+00, 5.1136479604261972e-02, -1.7086186585413166e+00, 5.1145114416602425e-02, 7.6872761317398586e-01, -8.8753538357070305e-01,
        -3.3212657227395292e-01, -6.9330142199440248e-01, -1.0482760888626736e+00, 3.4561628982098297e-01, -1.4078125730626960e+00, 1.3318726039373399e-01,
        1.5370523987374454e+00, -1.6273654716803474e+00, 8.0187784881376467e-01, 1.2612521825998468e-01, -4.0200641079134964e+00, 3.6587877413708753e-01,
        -3.0795003971080093e-01, 2.4716535870589681e-02, 7.7578733640628128e+00, -8.4543282675032450e-01, 3.6929071177981427e+00, 3.9076288214178517e-01,
        -2.2767246114428010e+00, 1.0654885273666856e+00, 1.3144675672870636e+00, 7.5405427234410613e-02, 2.0268549938791278e+01, -9.4969060696722671e+00,
        1.0888323728929288e+01, -4.4131017188939587e+00, -3.3051144715720029e+00, -6.3031179964622264e-01, -1.9082087298650074e+00, 8.2877161706433056e-01,
        4.0767021158311643e+01, -1.5658193196918768e+01, 9.1291966939315738e-01, -6.4613295094788326e-01, -6.1805639124758018e+00, -6.5630298673172449e-01,
        2.4806722111804072e-01, -3.3468333802268019e-01, 3.7758585266463847e+01, -1.7342738885110744e+01, -2.0416669776853111e+00, 3.0635683668654923e-01,
        -5.1960495480828603e+00, -1.8521346012573825e-01, 3.2034241218527731e-01, 1.5547894958296166e-01, 2.6668131237388220e+01, -1.3172813714297360e+01,
        -4.3163372608041159e+00, 1.9211520705163905e+00, -3.5096342603975730e+00, -1.5030054421297667e-01, 6.5330990812532364e-01, 1.6052701202864460e-02,
        1.0437380332720705e+01, -5.9052182837064375e+00, -4.7197787440845147e+00, 2.2311481016558434e+00, -1.1501040187224223e+00, 1.0896656526118718e-01,
        7.0896551206688718e-01, -1.7756898895317105e-02, -3.7255517594536443e+00, 1.0076669738259358e+00, -3.1947882140381423e+00, 1.5860998166900273e+00,
        1.0546802782338107e+00, 3.1222514477371105e-01, 5.6396729528585388e-01, -1.5246564697532630e-01, -7.1988691712637394e+00, 3.9804950282612692e+00,
        1.5774257623995511e+00, 4.7918342366710176e-01, 1.7094851042336434e+00, 6.1273634482641992e-01, -1.8591555272818444e-01, 1.1780674901839330e-01,
        5.5715694778914706e+00, 3.4180165071055630e+00, 5.6676306193408292e+00, -1.4647055793739878e+00, 6.9373496049558103e-01, 5.1361910218894236e-01,
        -4.0052806618838704e-01, -3.9402738841830454e-01, 1.4602826784400772e+01, 8.6075493265117853e+00, 7.7930019397339709e+00, 4.0011208804020413e+00,
        -1.4602188196092223e+00, -4.9414932480429263e-01, -8.4305772857675976e-01, -7.5015817556081665e-01, 3.6608160545361521e+01, 1.5173774417982225e+01,
        4.6510254311452552e+00, 1.1607288178625641e+00, -4.6958940772574875e+00, -6.9613160278726083e-01, -1.0250602524366783e+00, 3.1168827582156533e-01,
        4.0632558776218822e+01, 1.7892461534098196e+01, -1.9590644309267153e+00, -3.6228194229717742e-01, -6.0555162418397277e+00, -4.1071318083536745e-01,
        2.4008202971894158e-01, -2.8567127403685122e-01, 2.9717000599675977e+01, 1.3276557507370477e+01, -3.9887253575562287e+00, -1.9441741717949959e+00,
        -4.7927704935470272e+00, -1.3626532132207336e-01, 4.8896456797590365e-01, -7.9494614886657690e-03, 1.4412254532553726e+01, 6.1694504554472314e+00,
        -4.6287982408052128e+00, -2.1824618323441993e+00, -2.7230484411529030e+00, 3.3120119168853060e-02, 7.0599001612154855e-01, -2.6033067173168618e-02,
        4.3827718290769346e-01, -5.3752091716913175e-01, -3.2353589144670192e+00, -1.5497824500461481e+00, -4.4326706458301257e-01, 1.9092283427357970e-01,
        6.1024237533457426e-01, 8.2431725354751781e-02, -6.9966967706349799e+00, -4.0019045822453716e+00, -6.7704800450272062e-01, -8.0379291487445303e-01,
        1.6024870888315665e+00, 4.8540690033464212e-01, 5.7087433583512792e-01, -1.9132043807148655e-01, 3.2377940652632744e+00, -3.9883724740136244e+00,
        6.8186961608289733e+00, 1.6806436130924369e+00, 1.2956352216174452e+00, 6.6570366104462586e-01, -7.4803534397254068e-01, 4.8183344941321854e-01,
        9.6033330614339949e+00, -2.6760069266761515e+00, 3.7481569851264216e+00, -1.2453376948648369e+00, 5.3701757302955393e+00, -1.3914311907140546e+00,
        3.1004724034819504e+00, 2.3211224873884562e-01, 1.3672469801041744e+01, -5.8007643773818742e+00, -4.1525889207611438e-02, -9.9538548551070161e-01,
        1.2821561004000882e+01, -3.4006036160939240e-01, 1.2015868901274416e+00, -1.0611044887684108e-01, 1.3525825424309970e+01, -7.9610228806500452e+00,
        -2.1742167884647040e-01, 2.0598719951303407e-01, 1.3759842744463120e+01, -4.7505892635419916e-01, -6.5986967469585844e-01, 2.4852124054034622e-01,
        9.2870514814841503e+00, -5.6030739742524212e+00, -1.8209869976236110e+00, 8.2832541085158895e-01, 1.0287635293713352e+01, -1.5836616221819666e-01,
        -1.3448102316767432e+00, -4.8104649520278034e-03, 2.9425212235886828e+00, -2.8197022227758892e+00, -1.5310038164894428e+00, 8.5531902100701973e-01,
        5.0010760551997526e+00, 8.2553106233491144e-02, -1.7073861677659867e+00, 5.4573215561784238e-02, -9.5598680615284481e-01, -2.4749760270591306e-01,
        -3.1532163792134243e-01, 6.0562354289307252e-01, -4.2780598374722406e-01, 3.9586135197729472e-01, -1.4269803388187741e+00, 3.5889583008811080e-02,
        1.4533098484599591e+00, 1.6790527072733459e+00, 1.7357114590788620e+00, 6.5755141788770677e-01, -3.9757440787869918e+00, 4.1862035693500366e-01,
        -6.2142267542056351e-01, 1.5276120926146078e-01, 8.7245547915061294e+00, 2.2223939374401298e+00, 3.2161201593333195e+00, -9.1208341177703689e-01,
        -2.5260398627953622e+00, 1.0024930404611774e+00, 1.4584097947686661e+00, -2.8738801054686564e-01, 2.2339408043844461e+01, -4.8231040378014391e+00,
        1.2563753366823573e+01, -2.2399474225897751e+00, -6.1343565305019432e+00, -2.5864548151508043e-01, -3.5416723941905062e+00, 4.2190188540134388e-01,
        5.0267295327003161e+01, -6.9702547633581187e+00, 2.8566380684147634e+00, 2.4695883553579936e-01, -1.3436531385394398e+01, -8.0379252399852275e-01,
        -6.7424022395136907e-01, -1.6162543991040920e-01, 4.8986561852454606e+01, -6.6338750059207348e+00, -2.7630790264056375e+00, 7.0972051070600173e-02,
        -1.3403839983501079e+01, -1.5856057965081735e-01, 6.9311461363466331e-01, -6.5790834873076742e-02, 3.5130493240734950e+01, -5.3526143020032064e+00,
        -5.2142438891645240e+00, 7.7274514171045117e-01, -9.7561428635705383e+00, -1.4114607617396283e-01, 1.4128843004794569e+00, 1.4752486265134764e-02,
        1.5188299426096288e+01, -2.1817893301441087e+00, -6.0029272080797043e+00, 9.7285807268043278e-01, -4.3495411425699322e+00, 8.8490751590401054e-02,
        1.7086186585413363e+00, -5.1145114416619598e-02, -3.1480287056559360e+00, 8.8753538357069084e-01, -4.4043072566181865e+00, 6.9330142199436606e-01,
        1.0482760888626790e+00, 2.2733683128818291e-01, 1.4078125730626825e+00, -1.3318726039372250e-01, -1.0698976515034619e+01, 1.6273654716803183e+00,
        5.7802806983996791e-01, -1.2612521825998788e-01, 4.0200641079135284e+00, 6.4040023688653513e-01, 3.0795003971083024e-01, -2.4716535870601318e-02,
        3.2988787715858732e+00, 8.4543282675016818e-01, 7.1598664586400513e+00, -3.9076288214185306e-01, 2.2767246114427619e+00, 3.7411637357141198e-01,
        -1.3144675672871342e+00, -7.5405427234420203e-02, 9.3273717952862238e+00, 9.4969060696714962e+00, 4.1414623580284928e+00, 4.4131017188939197e+00,
        3.3051144715721992e+00, -9.6336452881698631e-01, 1.9082087298647199e+00, -8.2877161706415614e-01, 2.1450087499831831e+01, 1.5658193196918884e+01,
        3.4505666139165925e+00, 6.4613295094810441e-01, 6.1805639124756686e+00, -5.0404745181712973e-01, -2.4806722111794385e-01, 3.3468333802259947e-01,
        2.5944240815942624e+01, 1.7342738885110894e+01, -9.0461863241320528e-01, -3.0635683668665153e-01, 5.1960495480828959e+00, -5.4181108850849746e-01,
        -3.2034241218527509e-01, -1.5547894958296579e-01, 1.9012296524594099e+01, 1.3172813714297234e+01, -2.5831923324638790e+00, -1.9211520705164102e+00,
        3.5096342603975881e+00, -1.4339811450682732e-01, -6.5330990812533796e-01, -1.6052701202840355e-02, 9.3398871192617534e+00, 5.9052182837064073e+00,
        -2.7764669221148899e+00, -2.2311481016557915e+00, 1.1501040187224039e+00, 3.0660665933457315e-02, -7.0896551206689318e-01, 1.7756898895323451e-02,
        1.3462506669718795e+00, -1.0076669738258186e+00, -1.5416456148541455e+00, -1.5860998166900340e+00, -1.0546802782338074e+00, 2.6072797633543321e-01,
        -5.6396729528583400e-01, 1.5246564697530224e-01, -1.9630549450335482e+00, -3.9804950282613318e+00, -1.9751984374577769e-01, -4.7918342366713162e-01,
        -1.7094851042336310e+00, 3.9354266619723177e-01, 1.8591555272816998e-01, -1.1780674901836495e-01, 5.4851826577571474e+00, -3.4180165071054893e+00,
        5.1851429570973018e+00, 1.4647055793740646e+00, -6.9373496049565408e-01, 9.2598579874914499e-01, 4.0052806618835141e-01, 3.9402738841830831e-01,
        1.4993094949676593e+01, -8.6075493265116485e+00, 7.2367841472226750e+00, -4.0011208804019649e+00, 1.4602188196089905e+00, -1.0995270036588776e+00,
        8.4305772857700834e-01, 7.5015817556066489e-01, 2.5608948112781171e+01, -1.5173774417982559e+01, -2.8753914783475915e-01, -1.1607288178625927e+00,
        4.6958940772575373e+00, -4.6421883576156686e-01, 1.0250602524365906e+00, -3.1168827582146935e-01, 2.3070267306188306e+01, -1.7892461534098082e+01,
        -9.8722117917186647e-01, 3.6228194229727734e-01, 6.0555162418396753e+00, -3.1631136779895441e-01, -2.4008202971891188e-01, 2.8567127403680437e-01,
        1.5963427162306223e+01, -1.3276557507370432e+01, -2.9108042357119785e+00, 1.9441741717949204e+00, 4.7927704935470388e+00, -1.5743333739768528e-01,
        -4.8896456797589682e-01, 7.9494614886675818e-03, 5.3650129194284357e+00, -6.1694504554473397e+00, -2.8674474253941060e+00, 2.1824618323441931e+00,
        2.7230484411529106e+00, 1.0650711202581434e-01, -7.0599001612155710e-01, 2.6033067173175637e-02, -2.8175782753892253e+00, 5.3752091716910833e-01,
        -1.5010749144251061e+00, 1.5497824500462098e+00, 4.4326706458298470e-01, 3.8203028683554430e-01, -6.1024237533458470e-01, -8.2431725354739485e-02,
        -2.1652273456622262e+00, 4.0019045822455137e+00, 2.0569539231562413e+00, 8.0379291487441784e-01, -1.6024870888315290e+00, 5.2087211068898720e-01,
        -5.7087433583507952e-01, 1.9132043807144530e-01, 7.8189580703851567e+00, 3.9883724740134583e+00, 4.0340774156093291e+00, -1.6806436130925051e+00,
        -1.2956352216175056e+00, 7.7390123989349768e-01, 7.4803534397243487e-01, -4.8183344941320183e-01, 1.9992588672643731e+01, 2.6760069266764401e+00,
        1.1281629101830370e+01, 1.2453376948646588e+00, -5.3701757302956015e+00, -2.0224513774923147e-01, -3.1004724034818452e+00, -2.3211224873876074e-01,
        4.8544638857100331e+01, 5.8007643773818707e+00, 4.4050121725177291e+00, 9.9538548551058659e-01, -1.2821561004000813e+01, -8.2029007693928679e-01,
        -1.2015868901274718e+00, 1.0611044887682913e-01, 5.0177000658096993e+01, 7.9610228806498817e+00, -2.7288639312516918e+00, -2.0598719951295591e-01,
        -1.3759842744463137e+01, -2.5196562228015207e-01, 6.5986967469583846e-01, -2.4852124054031519e-01, 3.6393376280498451e+01, 5.6030739742525686e+00,
        -5.0785425956447172e+00, -8.2832541085156619e-01, -1.0287635293713372e+01, -1.3533249650161161e-01, 1.3448102316767636e+00, 4.8104649519981908e-03,
        1.6834746228393318e+01, 2.8197022227759163e+00, -5.9652418497099902e+00, -8.5531902100706858e-01, -5.0010760551997357e+00, 5.7074124961195356e-02,
        1.7073861677659865e+00, -5.4573215561780575e-02, -1.4233142863289567e+00, 2.4749760270583140e-01, -4.4211121909707272e+00, -6.0562354289309139e-01,
        4.2780598374723527e-01, 1.7709176913185090e-01, 1.4269803388187716e+00, -3.5889583008810913e-02, -1.0615233964756841e+01, -1.6790527072733965e+00,
        -3.5580554042511986e-01, -6.5755141788763871e-01, 3.9757440787869553e+00, 5.8765865408859663e-01, 6.2142267542053842e-01, -1.5276120926143633e-01,
        2.3321973441423172e+00, -2.2223939374398811e+00, 7.6366534171046352e+00, 9.1208341177709618e-01, 2.5260398627953577e+00, 4.3711186047695644e-01,
        -1.4584097947686228e+00, 2.8738801054685470e-01,
      };
      for (int j=0; j<cells[0]; j++) {
        for (int k=0; k<cells[1]; k++) {
          int idx0[] = {j+1,k+1};
          long linidx = gkyl_range_idx(&localRange, idx0);
          const double *phi_p = gkyl_array_cfetch(phi, linidx);
          for (int m=0; m<basis.num_basis; m++) {
            TEST_CHECK( gkyl_compare(sol[(j*cells[1]+k)*basis.num_basis+m], phi_p[m], 1e-10) );
            TEST_MSG("Expected: %.13e in cell (%d,%d)", sol[(j*cells[1]+k)*basis.num_basis+m], j, k);
            TEST_MSG("Produced: %.13e", phi_p[m]);
          }
        }
      }
    } else {
      TEST_CHECK( gkyl_compare(1., 2., 1e-10) );
      TEST_MSG("This BC combination is not available");
    }
  } else {
    TEST_CHECK( gkyl_compare(1., 2., 1e-10) );
    TEST_MSG("This poly_order is not available");
  }

  gkyl_fem_poisson_release(poisson);
  gkyl_proj_on_basis_release(projob);
  gkyl_array_release(rho);
  gkyl_array_release(eps);
  gkyl_array_release(phi);
  if (use_gpu) {
    gkyl_array_release(rho_cu);
    gkyl_array_release(phi_cu);
  }
}

void test_2x_p1_periodicx_periodicy() {
  int cells[] = {8,8};
  struct gkyl_poisson_bc bc_tv;
  bc_tv.lo_type[0] = GKYL_POISSON_PERIODIC;
  bc_tv.up_type[0] = GKYL_POISSON_PERIODIC;
  bc_tv.lo_type[1] = GKYL_POISSON_PERIODIC;
  bc_tv.up_type[1] = GKYL_POISSON_PERIODIC;
  test_2x(1, &cells[0], bc_tv, false);
}

void test_2x_p1_dirichletx_periodicy() {
  int cells[] = {8,8};
  struct gkyl_poisson_bc bc_tv;
  bc_tv.lo_type[0] = GKYL_POISSON_DIRICHLET;
  bc_tv.up_type[0] = GKYL_POISSON_DIRICHLET;
  bc_tv.lo_type[1] = GKYL_POISSON_PERIODIC;
  bc_tv.up_type[1] = GKYL_POISSON_PERIODIC;
  bc_tv.lo_value[0].v[0] = 0.;
  bc_tv.up_value[0].v[0] = 4.*pow(M_PI,3)/15.;
  test_2x(1, &cells[0], bc_tv, false);
}

void test_2x_p1_periodicx_dirichlety() {
  int cells[] = {8,8};
  struct gkyl_poisson_bc bc_tv;
  bc_tv.lo_type[0] = GKYL_POISSON_PERIODIC;
  bc_tv.up_type[0] = GKYL_POISSON_PERIODIC;
  bc_tv.lo_type[1] = GKYL_POISSON_DIRICHLET;
  bc_tv.up_type[1] = GKYL_POISSON_DIRICHLET;
  bc_tv.lo_value[1].v[0] = 0.;
  bc_tv.up_value[1].v[0] = 4.*pow(M_PI,3)/15.;
  test_2x(1, &cells[0], bc_tv, false);
}
//// MF 2023/05/08: Currently not working.
//void test_2x_p1_dirichletx_neumanny_dirichlety() {
//  int cells[] = {16,16};
//  struct gkyl_poisson_bc bc_tv;
//  bc_tv.lo_type[0] = GKYL_POISSON_DIRICHLET;
//  bc_tv.up_type[0] = GKYL_POISSON_DIRICHLET;
//  bc_tv.lo_type[1] = GKYL_POISSON_NEUMANN;
//  bc_tv.up_type[1] = GKYL_POISSON_DIRICHLET;
//  bc_tv.lo_value[0].v[0] = 0.;
//  bc_tv.up_value[0].v[0] = 0.;
//  test_2x(1, &cells[0], bc_tv, false);
//}

void test_2x_p2_periodicx_periodicy() {
  int cells[] = {8,8};
  struct gkyl_poisson_bc bc_tv;
  bc_tv.lo_type[0] = GKYL_POISSON_PERIODIC;
  bc_tv.up_type[0] = GKYL_POISSON_PERIODIC;
  bc_tv.lo_type[1] = GKYL_POISSON_PERIODIC;
  bc_tv.up_type[1] = GKYL_POISSON_PERIODIC;
  test_2x(2, &cells[0], bc_tv, false);
}

void test_2x_p2_dirichletx_periodicy() {
  int cells[] = {8,8};
  struct gkyl_poisson_bc bc_tv;
  bc_tv.lo_type[0] = GKYL_POISSON_DIRICHLET;
  bc_tv.up_type[0] = GKYL_POISSON_DIRICHLET;
  bc_tv.lo_type[1] = GKYL_POISSON_PERIODIC;
  bc_tv.up_type[1] = GKYL_POISSON_PERIODIC;
  bc_tv.lo_value[0].v[0] = 0.;
  bc_tv.up_value[0].v[0] = 4.*pow(M_PI,3)/15.;
  test_2x(2, &cells[0], bc_tv, false);
}

void test_2x_p2_periodicx_dirichlety() {
  int cells[] = {8,8};
  struct gkyl_poisson_bc bc_tv;
  bc_tv.lo_type[0] = GKYL_POISSON_PERIODIC;
  bc_tv.up_type[0] = GKYL_POISSON_PERIODIC;
  bc_tv.lo_type[1] = GKYL_POISSON_DIRICHLET;
  bc_tv.up_type[1] = GKYL_POISSON_DIRICHLET;
  bc_tv.lo_value[1].v[0] = 0.;
  bc_tv.up_value[1].v[0] = 4.*pow(M_PI,3)/15.;
  test_2x(2, &cells[0], bc_tv, false);
}

#ifdef GKYL_HAVE_CUDA
void gpu_test_2x_p1_periodicx_periodicy() {
  int cells[] = {8,8};
  struct gkyl_poisson_bc bc_tv;
  bc_tv.lo_type[0] = GKYL_POISSON_PERIODIC;
  bc_tv.up_type[0] = GKYL_POISSON_PERIODIC;
  bc_tv.lo_type[1] = GKYL_POISSON_PERIODIC;
  bc_tv.up_type[1] = GKYL_POISSON_PERIODIC;
  test_2x(1, &cells[0], bc_tv, true);
}

void gpu_test_2x_p1_dirichletx_periodicy() {
  int cells[] = {8,8};
  struct gkyl_poisson_bc bc_tv;
  bc_tv.lo_type[0] = GKYL_POISSON_DIRICHLET;
  bc_tv.up_type[0] = GKYL_POISSON_DIRICHLET;
  bc_tv.lo_type[1] = GKYL_POISSON_PERIODIC;
  bc_tv.up_type[1] = GKYL_POISSON_PERIODIC;
  bc_tv.lo_value[0].v[0] = 0.;
  bc_tv.up_value[0].v[0] = 4.*pow(M_PI,3)/15.;
  test_2x(1, &cells[0], bc_tv, true);
}

void gpu_test_2x_p1_periodicx_dirichlety() {
  int cells[] = {8,8};
  struct gkyl_poisson_bc bc_tv;
  bc_tv.lo_type[0] = GKYL_POISSON_PERIODIC;
  bc_tv.up_type[0] = GKYL_POISSON_PERIODIC;
  bc_tv.lo_type[1] = GKYL_POISSON_DIRICHLET;
  bc_tv.up_type[1] = GKYL_POISSON_DIRICHLET;
  bc_tv.lo_value[1].v[0] = 0.;
  bc_tv.up_value[1].v[0] = 4.*pow(M_PI,3)/15.;
  test_2x(1, &cells[0], bc_tv, true);
}

void gpu_test_2x_p2_periodicx_periodicy() {
  int cells[] = {8,8};
  struct gkyl_poisson_bc bc_tv;
  bc_tv.lo_type[0] = GKYL_POISSON_PERIODIC;
  bc_tv.up_type[0] = GKYL_POISSON_PERIODIC;
  bc_tv.lo_type[1] = GKYL_POISSON_PERIODIC;
  bc_tv.up_type[1] = GKYL_POISSON_PERIODIC;
  test_2x(2, &cells[0], bc_tv, true);
}

void gpu_test_2x_p2_dirichletx_periodicy() {
  int cells[] = {8,8};
  struct gkyl_poisson_bc bc_tv;
  bc_tv.lo_type[0] = GKYL_POISSON_DIRICHLET;
  bc_tv.up_type[0] = GKYL_POISSON_DIRICHLET;
  bc_tv.lo_type[1] = GKYL_POISSON_PERIODIC;
  bc_tv.up_type[1] = GKYL_POISSON_PERIODIC;
  bc_tv.lo_value[0].v[0] = 0.;
  bc_tv.up_value[0].v[0] = 4.*pow(M_PI,3)/15.;
  test_2x(2, &cells[0], bc_tv, true);
}

void gpu_test_2x_p2_periodicx_dirichlety() {
  int cells[] = {8,8};
  struct gkyl_poisson_bc bc_tv;
  bc_tv.lo_type[0] = GKYL_POISSON_PERIODIC;
  bc_tv.up_type[0] = GKYL_POISSON_PERIODIC;
  bc_tv.lo_type[1] = GKYL_POISSON_DIRICHLET;
  bc_tv.up_type[1] = GKYL_POISSON_DIRICHLET;
  bc_tv.lo_value[1].v[0] = 0.;
  bc_tv.up_value[1].v[0] = 4.*pow(M_PI,3)/15.;
  test_2x(2, &cells[0], bc_tv, true);
}
#endif


TEST_LIST = {
  // 2x tests
  { "test_2x_p1_periodicx_periodicy", test_2x_p1_periodicx_periodicy },
  { "test_2x_p1_dirichletx_periodicy", test_2x_p1_dirichletx_periodicy },
  { "test_2x_p1_periodicx_dirichlety", test_2x_p1_periodicx_dirichlety },
//  { "test_2x_p1_dirichletx_neumanny_dirichlety", test_2x_p1_dirichletx_neumanny_dirichlety },
  { "test_2x_p2_periodicx_periodicy", test_2x_p2_periodicx_periodicy },
  { "test_2x_p2_dirichletx_periodicy", test_2x_p2_dirichletx_periodicy },
  { "test_2x_p2_periodicx_dirichlety", test_2x_p2_periodicx_dirichlety },
#ifdef GKYL_HAVE_CUDA
  { "gpu_test_2x_p1_periodicx_periodicy", gpu_test_2x_p1_periodicx_periodicy },
  { "gpu_test_2x_p1_dirichletx_periodicy", gpu_test_2x_p1_dirichletx_periodicy },
  { "gpu_test_2x_p1_periodicx_dirichlety", gpu_test_2x_p1_periodicx_dirichlety },
  { "gpu_test_2x_p2_periodicx_periodicy", gpu_test_2x_p2_periodicx_periodicy },
  { "gpu_test_2x_p2_dirichletx_periodicy", gpu_test_2x_p2_dirichletx_periodicy },
  { "gpu_test_2x_p2_periodicx_dirichlety", gpu_test_2x_p2_periodicx_dirichlety },
#endif
  { NULL, NULL },
};
