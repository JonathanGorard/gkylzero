// Test the FEM Poisson solver.
//
#include <acutest.h>

#include <gkyl_proj_on_basis.h>
#include <gkyl_range.h>
#include <gkyl_rect_decomp.h>
#include <gkyl_rect_grid.h>
#include <gkyl_array_rio.h>
#include <gkyl_fem_poisson.h>

void evalFunc1x_periodicx(double t, const double *xn, double* restrict fout, void *ctx)
{
  double x = xn[0];
  fout[0] = sin((2.*M_PI/(2.*M_PI))*x);
}
void evalFunc1x_dirichletx(double t, const double *xn, double* restrict fout, void *ctx)
{
  double x = xn[0];
  double a = 2.0;
  double c0 = a/12. - 1./2.;
  double c1 = 0.;
  fout[0] = -(1.-a*pow(x,2));
}

void evalFunc2x_periodicx_periodicy(double t, const double *xn, double* restrict fout, void *ctx)
{
  double x = xn[0], y = xn[1];
  fout[0] = sin((2.*M_PI/(2.*M_PI))*x)*cos((2.*2.*M_PI/(2.*M_PI))*y);
}
void evalFunc2x_dirichletx_dirichlety(double t, const double *xn, double* restrict fout, void *ctx)
{
  double x = xn[0], y = xn[1];
  double Lx = 2.*M_PI, Ly = 2.*M_PI;
  double kx = 2.*M_PI/Lx, ky = 2.*M_PI/Ly;
  double sig = 0.3*sqrt(Lx*Lx+Ly*Ly);
  fout[0] = exp(-(pow(kx*x,2)+pow(ky*y,2))/(2.*(sig*sig)));
}

// allocate array (filled with zeros)
static struct gkyl_array*
mkarr(long nc, long size)
{
  struct gkyl_array* a = gkyl_array_new(GKYL_DOUBLE, nc, size);
  return a;
}

struct skin_ghost_ranges {
  struct gkyl_range lower_skin[GKYL_MAX_DIM];
  struct gkyl_range lower_ghost[GKYL_MAX_DIM];

  struct gkyl_range upper_skin[GKYL_MAX_DIM];
  struct gkyl_range upper_ghost[GKYL_MAX_DIM];
};

// Create ghost and skin sub-ranges given a parent range
static void
skin_ghost_ranges_init(struct skin_ghost_ranges *sgr,
  const struct gkyl_range *parent, const int *ghost)
{
  int ndim = parent->ndim;

  for (int d=0; d<ndim; ++d) {
    gkyl_skin_ghost_ranges(&sgr->lower_skin[d], &sgr->lower_ghost[d],
      d, GKYL_LOWER_EDGE, parent, ghost);
    gkyl_skin_ghost_ranges(&sgr->upper_skin[d], &sgr->upper_ghost[d],
      d, GKYL_UPPER_EDGE, parent, ghost);
  }
}

// Apply periodic BCs in one direction.
void
apply_periodic_bc(struct gkyl_array *buff, struct gkyl_array *fld, const int dir, const struct skin_ghost_ranges sgr)
{
  gkyl_array_copy_to_buffer(buff->data, fld, sgr.lower_skin[dir]);
  gkyl_array_copy_from_buffer(fld, buff->data, sgr.upper_ghost[dir]);

  gkyl_array_copy_to_buffer(buff->data, fld, sgr.upper_skin[dir]);
  gkyl_array_copy_from_buffer(fld, buff->data, sgr.lower_ghost[dir]);
}

void
test_1x(int poly_order, const int *cells, struct gkyl_poisson_bc bcs)
{
  double epsilon_0 = 1.0;
  double lower[] = {0.0}, upper[] = {1.0};
  if (bcs.lo_type[0] == GKYL_POISSON_PERIODIC) {
    lower[0] = -M_PI;
    upper[0] =  M_PI;
  }
  int dim = sizeof(lower)/sizeof(lower[0]);

  // grids.
  struct gkyl_rect_grid grid;
  gkyl_rect_grid_init(&grid, dim, lower, upper, cells);

  // basis functions.
  struct gkyl_basis basis;
  gkyl_cart_modal_serendip(&basis, dim, poly_order);

  int ghost[] = { 1 };
  struct gkyl_range localRange, localRange_ext; // local, local-ext ranges.
  gkyl_create_grid_ranges(&grid, ghost, &localRange_ext, &localRange);
  struct skin_ghost_ranges skin_ghost; // skin/ghost.
  skin_ghost_ranges_init(&skin_ghost, &localRange_ext, ghost);

  // projection updater for DG field.
  gkyl_proj_on_basis *projob;
  if (bcs.lo_type[0] == GKYL_POISSON_PERIODIC) {
    projob = gkyl_proj_on_basis_new(&grid, &basis,
      poly_order+1, 1, evalFunc1x_periodicx, NULL);
  } else if (bcs.lo_type[0]==GKYL_POISSON_DIRICHLET && bcs.up_type[0]==GKYL_POISSON_DIRICHLET) {
    projob = gkyl_proj_on_basis_new(&grid, &basis,
      poly_order+1, 1, evalFunc1x_dirichletx, NULL);
  }

  // create DG field we wish to make continuous.
  struct gkyl_array *rho = mkarr(basis.num_basis, localRange_ext.volume);
  // create array holding continuous field we'll compute.
  struct gkyl_array *phi = mkarr(basis.num_basis, localRange_ext.volume);

  // project distribution function on basis.
  gkyl_proj_on_basis_advance(projob, 0.0, &localRange, rho);
  struct gkyl_array *perbuff = mkarr(basis.num_basis, skin_ghost.lower_skin[dim-1].volume);
  for (int d=0; d<dim; d++)
    if (bcs.lo_type[d] == GKYL_POISSON_PERIODIC) apply_periodic_bc(perbuff, rho, d, skin_ghost);
  gkyl_grid_sub_array_write(&grid, &localRange, rho, "ctest_fem_poisson_1x_rho_1.gkyl");

  // FEM poisson solver.
  gkyl_fem_poisson *poisson = gkyl_fem_poisson_new(&grid, basis, bcs, epsilon_0, NULL);

  // Set the RHS source.
  gkyl_fem_poisson_set_rhs(poisson, rho);

  // Solve the problem.
  gkyl_fem_poisson_solve(poisson, phi);
  for (int d=0; d<dim; d++)
    if (bcs.lo_type[d] == GKYL_POISSON_PERIODIC) apply_periodic_bc(perbuff, phi, d, skin_ghost);
  gkyl_grid_sub_array_write(&grid, &localRange, phi, "ctest_fem_poisson_1x_phi_1.gkyl");

  if (poly_order == 1) {
    if (bcs.lo_type[0] == GKYL_POISSON_PERIODIC) {
      // Solution with N=16 (checked visually against g2):
      const double sol[32] = {
         0.6024058953991888, -0.1562324583525289,
         0.1023975701639015, -0.1324474828191181,
        -0.2802922340604182, -0.0884985786659181,
        -0.4874024636723316, -0.0310765681524454,
        -0.4874024636723317,  0.0310765681524453,
        -0.2802922340604183,  0.088498578665918 ,
         0.1023975701639012,  0.132447482819118 ,
         0.6024058953991883,  0.1562324583525289,
         1.1436110067151257,  0.1562324583525289,
         1.6436193319504129,  0.1324474828191181,
         2.0263091361747327,  0.0884985786659181,
         2.2334193657866463,  0.0310765681524454,
         2.2334193657866463, -0.0310765681524453,
         2.026309136174733 , -0.0884985786659181,
         1.6436193319504133, -0.1324474828191181,
         1.1436110067151262, -0.156232458352529 ,
      };

      for (int k=0; k<cells[0]; k++) {
        long linidx;
        const double *phi_p;
        int idx0[] = {k+1};
        linidx = gkyl_range_idx(&localRange, idx0);
        phi_p  = gkyl_array_cfetch(phi, linidx);
        for (int m=0; m<basis.num_basis; m++)
          TEST_CHECK( gkyl_compare(sol[k*basis.num_basis+m], phi_p[m], 1e-14) );
      }
    } else if (bcs.lo_type[0]==GKYL_POISSON_DIRICHLET && bcs.up_type[0]==GKYL_POISSON_DIRICHLET) {
      // Solution with N=16 (checked visually against g2):
      const double sol[32] = {
        -0.0133521216082515, -0.0077088510047765,
        -0.0373194046782545, -0.0061286663274337,
        -0.0558775050145713, -0.0045858578973869,
        -0.0691990561087026, -0.0031053432128332,
        -0.0775430081978993, -0.0017120397719699,
        -0.0812546282651626, -0.0004308650729942,
        -0.0807655000392442,  0.0007132633858965,
        -0.0765935239946458,  0.0016954281065051,
        -0.0693429173516197,  0.0024907115906342,
        -0.0597042140761683,  0.0030741963400866,
        -0.0484542648800444,  0.0034209648566651,
        -0.0364562372207511,  0.0035060996421724,
        -0.024659615301542 ,  0.0033046831984112,
        -0.0141002000714206,  0.0027917980271844,
        -0.0059001092251411,  0.0019425266302945,
        -0.0012677772032077,  0.0007319515095444,
      };

      for (int k=0; k<cells[0]; k++) {
        long linidx;
        const double *phi_p;
        int idx0[] = {k+1};
        linidx = gkyl_range_idx(&localRange, idx0);
        phi_p  = gkyl_array_cfetch(phi, linidx);
        for (int m=0; m<basis.num_basis; m++)
          TEST_CHECK( gkyl_compare(sol[k*basis.num_basis+m], phi_p[m], 1e-13) );
      }
    } else {
    }
  } if (poly_order == 2) {
    if (bcs.lo_type[0] == GKYL_POISSON_PERIODIC) {
      // Solution with N=8 (checked visually against g2):
      const double sol[24] =  {
        -0.5464696577208076, -0.2886749615022944,  0.0122509823232911,
        -1.2923170226350675, -0.1195730841717814,  0.0295764876772824,
        -1.2923170226350678,  0.1195730841717814,  0.0295764876772824,
        -0.5464696577208071,  0.2886749615022945,  0.0122509823232911,
         0.5083178012011744,  0.2886749615022943, -0.0122509823232911,
         1.254165166115434 ,  0.1195730841717813, -0.0295764876772823,
         1.254165166115434 , -0.1195730841717814, -0.0295764876772824,
         0.5083178012011739, -0.2886749615022944, -0.0122509823232911,
      };

      for (int k=0; k<cells[0]; k++) {
        long linidx;
        const double *phi_p;
        int idx0[] = {k+1};
        linidx = gkyl_range_idx(&localRange, idx0);
        phi_p  = gkyl_array_cfetch(phi, linidx);
        for (int m=0; m<basis.num_basis; m++)
          TEST_CHECK( gkyl_compare(sol[k*basis.num_basis+m], phi_p[m], 1e-14) );
      }
    } else if (bcs.lo_type[0]==GKYL_POISSON_DIRICHLET && bcs.up_type[0]==GKYL_POISSON_DIRICHLET) {
      // Solution with N=8 (checked visually against g2):
      const double sol[24] =  {
        -2.5791443630192343e-02, -1.3837517332209948e-02,  8.1578940289174257e-04,
        -6.2965188799992161e-02, -7.6912011102198800e-03,  7.6432003993326847e-04,
        -7.9768181972718816e-02, -2.1429048449640056e-03,  6.6138131401632689e-04,
        -7.8962559012382361e-02,  2.4086914924015437e-03,  5.0697322514091727e-04,
        -6.4691523714997728e-02,  5.5649079307207141e-03,  3.0109577330704072e-04,
        -4.2479347808584755e-02,  6.9270644988373735e-03,  4.3748958514695155e-05,
        -1.9231370953168247e-02,  6.0964812255954216e-03, -2.6506721923612130e-04,
        -3.2340007407779619e-03,  2.6744781398387418e-03, -6.2535275994540806e-04,
      };

      for (int k=0; k<cells[0]; k++) {
        long linidx;
        const double *phi_p;
        int idx0[] = {k+1};
        linidx = gkyl_range_idx(&localRange, idx0);
        phi_p  = gkyl_array_cfetch(phi, linidx);
        for (int m=0; m<basis.num_basis; m++)
          TEST_CHECK( gkyl_compare(sol[k*basis.num_basis+m], phi_p[m], 1e-14) );
      }
    } else {
    }
  }

  gkyl_fem_poisson_release(poisson);
  gkyl_proj_on_basis_release(projob);
  gkyl_array_release(rho);
  gkyl_array_release(phi);
  gkyl_array_release(perbuff);
}

void
test_2x(int poly_order, const int *cells, struct gkyl_poisson_bc bcs)
{
  double epsilon_0 = 1.0;
  double lower[] = {-M_PI,-M_PI}, upper[] = {M_PI,M_PI};
  int dim = sizeof(lower)/sizeof(lower[0]);

  // grids.
  struct gkyl_rect_grid grid;
  gkyl_rect_grid_init(&grid, dim, lower, upper, cells);

  // basis functions.
  struct gkyl_basis basis;
  gkyl_cart_modal_serendip(&basis, dim, poly_order);

  int ghost[] = { 1, 1 };
  struct gkyl_range localRange, localRange_ext; // local, local-ext ranges.
  gkyl_create_grid_ranges(&grid, ghost, &localRange_ext, &localRange);
  struct skin_ghost_ranges skin_ghost; // skin/ghost.
  skin_ghost_ranges_init(&skin_ghost, &localRange_ext, ghost);

  // projection updater for DG field.
  gkyl_proj_on_basis *projob;
  if (bcs.lo_type[0] == GKYL_POISSON_PERIODIC && bcs.lo_type[1] == GKYL_POISSON_PERIODIC) {
    projob = gkyl_proj_on_basis_new(&grid, &basis,
      poly_order+1, 1, evalFunc2x_periodicx_periodicy, NULL);
  } else if ((bcs.lo_type[0]==GKYL_POISSON_DIRICHLET && bcs.up_type[0]==GKYL_POISSON_DIRICHLET) &&
             (bcs.lo_type[1]==GKYL_POISSON_DIRICHLET && bcs.up_type[1]==GKYL_POISSON_DIRICHLET)) {
    projob = gkyl_proj_on_basis_new(&grid, &basis,
      poly_order+1, 1, evalFunc2x_dirichletx_dirichlety, NULL);
  }

  // create DG field we wish to make continuous.
  struct gkyl_array *rho = mkarr(basis.num_basis, localRange_ext.volume);
  // create array holding continuous field we'll compute.
  struct gkyl_array *phi = mkarr(basis.num_basis, localRange_ext.volume);

  // project distribution function on basis.
  gkyl_proj_on_basis_advance(projob, 0.0, &localRange, rho);
  struct gkyl_array *perbuff = mkarr(basis.num_basis, skin_ghost.lower_skin[dim-1].volume);
  for (int d=0; d<dim; d++)
    if (bcs.lo_type[d] == GKYL_POISSON_PERIODIC) apply_periodic_bc(perbuff, rho, d, skin_ghost);
  gkyl_grid_sub_array_write(&grid, &localRange, rho, "ctest_fem_poisson_2x_rho_1.gkyl");

  // FEM poisson solver.
  gkyl_fem_poisson *poisson = gkyl_fem_poisson_new(&grid, basis, bcs, epsilon_0, NULL);

  // Set the RHS source.
  gkyl_fem_poisson_set_rhs(poisson, rho);

  // Solve the problem.
  gkyl_fem_poisson_solve(poisson, phi);
  for (int d=0; d<dim; d++)
    if (bcs.lo_type[d] == GKYL_POISSON_PERIODIC) apply_periodic_bc(perbuff, phi, d, skin_ghost);
  gkyl_grid_sub_array_write(&grid, &localRange, phi, "ctest_fem_poisson_2x_phi_1.gkyl");

  if (poly_order == 1) {
    if (bcs.lo_type[0] == GKYL_POISSON_PERIODIC && bcs.lo_type[1] == GKYL_POISSON_PERIODIC) {
      // Solution with N=8x8 (checked visually against g2):
      const double sol[256] = {
        // idx = [1,:,:]
        -0.1072531956947871, -0.0443762721584261,  0.044376272158426 , 0.0256206526762994 ,
         0.046470720363009 ,  0.0443762721584261,  0.044376272158426 , 0.0256206526762994 ,
         0.046470720363009 ,  0.044376272158426 , -0.0443762721584261, -0.0256206526762994,
        -0.1072531956947872, -0.0443762721584261, -0.0443762721584261, -0.0256206526762994,
        -0.1072531956947871, -0.0443762721584261,  0.0443762721584261,  0.0256206526762994,
         0.0464707203630092,  0.0443762721584261,  0.0443762721584261,  0.0256206526762994,
         0.0464707203630093,  0.0443762721584261, -0.0443762721584261, -0.0256206526762994,
        -0.1072531956947871, -0.0443762721584261, -0.0443762721584261, -0.0256206526762994,
        // idx = [2,:,:]                                                                   
        -0.2159524191698064, -0.0183812537755796,  0.1071337980924318,  0.0106124218153737,
         0.1551699438380284,  0.0183812537755797,  0.1071337980924317,  0.0106124218153737,
         0.1551699438380283,  0.0183812537755797, -0.1071337980924318, -0.0106124218153737,
        -0.2159524191698066, -0.0183812537755796, -0.1071337980924318, -0.0106124218153737,
        -0.2159524191698065, -0.0183812537755796,  0.1071337980924318,  0.0106124218153737,
         0.1551699438380286,  0.0183812537755797,  0.1071337980924318,  0.0106124218153737,
         0.1551699438380287,  0.0183812537755797, -0.1071337980924318, -0.0106124218153737,
        -0.2159524191698063, -0.0183812537755796, -0.1071337980924318, -0.0106124218153737,
        // idx = [3,:,:]                                                                   
        -0.2159524191698064,  0.0183812537755796,  0.1071337980924318, -0.0106124218153737,
         0.1551699438380285, -0.0183812537755796,  0.1071337980924317, -0.0106124218153737,
         0.1551699438380284, -0.0183812537755796, -0.1071337980924318,  0.0106124218153737,
        -0.2159524191698065,  0.0183812537755797, -0.1071337980924318,  0.0106124218153737,
        -0.2159524191698064,  0.0183812537755797,  0.1071337980924318, -0.0106124218153737,
         0.1551699438380286, -0.0183812537755797,  0.1071337980924318, -0.0106124218153737,
         0.1551699438380287, -0.0183812537755797, -0.1071337980924318,  0.0106124218153737,
        -0.2159524191698063,  0.0183812537755796, -0.1071337980924318,  0.0106124218153737,
        // idx = [4,:,:]                                                                   
        -0.1072531956947871,  0.044376272158426 ,  0.0443762721584261, -0.0256206526762994,
         0.0464707203630091, -0.0443762721584261,  0.0443762721584261, -0.0256206526762994,
         0.0464707203630091, -0.0443762721584261, -0.0443762721584261,  0.0256206526762994,
        -0.1072531956947871,  0.0443762721584261, -0.044376272158426 ,  0.0256206526762994,
        -0.1072531956947871,  0.0443762721584261,  0.0443762721584261, -0.0256206526762994,
         0.0464707203630092, -0.0443762721584261,  0.0443762721584261, -0.0256206526762994,
         0.0464707203630092, -0.0443762721584261, -0.0443762721584261,  0.0256206526762994,
        -0.1072531956947871,  0.044376272158426 , -0.0443762721584261,  0.0256206526762994,
        // idx = [5,:,:]                                                                   
         0.0464707203630091,  0.044376272158426 , -0.0443762721584261, -0.0256206526762994,
        -0.1072531956947872, -0.0443762721584261, -0.0443762721584261, -0.0256206526762994,
        -0.1072531956947871, -0.0443762721584261,  0.0443762721584261,  0.0256206526762994,
         0.0464707203630091,  0.0443762721584261,  0.0443762721584261,  0.0256206526762994,
         0.0464707203630092,  0.0443762721584261, -0.044376272158426 , -0.0256206526762994,
        -0.1072531956947871, -0.0443762721584261, -0.0443762721584261, -0.0256206526762994,
        -0.1072531956947871, -0.0443762721584261,  0.044376272158426 ,  0.0256206526762994,
         0.0464707203630091,  0.044376272158426 ,  0.044376272158426 ,  0.0256206526762994,
        // idx = [6,:,:]                                                                   
         0.1551699438380284,  0.0183812537755796, -0.1071337980924318, -0.0106124218153738,
        -0.2159524191698065, -0.0183812537755797, -0.1071337980924317, -0.0106124218153737,
        -0.2159524191698065, -0.0183812537755796,  0.1071337980924318,  0.0106124218153737,
         0.1551699438380285,  0.0183812537755796,  0.1071337980924318,  0.0106124218153737,
         0.1551699438380285,  0.0183812537755797, -0.1071337980924317, -0.0106124218153737,
        -0.2159524191698064, -0.0183812537755796, -0.1071337980924318, -0.0106124218153737,
        -0.2159524191698065, -0.0183812537755797,  0.1071337980924317,  0.0106124218153737,
         0.1551699438380284,  0.0183812537755797,  0.1071337980924318,  0.0106124218153737,
        // idx = [7,:,:]                                                                   
         0.1551699438380284, -0.0183812537755796, -0.1071337980924318,  0.0106124218153737,
        -0.2159524191698066,  0.0183812537755796, -0.1071337980924318,  0.0106124218153737,
        -0.2159524191698066,  0.0183812537755796,  0.1071337980924318, -0.0106124218153737,
         0.1551699438380285, -0.0183812537755796,  0.1071337980924318, -0.0106124218153737,
         0.1551699438380285, -0.0183812537755796, -0.1071337980924318,  0.0106124218153737,
        -0.2159524191698063,  0.0183812537755797, -0.1071337980924318,  0.0106124218153738,
        -0.2159524191698064,  0.0183812537755797,  0.1071337980924317, -0.0106124218153737,
         0.1551699438380285, -0.0183812537755796,  0.1071337980924318, -0.0106124218153737,
        // idx = [8,:,:]                                                                   
         0.0464707203630091, -0.0443762721584261, -0.0443762721584261,  0.0256206526762994,
        -0.1072531956947873,  0.0443762721584261, -0.0443762721584261,  0.0256206526762994,
        -0.1072531956947873,  0.0443762721584261,  0.0443762721584261, -0.0256206526762994,
         0.0464707203630091, -0.0443762721584261,  0.0443762721584261, -0.0256206526762994,
         0.0464707203630092, -0.0443762721584261, -0.0443762721584261,  0.0256206526762994,
        -0.107253195694787 ,  0.0443762721584261, -0.044376272158426 ,  0.0256206526762994,
        -0.107253195694787 ,  0.0443762721584261,  0.044376272158426 , -0.0256206526762994,
         0.0464707203630092, -0.0443762721584261,  0.0443762721584261, -0.0256206526762994,
      };
      for (int j=0; j<cells[0]; j++) {
        for (int k=0; k<cells[1]; k++) {
          int idx0[] = {j+1,k+1};
          long linidx = gkyl_range_idx(&localRange, idx0);
          const double *phi_p  = gkyl_array_cfetch(phi, linidx);
          for (int m=0; m<basis.num_basis; m++)
            TEST_CHECK( gkyl_compare(sol[(j*cells[1]+k)*basis.num_basis+m], phi_p[m], 1e-13) );
        }
      }
    } else if ((bcs.lo_type[0] == GKYL_POISSON_DIRICHLET && bcs.up_type[0] == GKYL_POISSON_DIRICHLET) &&
               (bcs.lo_type[1] == GKYL_POISSON_DIRICHLET && bcs.up_type[1] == GKYL_POISSON_DIRICHLET)) {
      // Solution with N=8x8 (checked visually against g2):
      const double sol[256] = {
        2.3681559834188498e-01,  1.3672554945099072e-01,  1.3672554945098905e-01,  7.8938532780630122e-02,
        6.3388180537571182e-01,  3.6597183096807612e-01,  9.2520732066094527e-02,  5.3416869563979862e-02,
        8.9067264750613684e-01,  5.1423009279750498e-01,  5.5737529763337020e-02,  3.2180077812826891e-02,
        1.0196938687973565e+00,  5.8872052964116539e-01,  1.8752907080322980e-02,  1.0826995950913283e-02,
        1.0196938687973551e+00,  5.8872052964116617e-01, -1.8752907080323782e-02, -1.0826995950912827e-02,
        8.9067264750613595e-01,  5.1423009279750564e-01, -5.5737529763335895e-02, -3.2180077812827390e-02,
        6.3388180537571470e-01,  3.6597183096807495e-01, -9.2520732066093542e-02, -5.3416869563980424e-02,
        2.3681559834188717e-01,  1.3672554945099089e-01, -1.3672554945099044e-01, -7.8938532780628831e-02,
                                                        
        6.3388180537571459e-01,  9.2520732066094485e-02,  3.6597183096807473e-01,  5.3416869563980014e-02,
        1.7090814385197843e+00,  2.5479496666024115e-01,  2.5479496666024093e-01,  4.0272203461491046e-02,
        2.4167368175137374e+00,  3.6684346655702615e-01,  1.5377005689540441e-01,  2.4419028116211553e-02,
        2.7726579759463506e+00,  4.2335376950105846e-01,  5.1721119735948180e-02,  8.2072105005127904e-03,
        2.7726579759463510e+00,  4.2335376950105857e-01, -5.1721119735948097e-02, -8.2072105005127401e-03,
        2.4167368175137383e+00,  3.6684346655702638e-01, -1.5377005689540432e-01, -2.4419028116211581e-02,
        1.7090814385197852e+00,  2.5479496666024121e-01, -2.5479496666024098e-01, -4.0272203461491102e-02,
        6.3388180537571515e-01,  9.2520732066093431e-02, -3.6597183096807484e-01, -5.3416869563980611e-02,
                                                        
        8.9067264750613706e-01,  5.5737529763335694e-02,  5.1423009279750498e-01,  3.2180077812827605e-02,
        2.4167368175137374e+00,  1.5377005689540435e-01,  3.6684346655702599e-01,  2.4419028116211518e-02,
        3.4373208199425331e+00,  2.2239098197586474e-01,  2.2239098197586490e-01,  1.5199281451033411e-02,
        3.9521264825956046e+00,  2.5761269031357442e-01,  7.4832205937229848e-02,  5.1359813390617843e-03,
        3.9521264825956055e+00,  2.5761269031357470e-01, -7.4832205937229418e-02, -5.1359813390615995e-03,
        3.4373208199425345e+00,  2.2239098197586496e-01, -2.2239098197586502e-01, -1.5199281451033622e-02,
        2.4167368175137383e+00,  1.5377005689540424e-01, -3.6684346655702615e-01, -2.4419028116211505e-02,
        8.9067264750613750e-01,  5.5737529763336638e-02, -5.1423009279750520e-01, -3.2180077812827015e-02,
                                                        
        1.0196938687973565e+00,  1.8752907080324045e-02,  5.8872052964116561e-01,  1.0826995950912709e-02,
        2.7726579759463501e+00,  5.1721119735948284e-02,  4.2335376950105824e-01,  8.2072105005128095e-03,
        3.9521264825956042e+00,  7.4832205937229584e-02,  2.5761269031357442e-01,  5.1359813390616359e-03,
        4.5485900655688685e+00,  8.6755719877848164e-02,  8.6755719877848719e-02,  1.7480626442406752e-03,
        4.5485900655688685e+00,  8.6755719877847776e-02, -8.6755719877848275e-02, -1.7480626442409205e-03,
        3.9521264825956046e+00,  7.4832205937228988e-02, -2.5761269031357459e-01, -5.1359813390615587e-03,
        2.7726579759463506e+00,  5.1721119735947924e-02, -4.2335376950105819e-01, -8.2072105005127505e-03,
        1.0196938687973565e+00,  1.8752907080322814e-02, -5.8872052964116572e-01, -1.0826995950913227e-02,
                                                        
        1.0196938687973578e+00, -1.8752907080323244e-02,  5.8872052964116495e-01, -1.0826995950913076e-02,
        2.7726579759463510e+00, -5.1721119735948159e-02,  4.2335376950105824e-01, -8.2072105005127211e-03,
        3.9521264825956046e+00, -7.4832205937229349e-02,  2.5761269031357431e-01, -5.1359813390616368e-03,
        4.5485900655688685e+00, -8.6755719877848525e-02,  8.6755719877847970e-02, -1.7480626442410686e-03,
        4.5485900655688667e+00, -8.6755719877848803e-02, -8.6755719877848247e-02,  1.7480626442408095e-03,
        3.9521264825956033e+00, -7.4832205937229904e-02, -2.5761269031357409e-01,  5.1359813390617765e-03,
        2.7726579759463501e+00, -5.1721119735948243e-02, -4.2335376950105824e-01,  8.2072105005128078e-03,
        1.0196938687973569e+00, -1.8752907080322453e-02, -5.8872052964116517e-01,  1.0826995950913517e-02,
                                                        
        8.9067264750613750e-01, -5.5737529763336964e-02,  5.1423009279750509e-01, -3.2180077812826779e-02,
        2.4167368175137387e+00, -1.5377005689540407e-01,  3.6684346655702621e-01, -2.4419028116211449e-02,
        3.4373208199425340e+00, -2.2239098197586465e-01,  2.2239098197586460e-01, -1.5199281451033603e-02,
        3.9521264825956037e+00, -2.5761269031357431e-01,  7.4832205937229085e-02, -5.1359813390615770e-03,
        3.9521264825956024e+00, -2.5761269031357420e-01, -7.4832205937229654e-02,  5.1359813390616099e-03,
        3.4373208199425314e+00, -2.2239098197586477e-01, -2.2239098197586432e-01,  1.5199281451033496e-02,
        2.4167368175137374e+00, -1.5377005689540416e-01, -3.6684346655702588e-01,  2.4419028116211574e-02,
        8.9067264750613806e-01, -5.5737529763336978e-02, -5.1423009279750453e-01,  3.2180077812826766e-02,
                                                        
        6.3388180537571459e-01, -9.2520732066093431e-02,  3.6597183096807528e-01, -5.3416869563980569e-02,
        1.7090814385197859e+00, -2.5479496666024121e-01,  2.5479496666024121e-01, -4.0272203461491109e-02,
        2.4167368175137387e+00, -3.6684346655702615e-01,  1.5377005689540399e-01, -2.4419028116211421e-02,
        2.7726579759463506e+00, -4.2335376950105813e-01,  5.1721119735947743e-02, -8.2072105005127610e-03,
        2.7726579759463492e+00, -4.2335376950105796e-01, -5.1721119735948368e-02,  8.2072105005128824e-03,
        2.4167368175137369e+00, -3.6684346655702577e-01, -1.5377005689540402e-01,  2.4419028116211414e-02,
        1.7090814385197848e+00, -2.5479496666024104e-01, -2.5479496666024082e-01,  4.0272203461491039e-02,
        6.3388180537571470e-01, -9.2520732066093667e-02, -3.6597183096807501e-01,  5.3416869563980458e-02,
                                                        
        2.3681559834188717e-01, -1.3672554945099052e-01,  1.3672554945099086e-01, -7.8938532780628887e-02,
        6.3388180537571537e-01, -3.6597183096807490e-01,  9.2520732066093569e-02, -5.3416869563980528e-02,
        8.9067264750613795e-01, -5.1423009279750498e-01,  5.5737529763336596e-02, -3.2180077812827008e-02,
        1.0196938687973571e+00, -5.8872052964116517e-01,  1.8752907080323126e-02, -1.0826995950912990e-02,
        1.0196938687973565e+00, -5.8872052964116517e-01, -1.8752907080323424e-02,  1.0826995950912984e-02,
        8.9067264750613695e-01, -5.1423009279750498e-01, -5.5737529763336513e-02,  3.2180077812827092e-02,
        6.3388180537571459e-01, -3.6597183096807484e-01, -9.2520732066093569e-02,  5.3416869563980382e-02,
        2.3681559834188676e-01, -1.3672554945099064e-01, -1.3672554945099064e-01,  7.8938532780628942e-02,
      };
      for (int j=0; j<cells[0]; j++) {
        for (int k=0; k<cells[1]; k++) {
          int idx0[] = {j+1,k+1};
          long linidx = gkyl_range_idx(&localRange, idx0);
          const double *phi_p  = gkyl_array_cfetch(phi, linidx);
          for (int m=0; m<basis.num_basis; m++)
            TEST_CHECK( gkyl_compare(sol[(j*cells[1]+k)*basis.num_basis+m], phi_p[m], 1e-13) );
        }
      }
    } else {
    }
  } if (poly_order == 2) {
    if (bcs.lo_type[0] == GKYL_POISSON_PERIODIC && bcs.lo_type[1] == GKYL_POISSON_PERIODIC) {
      // Solution with N=8x8 (checked visually against g2):
      const double sol[512] =  {
        // idx = [1,:,:] 
        -0.1612019662117002, -0.0522378610013685,  0.0431773750583578,  0.0233874003813852,  0.0020675606649251,  0.0090857828980906, -0.0011937067064604,  0.0052456792020111,
         0.0290017048432367,  0.0522378610013686,  0.0431773750583578,  0.0233874003813852, -0.0020675606649252, -0.0090857828980906, -0.0011937067064604, -0.0052456792020111,
         0.0290017048432366,  0.0522378610013685, -0.0431773750583579, -0.0233874003813852, -0.0020675606649251, -0.0090857828980906,  0.0011937067064604, -0.0052456792020111,
        -0.1612019662117004, -0.0522378610013686, -0.0431773750583578, -0.0233874003813852,  0.0020675606649251,  0.0090857828980906,  0.0011937067064604,  0.0052456792020111,
        -0.1612019662117004, -0.0522378610013686,  0.0431773750583578,  0.0233874003813852,  0.0020675606649251,  0.0090857828980905, -0.0011937067064604,  0.0052456792020111,
         0.0290017048432366,  0.0522378610013685,  0.0431773750583578,  0.0233874003813852, -0.0020675606649252, -0.0090857828980906, -0.0011937067064604, -0.0052456792020111,
         0.0290017048432367,  0.0522378610013686, -0.0431773750583578, -0.0233874003813852, -0.0020675606649251, -0.0090857828980906,  0.0011937067064604, -0.0052456792020111,
        -0.1612019662117001, -0.0522378610013685, -0.0431773750583578, -0.0233874003813852,  0.0020675606649252,  0.0090857828980906,  0.0011937067064604,  0.0052456792020111,
        // idx = [2,:,:] 
        -0.2956962718212214, -0.0216376304961275,  0.1042394044535572,  0.0096873784266194,  0.0049915329982914,  0.0219350202973478, -0.0028818629202325,  0.0021728314693315,
         0.1634960104527581,  0.0216376304961275,  0.1042394044535571,  0.0096873784266195, -0.0049915329982914, -0.0219350202973478, -0.0028818629202324, -0.0021728314693315,
         0.1634960104527579,  0.0216376304961275, -0.1042394044535573, -0.0096873784266194, -0.0049915329982914, -0.0219350202973477,  0.0028818629202324, -0.0021728314693314,
        -0.2956962718212218, -0.0216376304961274, -0.1042394044535572, -0.0096873784266195,  0.0049915329982914,  0.0219350202973477,  0.0028818629202324,  0.0021728314693314,
        -0.2956962718212218, -0.0216376304961275,  0.1042394044535572,  0.0096873784266194,  0.0049915329982914,  0.0219350202973477, -0.0028818629202325,  0.0021728314693315,
         0.1634960104527579,  0.0216376304961275,  0.1042394044535572,  0.0096873784266195, -0.0049915329982914, -0.0219350202973478, -0.0028818629202324, -0.0021728314693315,
         0.163496010452758 ,  0.0216376304961275, -0.1042394044535572, -0.0096873784266194, -0.0049915329982914, -0.0219350202973478,  0.0028818629202324, -0.0021728314693315,
        -0.2956962718212214, -0.0216376304961274, -0.1042394044535572, -0.0096873784266195,  0.0049915329982914,  0.0219350202973477,  0.0028818629202325,  0.0021728314693315,
        // idx = [3,:,:] 
        -0.2956962718212215,  0.0216376304961274,  0.1042394044535572, -0.0096873784266194,  0.0049915329982914,  0.0219350202973477, -0.0028818629202325, -0.0021728314693315,
         0.163496010452758 , -0.0216376304961275,  0.1042394044535572, -0.0096873784266195, -0.0049915329982914, -0.0219350202973478, -0.0028818629202324,  0.0021728314693315,
         0.1634960104527579, -0.0216376304961274, -0.1042394044535573,  0.0096873784266195, -0.0049915329982914, -0.0219350202973477,  0.0028818629202325,  0.0021728314693314,
        -0.2956962718212217,  0.0216376304961274, -0.1042394044535572,  0.0096873784266195,  0.0049915329982914,  0.0219350202973478,  0.0028818629202324, -0.0021728314693315,
        -0.2956962718212217,  0.0216376304961275,  0.1042394044535572, -0.0096873784266195,  0.0049915329982914,  0.0219350202973478, -0.0028818629202324, -0.0021728314693315,
         0.1634960104527579, -0.0216376304961275,  0.1042394044535572, -0.0096873784266195, -0.0049915329982914, -0.0219350202973478, -0.0028818629202325,  0.0021728314693315,
         0.163496010452758 , -0.0216376304961274, -0.1042394044535572,  0.0096873784266194, -0.0049915329982914, -0.0219350202973478,  0.0028818629202324,  0.0021728314693314,
        -0.2956962718212214,  0.0216376304961273, -0.1042394044535572,  0.0096873784266194,  0.0049915329982914,  0.0219350202973477,  0.0028818629202325, -0.0021728314693315,
        // idx = [4,:,:] 
        -0.1612019662117004,  0.0522378610013685,  0.0431773750583578, -0.0233874003813852,  0.0020675606649251,  0.0090857828980905, -0.0011937067064604, -0.0052456792020111,
         0.0290017048432365, -0.0522378610013686,  0.0431773750583578, -0.0233874003813852, -0.0020675606649252, -0.0090857828980905, -0.0011937067064604,  0.0052456792020111,
         0.0290017048432365, -0.0522378610013686, -0.0431773750583578,  0.0233874003813852, -0.0020675606649251, -0.0090857828980906,  0.0011937067064604,  0.0052456792020111,
        -0.1612019662117004,  0.0522378610013686, -0.0431773750583578,  0.0233874003813852,  0.0020675606649251,  0.0090857828980906,  0.0011937067064604, -0.0052456792020111,
        -0.1612019662117004,  0.0522378610013685,  0.0431773750583578, -0.0233874003813852,  0.0020675606649251,  0.0090857828980905, -0.0011937067064604, -0.0052456792020111,
         0.0290017048432366, -0.0522378610013685,  0.0431773750583578, -0.0233874003813852, -0.0020675606649251, -0.0090857828980906, -0.0011937067064604,  0.0052456792020111,
         0.0290017048432367, -0.0522378610013686, -0.0431773750583578,  0.0233874003813852, -0.0020675606649251, -0.0090857828980906,  0.0011937067064604,  0.0052456792020111,
        -0.1612019662117004,  0.0522378610013685, -0.0431773750583578,  0.0233874003813852,  0.0020675606649252,  0.0090857828980905,  0.0011937067064604, -0.0052456792020111,
        // idx = [5,:,:] 
         0.0290017048432364,  0.0522378610013685, -0.0431773750583578, -0.0233874003813852, -0.0020675606649251, -0.0090857828980906,  0.0011937067064604, -0.0052456792020111,
        -0.1612019662117005, -0.0522378610013686, -0.0431773750583578, -0.0233874003813852,  0.0020675606649251,  0.0090857828980906,  0.0011937067064604,  0.0052456792020111,
        -0.1612019662117004, -0.0522378610013685,  0.0431773750583578,  0.0233874003813852,  0.0020675606649251,  0.0090857828980906, -0.0011937067064604,  0.0052456792020111,
         0.0290017048432366,  0.0522378610013686,  0.0431773750583578,  0.0233874003813852, -0.0020675606649252, -0.0090857828980906, -0.0011937067064604, -0.0052456792020111,
         0.0290017048432366,  0.0522378610013686, -0.0431773750583578, -0.0233874003813852, -0.0020675606649251, -0.0090857828980906,  0.0011937067064604, -0.0052456792020111,
        -0.1612019662117002, -0.0522378610013685, -0.0431773750583578, -0.0233874003813852,  0.0020675606649252,  0.0090857828980906,  0.0011937067064604,  0.0052456792020111,
        -0.1612019662117003, -0.0522378610013685,  0.0431773750583578,  0.0233874003813852,  0.0020675606649251,  0.0090857828980905, -0.0011937067064604,  0.0052456792020111,
         0.0290017048432365,  0.0522378610013685,  0.0431773750583578,  0.0233874003813852, -0.0020675606649252, -0.0090857828980906, -0.0011937067064604, -0.0052456792020111,
        // idx = [6,:,:] 
         0.1634960104527577,  0.0216376304961275, -0.1042394044535572, -0.0096873784266195, -0.0049915329982914, -0.0219350202973477,  0.0028818629202325, -0.0021728314693315,
        -0.2956962718212218, -0.0216376304961274, -0.1042394044535572, -0.0096873784266195,  0.0049915329982914,  0.0219350202973478,  0.0028818629202324,  0.0021728314693315,
        -0.2956962718212217, -0.0216376304961274,  0.1042394044535573,  0.0096873784266194,  0.0049915329982914,  0.0219350202973477, -0.0028818629202324,  0.0021728314693315,
         0.163496010452758 ,  0.0216376304961275,  0.1042394044535572,  0.0096873784266195, -0.0049915329982914, -0.0219350202973478, -0.0028818629202325, -0.0021728314693315,
         0.1634960104527581,  0.0216376304961275, -0.1042394044535572, -0.0096873784266195, -0.0049915329982914, -0.0219350202973478,  0.0028818629202324, -0.0021728314693315,
        -0.2956962718212213, -0.0216376304961274, -0.1042394044535572, -0.0096873784266194,  0.0049915329982914,  0.0219350202973477,  0.0028818629202325,  0.0021728314693315,
        -0.2956962718212214, -0.0216376304961274,  0.1042394044535571,  0.0096873784266194,  0.0049915329982914,  0.0219350202973477, -0.0028818629202325,  0.0021728314693315,
         0.1634960104527578,  0.0216376304961275,  0.1042394044535571,  0.0096873784266195, -0.0049915329982914, -0.0219350202973478, -0.0028818629202325, -0.0021728314693315,
        // idx = [7,:,:] 
         0.1634960104527577, -0.0216376304961274, -0.1042394044535572,  0.0096873784266194, -0.0049915329982914, -0.0219350202973477,  0.0028818629202324,  0.0021728314693315,
        -0.2956962718212218,  0.0216376304961274, -0.1042394044535572,  0.0096873784266194,  0.0049915329982914,  0.0219350202973477,  0.0028818629202324, -0.0021728314693315,
        -0.2956962718212217,  0.0216376304961274,  0.1042394044535573, -0.0096873784266195,  0.0049915329982914,  0.0219350202973477, -0.0028818629202325, -0.0021728314693315,
         0.163496010452758 , -0.0216376304961274,  0.1042394044535572, -0.0096873784266195, -0.0049915329982914, -0.0219350202973478, -0.0028818629202324,  0.0021728314693315,
         0.1634960104527581, -0.0216376304961274, -0.1042394044535572,  0.0096873784266195, -0.0049915329982914, -0.0219350202973478,  0.0028818629202324,  0.0021728314693315,
        -0.2956962718212213,  0.0216376304961274, -0.1042394044535572,  0.0096873784266194,  0.0049915329982914,  0.0219350202973477,  0.0028818629202325, -0.0021728314693315,
        -0.2956962718212214,  0.0216376304961275,  0.1042394044535571, -0.0096873784266194,  0.0049915329982914,  0.0219350202973477, -0.0028818629202324, -0.0021728314693315,
         0.1634960104527579, -0.0216376304961274,  0.1042394044535571, -0.0096873784266195, -0.0049915329982914, -0.0219350202973478, -0.0028818629202325,  0.0021728314693315,
        // idx = [8,:,:] 
         0.0290017048432366, -0.0522378610013685, -0.0431773750583578,  0.0233874003813852, -0.0020675606649251, -0.0090857828980906,  0.0011937067064604,  0.0052456792020111,
        -0.1612019662117003,  0.0522378610013686, -0.0431773750583578,  0.0233874003813852,  0.0020675606649251,  0.0090857828980905,  0.0011937067064604, -0.0052456792020111,
        -0.1612019662117004,  0.0522378610013686,  0.0431773750583578, -0.0233874003813852,  0.0020675606649251,  0.0090857828980905, -0.0011937067064604, -0.0052456792020111,
         0.0290017048432366, -0.0522378610013686,  0.0431773750583578, -0.0233874003813852, -0.0020675606649251, -0.0090857828980906, -0.0011937067064604,  0.0052456792020111,
         0.0290017048432366, -0.0522378610013686, -0.0431773750583578,  0.0233874003813852, -0.0020675606649251, -0.0090857828980905,  0.0011937067064604,  0.0052456792020111,
        -0.1612019662117002,  0.0522378610013685, -0.0431773750583578,  0.0233874003813852,  0.0020675606649251,  0.0090857828980905,  0.0011937067064604, -0.0052456792020111,
        -0.1612019662117001,  0.0522378610013685,  0.0431773750583578, -0.0233874003813852,  0.0020675606649252,  0.0090857828980905, -0.0011937067064604, -0.0052456792020111,
         0.0290017048432367, -0.0522378610013685,  0.0431773750583578, -0.0233874003813852, -0.0020675606649251, -0.0090857828980906, -0.0011937067064604,  0.0052456792020111,
      };

      for (int j=0; j<cells[0]; j++) {
        for (int k=0; k<cells[1]; k++) {
          int idx0[] = {j+1,k+1};
          long linidx = gkyl_range_idx(&localRange, idx0);
          const double *phi_p  = gkyl_array_cfetch(phi, linidx);
          for (int m=0; m<basis.num_basis; m++)
            TEST_CHECK( gkyl_compare(sol[(j*cells[1]+k)*basis.num_basis+m], phi_p[m], 1e-13) );
        }
      }
    } else if ((bcs.lo_type[0] == GKYL_POISSON_DIRICHLET && bcs.up_type[0] == GKYL_POISSON_DIRICHLET) &&
               (bcs.lo_type[1] == GKYL_POISSON_DIRICHLET && bcs.up_type[1] == GKYL_POISSON_DIRICHLET)) {
      // Solution with N=8x8 (checked visually against g2):
      const double sol[512] =  {
         2.6174232732491937e-01,  1.4239797833436563e-01,  1.4239797833436832e-01,  7.7179579805168846e-02,
        -6.7537275729821697e-03, -6.7537275729839599e-03, -3.8992664322967728e-03, -3.8992664322957389e-03,
         6.6919163252609326e-01,  3.6607316345625796e-01,  9.5063998582042175e-02,  5.3241649763930039e-02,
        -1.5712542948565170e-02, -5.0333399450111418e-03, -1.2731080364162437e-03, -2.9060001721731323e-03,
         9.3261285108183989e-01,  5.1325052577226526e-01,  5.7325647937301362e-02,  3.1906370575563808e-02,
        -1.9514998592151278e-02, -4.7983776055364200e-03, -9.2224075298976771e-04, -2.7703446022368191e-03,
         1.0655299621633167e+00,  5.8724826482557402e-01,  1.9276481795971526e-02,  1.0736800514482690e-02,
        -2.1638935540251023e-02, -4.9049622075538080e-03, -3.0401481573740646e-04, -2.8318812508899630e-03,
         1.0655299621632919e+00,  5.8724826482559001e-01, -1.9276481795972498e-02, -1.0736800514482097e-02,
        -2.1638935540251442e-02, -4.9049622075435393e-03,  3.0401481573716035e-04, -2.8318812508967037e-03,
         9.3261285108185987e-01,  5.1325052577225294e-01, -5.7325647937297997e-02, -3.1906370575565030e-02,
        -1.9514998592150969e-02, -4.7983776055443399e-03,  9.2224075299046225e-04, -2.7703446022314714e-03,
         6.6919163252608593e-01,  3.6607316345626356e-01, -9.5063998582045450e-02, -5.3241649763928936e-02,
        -1.5712542948564660e-02, -5.0333399450069516e-03,  1.2731080364157396e-03, -2.9060001721759607e-03,
         2.6174232732491853e-01,  1.4239797833436749e-01, -1.4239797833436565e-01, -7.7179579805169193e-02,
        -6.7537275729842071e-03, -6.7537275729832175e-03,  3.8992664322957892e-03, -3.8992664322963833e-03,
                                                         
         6.6919163252608860e-01,  9.5063998582043299e-02,  3.6607316345626245e-01,  5.3241649763930331e-02,
        -5.0333399450085215e-03, -1.5712542948564980e-02, -2.9060001721747195e-03, -1.2731080364161236e-03,
         1.7423637960024951e+00,  2.5663155896155049e-01,  2.5663155896154866e-01,  3.9269506879060945e-02,
        -1.3304720861538796e-02, -1.3304720861538574e-02, -1.8694838265540022e-03, -1.8694838265539328e-03,
         2.4546088336295524e+00,  3.6679544630615818e-01,  1.5482377206845122e-01,  2.4122215546181679e-02,
        -1.8491615532474540e-02, -1.3118456058247477e-02, -1.1251712079690399e-03, -2.0332549321148150e-03,
         2.8136363432486524e+00,  4.2275290286990530e-01,  5.2063204566973317e-02,  8.1141391202817388e-03,
        -2.1072335114916480e-02, -1.3426476507160518e-02, -3.6480793765675186e-04, -2.0880173238912439e-03,
         2.8136363432486537e+00,  4.2275290286990491e-01, -5.2063204566973310e-02, -8.1141391202813763e-03,
        -2.1072335114916688e-02, -1.3426476507161226e-02,  3.6480793765667890e-04, -2.0880173238908744e-03,
         2.4546088336295524e+00,  3.6679544630615885e-01, -1.5482377206845072e-01, -2.4122215546182327e-02,
        -1.8491615532474519e-02, -1.3118456058247010e-02,  1.1251712079692697e-03, -2.0332549321153050e-03,
         1.7423637960024967e+00,  2.5663155896154893e-01, -2.5663155896154982e-01, -3.9269506879060410e-02,
        -1.3304720861538900e-02, -1.3304720861538928e-02,  1.8694838265536735e-03, -1.8694838265537654e-03,
         6.6919163252608960e-01,  9.5063998582044631e-02, -3.6607316345626134e-01, -5.3241649763929144e-02,
        -5.0333399450086984e-03, -1.5712542948565028e-02,  2.9060001721750131e-03, -1.2731080364159649e-03,
                                                         
         9.3261285108185821e-01,  5.7325647937300536e-02,  5.1325052577225561e-01,  3.1906370575564169e-02,
        -4.7983776055438099e-03, -1.9514998592151230e-02, -2.7703446022315403e-03, -9.2224075299001209e-04,
         2.4546088336295533e+00,  1.5482377206845183e-01,  3.6679544630615835e-01,  2.4122215546182144e-02,
        -1.3118456058246767e-02, -1.8491615532474442e-02, -2.0332549321154113e-03, -1.1251712079691368e-03,
         3.4763948230693584e+00,  2.2273928406436586e-01,  2.2273928406436450e-01,  1.4934123050414272e-02,
        -1.8796563154148561e-02, -1.8796563154148616e-02, -1.2450017281910941e-03, -1.2450017281912329e-03,
         3.9932287149419072e+00,  2.5750472735140595e-01,  7.4989196262072150e-02,  5.0536521254173922e-03,
        -2.1676786288648230e-02, -1.9312217015521948e-02, -4.1789587383845390e-04, -1.3101165429915749e-03,
         3.9932287149419086e+00,  2.5750472735140545e-01, -7.4989196262071983e-02, -5.0536521254172656e-03,
        -2.1676786288648255e-02, -1.9312217015521695e-02,  4.1789587383842241e-04, -1.3101165429913715e-03,
         3.4763948230693589e+00,  2.2273928406436555e-01, -2.2273928406436502e-01, -1.4934123050414116e-02,
        -1.8796563154148398e-02, -1.8796563154148620e-02,  1.2450017281912852e-03, -1.2450017281911095e-03,
         2.4546088336295533e+00,  1.5482377206845177e-01, -3.6679544630615835e-01, -2.4122215546182223e-02,
        -1.3118456058247352e-02, -1.8491615532474526e-02,  2.0332549321147712e-03, -1.1251712079691793e-03,
         9.3261285108185132e-01,  5.7325647937300786e-02, -5.1325052577225905e-01, -3.1906370575563767e-02,
        -4.7983776055393265e-03, -1.9514998592151004e-02,  2.7703446022350679e-03, -9.2224075299003714e-04,
                                                         
         1.0655299621633052e+00,  1.9276481795972307e-02,  5.8724826482558445e-01,  1.0736800514482153e-02,
        -4.9049622075479637e-03, -2.1638935540251425e-02, -2.8318812508938205e-03, -3.0401481573739237e-04,
         2.8136363432486573e+00,  5.2063204566973678e-02,  4.2275290286990486e-01,  8.1141391202819435e-03,
        -1.3426476507160865e-02, -2.1072335114916605e-02, -2.0880173238909958e-03, -3.6480793765678097e-04,
         3.9932287149419117e+00,  7.4989196262073218e-02,  2.5750472735140501e-01,  5.0536521254175961e-03,
        -1.9312217015521837e-02, -2.1676786288648508e-02, -1.3101165429915780e-03, -4.1789587383837384e-04,
         4.5910338085415718e+00,  8.6771187773203959e-02,  8.6771187773202516e-02,  1.7165201446688685e-03,
        -2.2348374449956569e-02, -2.2348374449956347e-02, -4.4280976908145239e-04, -4.4280976908120259e-04,
         4.5910338085415709e+00,  8.6771187773204236e-02, -8.6771187773203154e-02, -1.7165201446689129e-03,
        -2.2348374449956444e-02, -2.2348374449956222e-02,  4.4280976908147863e-04, -4.4280976908156743e-04,
         3.9932287149419112e+00,  7.4989196262072899e-02, -2.5750472735140484e-01, -5.0536521254172431e-03,
        -1.9312217015521601e-02, -2.1676786288648216e-02,  1.3101165429916146e-03, -4.1789587383845683e-04,
         2.8136363432486569e+00,  5.2063204566974462e-02, -4.2275290286990519e-01, -8.1141391202814613e-03,
        -1.3426476507160862e-02, -2.1072335114916740e-02,  2.0880173238907941e-03, -3.6480793765674541e-04,
         1.0655299621633052e+00,  1.9276481795971547e-02, -5.8724826482558345e-01, -1.0736800514483537e-02,
        -4.9049622075470175e-03, -2.1638935540251397e-02,  2.8318812508945942e-03, -3.0401481573753619e-04,
                                                         
         1.0655299621633063e+00, -1.9276481795971245e-02,  5.8724826482558301e-01, -1.0736800514483152e-02,
        -4.9049622075477434e-03, -2.1638935540251175e-02, -2.8318812508940469e-03,  3.0401481573758308e-04,
         2.8136363432486582e+00, -5.2063204566973373e-02,  4.2275290286990536e-01, -8.1141391202815983e-03,
        -1.3426476507160983e-02, -2.1072335114916779e-02, -2.0880173238909797e-03,  3.6480793765673988e-04,
         3.9932287149419139e+00, -7.4989196262072108e-02,  2.5750472735140512e-01, -5.0536521254172474e-03,
        -1.9312217015521875e-02, -2.1676786288648268e-02, -1.3101165429914962e-03,  4.1789587383851977e-04,
         4.5910338085415727e+00, -8.6771187773202557e-02,  8.6771187773202446e-02, -1.7165201446689314e-03,
        -2.2348374449956344e-02, -2.2348374449956233e-02, -4.4280976908141136e-04,  4.4280976908124613e-04,
         4.5910338085415727e+00, -8.6771187773202529e-02, -8.6771187773202391e-02,  1.7165201446693544e-03,
        -2.2348374449956278e-02, -2.2348374449956555e-02,  4.4280976908142534e-04,  4.4280976908136983e-04,
         3.9932287149419126e+00, -7.4989196262071872e-02, -2.5750472735140517e-01,  5.0536521254170149e-03,
        -1.9312217015521854e-02, -2.1676786288648248e-02,  1.3101165429914151e-03,  4.1789587383843298e-04,
         2.8136363432486582e+00, -5.2063204566973595e-02, -4.2275290286990508e-01,  8.1141391202819418e-03,
        -1.3426476507160974e-02, -2.1072335114916744e-02,  2.0880173238910457e-03,  3.6480793765674796e-04,
         1.0655299621633081e+00, -1.9276481795971225e-02, -5.8724826482558234e-01,  1.0736800514483131e-02,
        -4.9049622075481589e-03, -2.1638935540251147e-02,  2.8318812508937091e-03,  3.0401481573764412e-04,
                                                         
         9.3261285108185321e-01, -5.7325647937301563e-02,  5.1325052577225927e-01, -3.1906370575562525e-02,
        -4.7983776055409884e-03, -1.9514998592151254e-02, -2.7703446022335596e-03,  9.2224075298971990e-04,
         2.4546088336295560e+00, -1.5482377206845085e-01,  3.6679544630615862e-01, -2.4122215546182140e-02,
        -1.3118456058247080e-02, -1.8491615532474557e-02, -2.0332549321151658e-03,  1.1251712079692422e-03,
         3.4763948230693624e+00, -2.2273928406436483e-01,  2.2273928406436511e-01, -1.4934123050414394e-02,
        -1.8796563154148675e-02, -1.8796563154148675e-02, -1.2450017281912206e-03,  1.2450017281911187e-03,
         3.9932287149419121e+00, -2.5750472735140489e-01,  7.4989196262071955e-02, -5.0536521254169100e-03,
        -2.1676786288648272e-02, -1.9312217015521823e-02, -4.1789587383837356e-04,  1.3101165429915869e-03,
         3.9932287149419126e+00, -2.5750472735140495e-01, -7.4989196262072233e-02,  5.0536521254168848e-03,
        -2.1676786288648046e-02, -1.9312217015521931e-02,  4.1789587383847987e-04,  1.3101165429915452e-03,
         3.4763948230693602e+00, -2.2273928406436530e-01, -2.2273928406436572e-01,  1.4934123050414496e-02,
        -1.8796563154148353e-02, -1.8796563154148491e-02,  1.2450017281911525e-03,  1.2450017281911941e-03,
         2.4546088336295546e+00, -1.5482377206845152e-01, -3.6679544630615801e-01,  2.4122215546182033e-02,
        -1.3118456058246871e-02, -1.8491615532474543e-02,  2.0332549321150865e-03,  1.1251712079691867e-03,
         9.3261285108185477e-01, -5.7325647937301917e-02, -5.1325052577225816e-01,  3.1906370575562865e-02,
        -4.7983776055414186e-03, -1.9514998592151150e-02,  2.7703446022332530e-03,  9.2224075298966764e-04,
                                                         
         6.6919163252609370e-01, -9.5063998582042980e-02,  3.6607316345626079e-01, -5.3241649763930268e-02,
        -5.0333399450108460e-03, -1.5712542948565097e-02, -2.9060001721730780e-03,  1.2731080364163810e-03,
         1.7423637960024991e+00, -2.5663155896154927e-01,  2.5663155896154949e-01, -3.9269506879060855e-02,
        -1.3304720861538463e-02, -1.3304720861538574e-02, -1.8694838265541208e-03,  1.8694838265539426e-03,
         2.4546088336295564e+00, -3.6679544630615801e-01,  1.5482377206845152e-01, -2.4122215546181641e-02,
        -1.8491615532474592e-02, -1.3118456058247055e-02, -1.1251712079691136e-03,  2.0332549321152391e-03,
         2.8136363432486586e+00, -4.2275290286990402e-01,  5.2063204566973983e-02, -8.1141391202815896e-03,
        -2.1072335114916560e-02, -1.3426476507160459e-02, -3.6480793765670513e-04,  2.0880173238911949e-03,
         2.8136363432486595e+00, -4.2275290286990430e-01, -5.2063204566973893e-02,  8.1141391202816000e-03,
        -2.1072335114916605e-02, -1.3426476507160532e-02,  3.6480793765664924e-04,  2.0880173238912525e-03,
         2.4546088336295546e+00, -3.6679544630615796e-01, -1.5482377206845185e-01,  2.4122215546181908e-02,
        -1.8491615532474550e-02, -1.3118456058246793e-02,  1.1251712079692014e-03,  2.0332549321152955e-03,
         1.7423637960024969e+00, -2.5663155896154932e-01, -2.5663155896154966e-01,  3.9269506879060695e-02,
        -1.3304720861538551e-02, -1.3304720861538482e-02,  1.8694838265539764e-03,  1.8694838265539764e-03,
         6.6919163252608993e-01, -9.5063998582043174e-02, -3.6607316345626212e-01,  5.3241649763930261e-02,
        -5.0333399450094582e-03, -1.5712542948565136e-02,  2.9060001721740768e-03,  1.2731080364163491e-03,
                                                         
         2.6174232732492186e-01, -1.4239797833436663e-01,  1.4239797833436729e-01, -7.7179579805168944e-02,
        -6.7537275729839729e-03, -6.7537275729838949e-03, -3.8992664322954887e-03,  3.8992664322955875e-03,
         6.6919163252609237e-01, -3.6607316345626162e-01,  9.5063998582043410e-02, -5.3241649763929769e-02,
        -1.5712542948564848e-02, -5.0333399450092466e-03, -1.2731080364163159e-03,  2.9060001721742711e-03,
         9.3261285108185366e-01, -5.1325052577225982e-01,  5.7325647937300703e-02, -3.1906370575564294e-02,
        -1.9514998592151334e-02, -4.7983776055405469e-03, -9.2224075298996829e-04,  2.7703446022337144e-03,
         1.0655299621633147e+00, -5.8724826482558012e-01,  1.9276481795972494e-02, -1.0736800514482444e-02,
        -2.1638935540251224e-02, -4.9049622075506205e-03, -3.0401481573732217e-04,  2.8318812508918382e-03,
         1.0655299621633119e+00, -5.8724826482558135e-01, -1.9276481795972668e-02,  1.0736800514482532e-02,
        -2.1638935540251137e-02, -4.9049622075495979e-03,  3.0401481573736000e-04,  2.8318812508924367e-03,
         9.3261285108185554e-01, -5.1325052577225794e-01, -5.7325647937301508e-02,  3.1906370575563600e-02,
        -1.9514998592151313e-02, -4.7983776055423831e-03,  9.2224075298983992e-04,  2.7703446022324342e-03,
         6.6919163252608904e-01, -3.6607316345626240e-01, -9.5063998582043160e-02,  5.3241649763930317e-02,
        -1.5712542948565038e-02, -5.0333399450093533e-03,  1.2731080364162960e-03,  2.9060001721740885e-03,
         2.6174232732492109e-01, -1.4239797833436624e-01, -1.4239797833436613e-01,  7.7179579805169332e-02,
        -6.7537275729838767e-03, -6.7537275729839148e-03,  3.8992664322956569e-03,  3.8992664322956318e-03,
      };

      for (int j=0; j<cells[0]; j++) {
        for (int k=0; k<cells[1]; k++) {
          int idx0[] = {j+1,k+1};
          long linidx = gkyl_range_idx(&localRange, idx0);
          const double *phi_p  = gkyl_array_cfetch(phi, linidx);
          for (int m=0; m<basis.num_basis; m++)
            TEST_CHECK( gkyl_compare(sol[(j*cells[1]+k)*basis.num_basis+m], phi_p[m], 1e-13) );
        }
      }
    } else {
    }
  }

  gkyl_fem_poisson_release(poisson);
  gkyl_proj_on_basis_release(projob);
  gkyl_array_release(rho);
  gkyl_array_release(phi);
  gkyl_array_release(perbuff);
}

void test_1x_p1_periodicx() {
  int cells[] = {16}; // MF 2022/05/31: N=8 is broken.
  struct gkyl_poisson_bc bc_tv;
  bc_tv.lo_type[0] = GKYL_POISSON_PERIODIC;
  bc_tv.up_type[0] = GKYL_POISSON_PERIODIC;
  test_1x(1, &cells[0], bc_tv);
}
void test_1x_p1_dirichletx() {
  int cells[] = {16};
  struct gkyl_poisson_bc bc_tv;
  bc_tv.lo_type[0] = GKYL_POISSON_DIRICHLET;
  bc_tv.up_type[0] = GKYL_POISSON_DIRICHLET;
  bc_tv.lo_value[0].v[0] = 0.;
  bc_tv.up_value[0].v[0] = 0.;
  test_1x(1, &cells[0], bc_tv);
}

void test_1x_p2_periodicx() {
  int cells[] = {8};
  struct gkyl_poisson_bc bc_tv;
  bc_tv.lo_type[0] = GKYL_POISSON_PERIODIC;
  bc_tv.up_type[0] = GKYL_POISSON_PERIODIC;
  test_1x(2, &cells[0], bc_tv);
}
void test_1x_p2_dirichletx() {
  int cells[] = {8};
  struct gkyl_poisson_bc bc_tv;
  bc_tv.lo_type[0] = GKYL_POISSON_DIRICHLET;
  bc_tv.up_type[0] = GKYL_POISSON_DIRICHLET;
  bc_tv.lo_value[0].v[0] = 0.;
  bc_tv.up_value[0].v[0] = 0.;
  test_1x(2, &cells[0], bc_tv);
}

void test_2x_p1_periodicx_periodicy() {
  int cells[] = {8,8};
  struct gkyl_poisson_bc bc_tv;
  bc_tv.lo_type[0] = GKYL_POISSON_PERIODIC;
  bc_tv.up_type[0] = GKYL_POISSON_PERIODIC;
  bc_tv.lo_type[1] = GKYL_POISSON_PERIODIC;
  bc_tv.up_type[1] = GKYL_POISSON_PERIODIC;
  test_2x(1, &cells[0], bc_tv);
}
void test_2x_p1_dirichletx_dirichlety() {
  int cells[] = {8,8};
  struct gkyl_poisson_bc bc_tv;
  bc_tv.lo_type[0] = GKYL_POISSON_DIRICHLET;
  bc_tv.up_type[0] = GKYL_POISSON_DIRICHLET;
  bc_tv.lo_type[1] = GKYL_POISSON_DIRICHLET;
  bc_tv.up_type[1] = GKYL_POISSON_DIRICHLET;
  bc_tv.lo_value[0].v[0] = 0.;
  bc_tv.up_value[0].v[0] = 0.;
  bc_tv.lo_value[1].v[0] = 0.;
  bc_tv.up_value[1].v[0] = 0.;
  test_2x(1, &cells[0], bc_tv);
}
void test_2x_p2_periodicx_periodicy() {
  int cells[] = {8,8};
  struct gkyl_poisson_bc bc_tv;
  bc_tv.lo_type[0] = GKYL_POISSON_PERIODIC;
  bc_tv.up_type[0] = GKYL_POISSON_PERIODIC;
  bc_tv.lo_type[1] = GKYL_POISSON_PERIODIC;
  bc_tv.up_type[1] = GKYL_POISSON_PERIODIC;
  test_2x(2, &cells[0], bc_tv);
}
void test_2x_p2_dirichletx_dirichlety() {
  int cells[] = {8,8};
  struct gkyl_poisson_bc bc_tv;
  bc_tv.lo_type[0] = GKYL_POISSON_DIRICHLET;
  bc_tv.up_type[0] = GKYL_POISSON_DIRICHLET;
  bc_tv.lo_type[1] = GKYL_POISSON_DIRICHLET;
  bc_tv.up_type[1] = GKYL_POISSON_DIRICHLET;
  bc_tv.lo_value[0].v[0] = 0.;
  bc_tv.up_value[0].v[0] = 0.;
  bc_tv.lo_value[1].v[0] = 0.;
  bc_tv.up_value[1].v[0] = 0.;
  test_2x(2, &cells[0], bc_tv);
}


TEST_LIST = {
  { "test_1x_p1_periodicx", test_1x_p1_periodicx },
  { "test_1x_p1_dirichletx", test_1x_p1_dirichletx },
  { "test_1x_p2_periodicx", test_1x_p2_periodicx },
  { "test_1x_p2_dirichletx", test_1x_p2_dirichletx },
  { "test_2x_p1_periodicx_periodicy", test_2x_p1_periodicx_periodicy },
//  { "test_2x_p1_dirichletx_periodicy", test_2x_p1_dirichletx_periodicy },
//  { "test_2x_p1_periodicx_dirichlety", test_2x_p1_periodicx_dirichlety },
  { "test_2x_p2_periodicx_periodicy", test_2x_p2_periodicx_periodicy },
  { "test_2x_p1_dirichletx_dirichlety", test_2x_p1_dirichletx_dirichlety },
  { "test_2x_p2_dirichletx_dirichlety", test_2x_p2_dirichletx_dirichlety },
  { NULL, NULL },
};
