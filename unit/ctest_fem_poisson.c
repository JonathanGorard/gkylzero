// Test the FEM Poisson solver.
//
#include <acutest.h>

#include <gkyl_proj_on_basis.h>
#include <gkyl_range.h>
#include <gkyl_rect_decomp.h>
#include <gkyl_rect_grid.h>
#include <gkyl_array_rio.h>
#include <gkyl_fem_poisson.h>

void evalFunc1x_periodicx_periodicx(double t, const double *xn, double* restrict fout, void *ctx)
{
  double x = xn[0];
  fout[0] = sin((2.*M_PI/(2.*M_PI))*x);
}
void evalFunc1x_dirichletx_dirichletx(double t, const double *xn, double* restrict fout, void *ctx)
{
  double x = xn[0];
  double a = 2.0;
  double c0 = a/12. - 1./2.;
  double c1 = 0.;
  fout[0] = -(1.-a*pow(x,2));
}

void evalFunc2x(double t, const double *xn, double* restrict fout, void *ctx)
{
  double x = xn[0], y = xn[1];
  fout[0] = sin((2.*M_PI/(2.*M_PI))*x)*cos((2.*2.*M_PI/(2.*M_PI))*y);
}

// allocate array (filled with zeros)
static struct gkyl_array*
mkarr(long nc, long size)
{
  struct gkyl_array* a = gkyl_array_new(GKYL_DOUBLE, nc, size);
  return a;
}

struct skin_ghost_ranges {
  struct gkyl_range lower_skin[GKYL_MAX_DIM];
  struct gkyl_range lower_ghost[GKYL_MAX_DIM];

  struct gkyl_range upper_skin[GKYL_MAX_DIM];
  struct gkyl_range upper_ghost[GKYL_MAX_DIM];
};

// Create ghost and skin sub-ranges given a parent range
static void
skin_ghost_ranges_init(struct skin_ghost_ranges *sgr,
  const struct gkyl_range *parent, const int *ghost)
{
  int ndim = parent->ndim;

  for (int d=0; d<ndim; ++d) {
    gkyl_skin_ghost_ranges(&sgr->lower_skin[d], &sgr->lower_ghost[d],
      d, GKYL_LOWER_EDGE, parent, ghost);
    gkyl_skin_ghost_ranges(&sgr->upper_skin[d], &sgr->upper_ghost[d],
      d, GKYL_UPPER_EDGE, parent, ghost);
  }
}

// Apply periodic BCs in one direction.
void
apply_periodic_bc(struct gkyl_array *buff, struct gkyl_array *fld, const int dir, const struct skin_ghost_ranges sgr)
{
  gkyl_array_copy_to_buffer(buff->data, fld, sgr.lower_skin[dir]);
  gkyl_array_copy_from_buffer(fld, buff->data, sgr.upper_ghost[dir]);

  gkyl_array_copy_to_buffer(buff->data, fld, sgr.upper_skin[dir]);
  gkyl_array_copy_from_buffer(fld, buff->data, sgr.lower_ghost[dir]);
}

void
test_1x(int poly_order, const int *cells, struct gkyl_poisson_bc bcs)
{
  double epsilon_0 = 1.0;
  double lower[] = {0.0}, upper[] = {1.0};
  if (bcs.lo_type[0] == GKYL_POISSON_PERIODIC) {
    lower[0] = -M_PI;
    upper[0] =  M_PI;
  }
  int dim = sizeof(lower)/sizeof(lower[0]);

  // grids.
  struct gkyl_rect_grid grid;
  gkyl_rect_grid_init(&grid, dim, lower, upper, cells);

  // basis functions.
  struct gkyl_basis basis;
  gkyl_cart_modal_serendip(&basis, dim, poly_order);

  int ghost[] = { 1 };
  struct gkyl_range localRange, localRange_ext; // local, local-ext ranges.
  gkyl_create_grid_ranges(&grid, ghost, &localRange_ext, &localRange);
  struct skin_ghost_ranges skin_ghost; // skin/ghost.
  skin_ghost_ranges_init(&skin_ghost, &localRange_ext, ghost);

  // projection updater for DG field.
  gkyl_proj_on_basis *projob;
  if (bcs.lo_type[0] == GKYL_POISSON_PERIODIC) {
    projob = gkyl_proj_on_basis_new(&grid, &basis,
      poly_order+1, 1, evalFunc1x_periodicx_periodicx, NULL);
  } else if (bcs.lo_type[0]==GKYL_POISSON_DIRICHLET && bcs.up_type[0]==GKYL_POISSON_DIRICHLET) {
    projob = gkyl_proj_on_basis_new(&grid, &basis,
      poly_order+1, 1, evalFunc1x_dirichletx_dirichletx, NULL);
  }

  // create DG field we wish to make continuous.
  struct gkyl_array *rho = mkarr(basis.num_basis, localRange_ext.volume);
  // create array holding continuous field we'll compute.
  struct gkyl_array *phi = mkarr(basis.num_basis, localRange_ext.volume);

  // project distribution function on basis.
  gkyl_proj_on_basis_advance(projob, 0.0, &localRange, rho);
  struct gkyl_array *perbuff = mkarr(basis.num_basis, skin_ghost.lower_skin[dim-1].volume);
  for (int d=0; d<dim; d++)
    if (bcs.lo_type[d] == GKYL_POISSON_PERIODIC) apply_periodic_bc(perbuff, rho, d, skin_ghost);
  gkyl_grid_sub_array_write(&grid, &localRange, rho, "ctest_fem_poisson_1x_rho_1.gkyl");

  // FEM poisson solver.
  gkyl_fem_poisson *poisson = gkyl_fem_poisson_new(&grid, basis, bcs, epsilon_0, NULL);

  // Set the RHS source.
  gkyl_fem_poisson_set_rhs(poisson, rho);

  // Solve the problem.
  gkyl_fem_poisson_solve(poisson, phi);
  for (int d=0; d<dim; d++)
    if (bcs.lo_type[d] == GKYL_POISSON_PERIODIC) apply_periodic_bc(perbuff, phi, d, skin_ghost);
  gkyl_grid_sub_array_write(&grid, &localRange, phi, "ctest_fem_poisson_1x_phi_1.gkyl");

  if (poly_order == 1) {
    if (bcs.lo_type[0] == GKYL_POISSON_PERIODIC) {
      // Solution with N=16 (checked visually against g2):
      const double sol[32] = {
         0.6024058953991888, -0.1562324583525289,
         0.1023975701639015, -0.1324474828191181,
        -0.2802922340604182, -0.0884985786659181,
        -0.4874024636723316, -0.0310765681524454,
        -0.4874024636723317,  0.0310765681524453,
        -0.2802922340604183,  0.088498578665918 ,
         0.1023975701639012,  0.132447482819118 ,
         0.6024058953991883,  0.1562324583525289,
         1.1436110067151257,  0.1562324583525289,
         1.6436193319504129,  0.1324474828191181,
         2.0263091361747327,  0.0884985786659181,
         2.2334193657866463,  0.0310765681524454,
         2.2334193657866463, -0.0310765681524453,
         2.026309136174733 , -0.0884985786659181,
         1.6436193319504133, -0.1324474828191181,
         1.1436110067151262, -0.156232458352529 ,
      };

      for (int k=0; k<cells[0]; k++) {
        long linidx;
        const double *phi_p;
        int idx0[] = {k+1};
        linidx = gkyl_range_idx(&localRange, idx0);
        phi_p  = gkyl_array_cfetch(phi, linidx);
        for (int m=0; m<basis.num_basis; m++)
          TEST_CHECK( gkyl_compare(sol[k*basis.num_basis+m], phi_p[m], 1e-14) );
      }
    } else if (bcs.lo_type[0]==GKYL_POISSON_DIRICHLET && bcs.up_type[0]==GKYL_POISSON_DIRICHLET) {
      // Solution with N=16 (checked visually against g2):
      const double sol[32] = {
        -0.0133521216082515, -0.0077088510047765,
        -0.0373194046782545, -0.0061286663274337,
        -0.0558775050145713, -0.0045858578973869,
        -0.0691990561087026, -0.0031053432128332,
        -0.0775430081978993, -0.0017120397719699,
        -0.0812546282651626, -0.0004308650729942,
        -0.0807655000392442,  0.0007132633858965,
        -0.0765935239946458,  0.0016954281065051,
        -0.0693429173516197,  0.0024907115906342,
        -0.0597042140761683,  0.0030741963400866,
        -0.0484542648800444,  0.0034209648566651,
        -0.0364562372207511,  0.0035060996421724,
        -0.024659615301542 ,  0.0033046831984112,
        -0.0141002000714206,  0.0027917980271844,
        -0.0059001092251411,  0.0019425266302945,
        -0.0012677772032077,  0.0007319515095444,
      };

      for (int k=0; k<cells[0]; k++) {
        long linidx;
        const double *phi_p;
        int idx0[] = {k+1};
        linidx = gkyl_range_idx(&localRange, idx0);
        phi_p  = gkyl_array_cfetch(phi, linidx);
        for (int m=0; m<basis.num_basis; m++)
          TEST_CHECK( gkyl_compare(sol[k*basis.num_basis+m], phi_p[m], 1e-13) );
      }
    } else {
    }
  } if (poly_order == 2) {
    if (bcs.lo_type[0] == GKYL_POISSON_PERIODIC) {
      // Solution with N=8 (checked visually against g2):
      const double sol[24] =  {
//        -0.5518265272752512, -0.2886749615022944,  0.0122509823232911,
//        -1.2976738921895112, -0.1195730841717814,  0.0295764876772823,
//        -1.2976738921895112,  0.1195730841717815,  0.0295764876772824,
//        -0.5518265272752506,  0.2886749615022945,  0.0122509823232911,
//         0.5029609316467314,  0.2886749615022944, -0.0122509823232911,
//         1.2488082965609912,  0.1195730841717812, -0.0295764876772823,
//         1.2488082965609906, -0.1195730841717816, -0.0295764876772824,
//         0.5029609316467303, -0.2886749615022944, -0.0122509823232911,
        -0.5464696577208076, -0.2886749615022944,  0.0122509823232911,
        -1.2923170226350675, -0.1195730841717814,  0.0295764876772824,
        -1.2923170226350678,  0.1195730841717814,  0.0295764876772824,
        -0.5464696577208071,  0.2886749615022945,  0.0122509823232911,
         0.5083178012011744,  0.2886749615022943, -0.0122509823232911,
         1.254165166115434 ,  0.1195730841717813, -0.0295764876772823,
         1.254165166115434 , -0.1195730841717814, -0.0295764876772824,
         0.5083178012011739, -0.2886749615022944, -0.0122509823232911,
      };

      for (int k=0; k<cells[0]; k++) {
        long linidx;
        const double *phi_p;
        int idx0[] = {k+1};
        linidx = gkyl_range_idx(&localRange, idx0);
        phi_p  = gkyl_array_cfetch(phi, linidx);
        for (int m=0; m<basis.num_basis; m++)
          TEST_CHECK( gkyl_compare(sol[k*basis.num_basis+m], phi_p[m], 1e-14) );
      }
    } else {
    }
  }

  gkyl_fem_poisson_release(poisson);
  gkyl_proj_on_basis_release(projob);
  gkyl_array_release(rho);
  gkyl_array_release(phi);
  gkyl_array_release(perbuff);
}

void
test_2x(int poly_order, const int *cells, struct gkyl_poisson_bc bcs)
{
  double epsilon_0 = 1.0;
  double lower[] = {-M_PI,-M_PI}, upper[] = {M_PI,M_PI};
  int dim = sizeof(lower)/sizeof(lower[0]);

  // grids.
  struct gkyl_rect_grid grid;
  gkyl_rect_grid_init(&grid, dim, lower, upper, cells);

  // basis functions.
  struct gkyl_basis basis;
  gkyl_cart_modal_serendip(&basis, dim, poly_order);

  int ghost[] = { 1, 1 };
  struct gkyl_range localRange, localRange_ext; // local, local-ext ranges.
  gkyl_create_grid_ranges(&grid, ghost, &localRange_ext, &localRange);
  struct skin_ghost_ranges skin_ghost; // skin/ghost.
  skin_ghost_ranges_init(&skin_ghost, &localRange_ext, ghost);

  // projection updater for DG field.
  gkyl_proj_on_basis *projob = gkyl_proj_on_basis_new(&grid, &basis,
    poly_order+1, 1, evalFunc2x, NULL);

  // create DG field we wish to make continuous.
  struct gkyl_array *rho = mkarr(basis.num_basis, localRange_ext.volume);
  // create array holding continuous field we'll compute.
  struct gkyl_array *phi = mkarr(basis.num_basis, localRange_ext.volume);

  // project distribution function on basis.
  gkyl_proj_on_basis_advance(projob, 0.0, &localRange, rho);
  struct gkyl_array *perbuff = mkarr(basis.num_basis, skin_ghost.lower_skin[dim-1].volume);
  for (int d=0; d<dim; d++)
    if (bcs.lo_type[d] == GKYL_POISSON_PERIODIC) apply_periodic_bc(perbuff, rho, d, skin_ghost);
  gkyl_grid_sub_array_write(&grid, &localRange, rho, "ctest_fem_poisson_2x_rho_1.gkyl");

  // FEM poisson solver.
  gkyl_fem_poisson *poisson = gkyl_fem_poisson_new(&grid, basis, bcs, epsilon_0, NULL);

  // Set the RHS source.
  gkyl_fem_poisson_set_rhs(poisson, rho);

  // Solve the problem.
  gkyl_fem_poisson_solve(poisson, phi);
  for (int d=0; d<dim; d++)
    if (bcs.lo_type[d] == GKYL_POISSON_PERIODIC) apply_periodic_bc(perbuff, phi, d, skin_ghost);
  gkyl_grid_sub_array_write(&grid, &localRange, phi, "ctest_fem_poisson_2x_phi_1.gkyl");

  if (poly_order == 1) {
    if (bcs.lo_type[0] == GKYL_POISSON_PERIODIC && bcs.lo_type[1] == GKYL_POISSON_PERIODIC) {
      // Solution with N=8x8 (checked visually against g2):
      const double sol[256] = {
//        // idx = [1,:,:]
//        -3.5768619580288994, -0.0443762721584259,  0.0443762721584259,  0.0256206526762995,
//        -3.4231380419711037,  0.0443762721584263,  0.0443762721584262,  0.0256206526762994,
//        -3.423138041971103 ,  0.0443762721584263, -0.044376272158426 , -0.0256206526762994,
//        -3.5768619580289   , -0.0443762721584258, -0.0443762721584262, -0.0256206526762994,
//        -3.5768619580289   , -0.044376272158426 ,  0.0443762721584262,  0.0256206526762994,
//        -3.423138041971103 ,  0.0443762721584261,  0.0443762721584263,  0.0256206526762994,
//        -3.423138041971102 ,  0.0443762721584259, -0.0443762721584261, -0.0256206526762995,
//        -3.576861958028899 , -0.0443762721584263, -0.0443762721584263, -0.0256206526762993,
//        // idx = [2,:,:]
//        -3.6855611815039184, -0.0183812537755795,  0.1071337980924317,  0.0106124218153737,
//        -3.314438818496084 ,  0.0183812537755796,  0.1071337980924318,  0.0106124218153737,
//        -3.314438818496084 ,  0.0183812537755794, -0.1071337980924318, -0.0106124218153738,
//        -3.685561181503919 , -0.0183812537755797, -0.1071337980924316, -0.0106124218153736,
//        -3.6855611815039184, -0.0183812537755795,  0.107133798092432 ,  0.0106124218153738,
//        -3.3144388184960833,  0.0183812537755796,  0.1071337980924316,  0.0106124218153736,
//        -3.3144388184960833,  0.0183812537755795, -0.1071337980924317, -0.0106124218153736,
//        -3.6855611815039184, -0.0183812537755795, -0.1071337980924319, -0.0106124218153737,
//        // idx = [3,:,:]
//        -3.6855611815039184,  0.0183812537755796,  0.1071337980924317, -0.0106124218153737,
//        -3.314438818496084 , -0.0183812537755796,  0.1071337980924316, -0.0106124218153737,
//        -3.3144388184960842, -0.0183812537755796, -0.1071337980924319,  0.0106124218153737,
//        -3.6855611815039193,  0.0183812537755795, -0.1071337980924316,  0.0106124218153737,
//        -3.6855611815039184,  0.0183812537755794,  0.1071337980924317, -0.0106124218153738,
//        -3.3144388184960833, -0.0183812537755797,  0.1071337980924317, -0.0106124218153736,
//        -3.3144388184960833, -0.0183812537755794, -0.1071337980924313,  0.0106124218153738,
//        -3.685561181503918 ,  0.0183812537755798, -0.1071337980924321,  0.0106124218153736,
//        // idx = [4,:,:]
//        -3.576861958028899 ,  0.0443762721584259,  0.044376272158426 , -0.0256206526762993,
//        -3.4231380419711033, -0.0443762721584259,  0.044376272158426 , -0.0256206526762993,
//        -3.4231380419711037, -0.044376272158426 , -0.0443762721584263,  0.0256206526762994,
//        -3.5768619580289003,  0.044376272158426 , -0.044376272158426 ,  0.0256206526762993,
//        -3.5768619580289   ,  0.0443762721584259,  0.0443762721584261, -0.0256206526762994,
//        -3.423138041971103 , -0.0443762721584261,  0.0443762721584264, -0.0256206526762992,
//        -3.423138041971102 , -0.0443762721584261, -0.0443762721584258,  0.0256206526762992,
//        -3.576861958028899 ,  0.0443762721584258, -0.0443762721584265,  0.0256206526762995,
//        // idx = [5,:,:]
//        -3.423138041971103 ,  0.0443762721584262, -0.0443762721584261, -0.0256206526762995,
//        -3.576861958028899 , -0.0443762721584258, -0.0443762721584259, -0.0256206526762992,
//        -3.5768619580288994, -0.0443762721584259,  0.0443762721584257,  0.0256206526762993,
//        -3.423138041971104 ,  0.044376272158426 ,  0.044376272158426 ,  0.0256206526762994,
//        -3.423138041971104 ,  0.0443762721584261, -0.0443762721584259, -0.0256206526762993,
//        -3.576861958028899 , -0.0443762721584259, -0.0443762721584256, -0.0256206526762994,
//        -3.576861958028899 , -0.044376272158426 ,  0.0443762721584259,  0.0256206526762993,
//        -3.423138041971103 ,  0.0443762721584262,  0.044376272158426 ,  0.0256206526762995,
//        // idx = [6,:,:]
//        -3.314438818496084 ,  0.0183812537755793, -0.107133798092432 , -0.0106124218153737,
//        -3.6855611815039184, -0.0183812537755797, -0.1071337980924315, -0.0106124218153737,
//        -3.6855611815039184, -0.0183812537755798,  0.1071337980924311,  0.0106124218153737,
//        -3.314438818496085 ,  0.0183812537755796,  0.1071337980924317,  0.0106124218153738,
//        -3.3144388184960842,  0.0183812537755799, -0.1071337980924314, -0.0106124218153737,
//        -3.6855611815039175, -0.0183812537755795, -0.1071337980924316, -0.0106124218153738,
//        -3.6855611815039175, -0.0183812537755795,  0.1071337980924316,  0.0106124218153737,
//        -3.314438818496083 ,  0.0183812537755797,  0.1071337980924317,  0.0106124218153736,
//        // idx = [7,:,:]
//        -3.3144388184960847, -0.0183812537755799, -0.1071337980924321,  0.0106124218153737,
//        -3.6855611815039198,  0.0183812537755791, -0.1071337980924315,  0.0106124218153737,
//        -3.6855611815039198,  0.0183812537755795,  0.1071337980924316, -0.0106124218153735,
//        -3.3144388184960847, -0.0183812537755795,  0.1071337980924318, -0.0106124218153738,
//        -3.3144388184960842, -0.0183812537755797, -0.1071337980924313,  0.0106124218153737,
//        -3.6855611815039175,  0.0183812537755797, -0.1071337980924314,  0.0106124218153738,
//        -3.685561181503917 ,  0.0183812537755798,  0.1071337980924316, -0.0106124218153738,
//        -3.3144388184960833, -0.0183812537755797,  0.1071337980924313, -0.0106124218153738,
//        // idx = [8,:,:]
//        -3.4231380419711037, -0.0443762721584257, -0.0443762721584263,  0.0256206526762994,
//        -3.5768619580289007,  0.0443762721584264, -0.0443762721584261,  0.0256206526762993,
//        -3.5768619580289003,  0.0443762721584262,  0.0443762721584262, -0.0256206526762995,
//        -3.4231380419711037, -0.0443762721584261,  0.0443762721584261, -0.0256206526762994,
//        -3.4231380419711033, -0.0443762721584261, -0.0443762721584257,  0.0256206526762994,
//        -3.576861958028898 ,  0.0443762721584258, -0.0443762721584256,  0.0256206526762993,
//        -3.576861958028898 ,  0.0443762721584257,  0.0443762721584259, -0.0256206526762993,
//        -3.423138041971103 , -0.044376272158426 ,  0.0443762721584256, -0.0256206526762993,
//        // idx = [1,:,:]
//        -0.1183643068058982, -0.0443762721584261,  0.0443762721584261,  0.0256206526762994,
//         0.0353596092518981,  0.0443762721584261,  0.044376272158426 ,  0.0256206526762994,
//         0.035359609251898 ,  0.0443762721584261, -0.0443762721584261, -0.0256206526762994,
//        -0.1183643068058982, -0.0443762721584261, -0.044376272158426 , -0.0256206526762994,
//        -0.1183643068058982, -0.0443762721584261,  0.0443762721584261,  0.0256206526762994,
//         0.0353596092518982,  0.0443762721584261,  0.0443762721584261,  0.0256206526762994,
//         0.0353596092518982,  0.0443762721584261, -0.0443762721584261, -0.0256206526762994,
//        -0.1183643068058981, -0.0443762721584261, -0.0443762721584261, -0.0256206526762994,
//        // idx = [2,:,:]
//        -0.2270635302809174, -0.0183812537755796,  0.1071337980924318,  0.0106124218153737,
//         0.1440588327269174,  0.0183812537755797,  0.1071337980924317,  0.0106124218153737,
//         0.1440588327269174,  0.0183812537755796, -0.1071337980924318, -0.0106124218153737,
//        -0.2270635302809176, -0.0183812537755797, -0.1071337980924317, -0.0106124218153737,
//        -0.2270635302809175, -0.0183812537755796,  0.1071337980924318,  0.0106124218153737,
//         0.1440588327269176,  0.0183812537755797,  0.1071337980924318,  0.0106124218153737,
//         0.1440588327269177,  0.0183812537755797, -0.1071337980924318, -0.0106124218153737,
//        -0.2270635302809174, -0.0183812537755796, -0.1071337980924318, -0.0106124218153737,
//        // idx = [3,:,:]
//        -0.2270635302809174,  0.0183812537755796,  0.1071337980924317, -0.0106124218153737,
//         0.1440588327269174, -0.0183812537755797,  0.1071337980924317, -0.0106124218153737,
//         0.1440588327269173, -0.0183812537755797, -0.1071337980924318,  0.0106124218153738,
//        -0.2270635302809176,  0.0183812537755797, -0.1071337980924318,  0.0106124218153737,
//        -0.2270635302809175,  0.0183812537755796,  0.1071337980924318, -0.0106124218153737,
//         0.1440588327269176, -0.0183812537755797,  0.1071337980924318, -0.0106124218153738,
//         0.1440588327269176, -0.0183812537755797, -0.1071337980924318,  0.0106124218153737,
//        -0.2270635302809174,  0.0183812537755796, -0.1071337980924318,  0.0106124218153737,
//        // idx = [4,:,:]
//        -0.1183643068058982,  0.0443762721584261,  0.0443762721584261, -0.0256206526762994,
//         0.035359609251898 , -0.0443762721584261,  0.044376272158426 , -0.0256206526762994,
//         0.035359609251898 , -0.0443762721584261, -0.0443762721584261,  0.0256206526762994,
//        -0.1183643068058982,  0.0443762721584261, -0.0443762721584261,  0.0256206526762994,
//        -0.1183643068058982,  0.0443762721584261,  0.0443762721584261, -0.0256206526762994,
//         0.0353596092518981, -0.0443762721584261,  0.0443762721584261, -0.0256206526762994,
//         0.0353596092518982, -0.0443762721584261, -0.0443762721584261,  0.0256206526762994,
//        -0.1183643068058981,  0.044376272158426 , -0.0443762721584261,  0.0256206526762994,
//        // idx = [5,:,:]
//         0.035359609251898 ,  0.044376272158426 , -0.0443762721584261, -0.0256206526762994,
//        -0.1183643068058983, -0.0443762721584261, -0.0443762721584261, -0.0256206526762994,
//        -0.1183643068058982, -0.0443762721584261,  0.0443762721584261,  0.0256206526762994,
//         0.0353596092518981,  0.0443762721584261,  0.0443762721584261,  0.0256206526762994,
//         0.0353596092518981,  0.0443762721584261, -0.0443762721584261, -0.0256206526762994,
//        -0.1183643068058982, -0.0443762721584261, -0.0443762721584261, -0.0256206526762994,
//        -0.1183643068058982, -0.0443762721584261,  0.0443762721584261,  0.0256206526762994,
//         0.0353596092518981,  0.044376272158426 ,  0.0443762721584261,  0.0256206526762994,
//        // idx = [6,:,:]
//         0.1440588327269174,  0.0183812537755797, -0.1071337980924318, -0.0106124218153738,
//        -0.2270635302809176, -0.0183812537755797, -0.1071337980924317, -0.0106124218153737,
//        -0.2270635302809176, -0.0183812537755797,  0.1071337980924318,  0.0106124218153737,
//         0.1440588327269174,  0.0183812537755796,  0.1071337980924318,  0.0106124218153737,
//         0.1440588327269174,  0.0183812537755796, -0.1071337980924318, -0.0106124218153737,
//        -0.2270635302809175, -0.0183812537755796, -0.1071337980924318, -0.0106124218153737,
//        -0.2270635302809176, -0.0183812537755796,  0.1071337980924318,  0.0106124218153737,
//         0.1440588327269174,  0.0183812537755797,  0.1071337980924318,  0.0106124218153737,
//        // idx = [7,:,:]
//         0.1440588327269174, -0.0183812537755796, -0.1071337980924318,  0.0106124218153737,
//        -0.2270635302809177,  0.0183812537755796, -0.1071337980924318,  0.0106124218153737,
//        -0.2270635302809176,  0.0183812537755796,  0.1071337980924318, -0.0106124218153737,
//         0.1440588327269174, -0.0183812537755796,  0.1071337980924318, -0.0106124218153737,
//         0.1440588327269174, -0.0183812537755796, -0.1071337980924317,  0.0106124218153737,
//        -0.2270635302809174,  0.0183812537755797, -0.1071337980924318,  0.0106124218153738,
//        -0.2270635302809175,  0.0183812537755797,  0.1071337980924317, -0.0106124218153737,
//         0.1440588327269174, -0.0183812537755796,  0.1071337980924318, -0.0106124218153737,
//        // idx = [8,:,:]
//         0.0353596092518981, -0.0443762721584261, -0.0443762721584261,  0.0256206526762994,
//        -0.1183643068058983,  0.0443762721584261, -0.0443762721584261,  0.0256206526762994,
//        -0.1183643068058984,  0.0443762721584261,  0.0443762721584261, -0.0256206526762994,
//         0.0353596092518981, -0.0443762721584261,  0.0443762721584261, -0.0256206526762994,
//         0.0353596092518981, -0.0443762721584261, -0.0443762721584261,  0.0256206526762994,
//        -0.1183643068058981,  0.044376272158426 , -0.044376272158426 ,  0.0256206526762994,
//        -0.1183643068058981,  0.0443762721584261,  0.044376272158426 , -0.0256206526762994,
//         0.0353596092518982, -0.0443762721584261,  0.0443762721584261, -0.0256206526762994,
        // idx = [1,:,:]
        -0.1072531956947871, -0.0443762721584261,  0.044376272158426 , 0.0256206526762994 ,
         0.046470720363009 ,  0.0443762721584261,  0.044376272158426 , 0.0256206526762994 ,
         0.046470720363009 ,  0.044376272158426 , -0.0443762721584261, -0.0256206526762994,
        -0.1072531956947872, -0.0443762721584261, -0.0443762721584261, -0.0256206526762994,
        -0.1072531956947871, -0.0443762721584261,  0.0443762721584261,  0.0256206526762994,
         0.0464707203630092,  0.0443762721584261,  0.0443762721584261,  0.0256206526762994,
         0.0464707203630093,  0.0443762721584261, -0.0443762721584261, -0.0256206526762994,
        -0.1072531956947871, -0.0443762721584261, -0.0443762721584261, -0.0256206526762994,
        // idx = [2,:,:]                                                                   
        -0.2159524191698064, -0.0183812537755796,  0.1071337980924318,  0.0106124218153737,
         0.1551699438380284,  0.0183812537755797,  0.1071337980924317,  0.0106124218153737,
         0.1551699438380283,  0.0183812537755797, -0.1071337980924318, -0.0106124218153737,
        -0.2159524191698066, -0.0183812537755796, -0.1071337980924318, -0.0106124218153737,
        -0.2159524191698065, -0.0183812537755796,  0.1071337980924318,  0.0106124218153737,
         0.1551699438380286,  0.0183812537755797,  0.1071337980924318,  0.0106124218153737,
         0.1551699438380287,  0.0183812537755797, -0.1071337980924318, -0.0106124218153737,
        -0.2159524191698063, -0.0183812537755796, -0.1071337980924318, -0.0106124218153737,
        // idx = [3,:,:]                                                                   
        -0.2159524191698064,  0.0183812537755796,  0.1071337980924318, -0.0106124218153737,
         0.1551699438380285, -0.0183812537755796,  0.1071337980924317, -0.0106124218153737,
         0.1551699438380284, -0.0183812537755796, -0.1071337980924318,  0.0106124218153737,
        -0.2159524191698065,  0.0183812537755797, -0.1071337980924318,  0.0106124218153737,
        -0.2159524191698064,  0.0183812537755797,  0.1071337980924318, -0.0106124218153737,
         0.1551699438380286, -0.0183812537755797,  0.1071337980924318, -0.0106124218153737,
         0.1551699438380287, -0.0183812537755797, -0.1071337980924318,  0.0106124218153737,
        -0.2159524191698063,  0.0183812537755796, -0.1071337980924318,  0.0106124218153737,
        // idx = [4,:,:]                                                                   
        -0.1072531956947871,  0.044376272158426 ,  0.0443762721584261, -0.0256206526762994,
         0.0464707203630091, -0.0443762721584261,  0.0443762721584261, -0.0256206526762994,
         0.0464707203630091, -0.0443762721584261, -0.0443762721584261,  0.0256206526762994,
        -0.1072531956947871,  0.0443762721584261, -0.044376272158426 ,  0.0256206526762994,
        -0.1072531956947871,  0.0443762721584261,  0.0443762721584261, -0.0256206526762994,
         0.0464707203630092, -0.0443762721584261,  0.0443762721584261, -0.0256206526762994,
         0.0464707203630092, -0.0443762721584261, -0.0443762721584261,  0.0256206526762994,
        -0.1072531956947871,  0.044376272158426 , -0.0443762721584261,  0.0256206526762994,
        // idx = [5,:,:]                                                                   
         0.0464707203630091,  0.044376272158426 , -0.0443762721584261, -0.0256206526762994,
        -0.1072531956947872, -0.0443762721584261, -0.0443762721584261, -0.0256206526762994,
        -0.1072531956947871, -0.0443762721584261,  0.0443762721584261,  0.0256206526762994,
         0.0464707203630091,  0.0443762721584261,  0.0443762721584261,  0.0256206526762994,
         0.0464707203630092,  0.0443762721584261, -0.044376272158426 , -0.0256206526762994,
        -0.1072531956947871, -0.0443762721584261, -0.0443762721584261, -0.0256206526762994,
        -0.1072531956947871, -0.0443762721584261,  0.044376272158426 ,  0.0256206526762994,
         0.0464707203630091,  0.044376272158426 ,  0.044376272158426 ,  0.0256206526762994,
        // idx = [6,:,:]                                                                   
         0.1551699438380284,  0.0183812537755796, -0.1071337980924318, -0.0106124218153738,
        -0.2159524191698065, -0.0183812537755797, -0.1071337980924317, -0.0106124218153737,
        -0.2159524191698065, -0.0183812537755796,  0.1071337980924318,  0.0106124218153737,
         0.1551699438380285,  0.0183812537755796,  0.1071337980924318,  0.0106124218153737,
         0.1551699438380285,  0.0183812537755797, -0.1071337980924317, -0.0106124218153737,
        -0.2159524191698064, -0.0183812537755796, -0.1071337980924318, -0.0106124218153737,
        -0.2159524191698065, -0.0183812537755797,  0.1071337980924317,  0.0106124218153737,
         0.1551699438380284,  0.0183812537755797,  0.1071337980924318,  0.0106124218153737,
        // idx = [7,:,:]                                                                   
         0.1551699438380284, -0.0183812537755796, -0.1071337980924318,  0.0106124218153737,
        -0.2159524191698066,  0.0183812537755796, -0.1071337980924318,  0.0106124218153737,
        -0.2159524191698066,  0.0183812537755796,  0.1071337980924318, -0.0106124218153737,
         0.1551699438380285, -0.0183812537755796,  0.1071337980924318, -0.0106124218153737,
         0.1551699438380285, -0.0183812537755796, -0.1071337980924318,  0.0106124218153737,
        -0.2159524191698063,  0.0183812537755797, -0.1071337980924318,  0.0106124218153738,
        -0.2159524191698064,  0.0183812537755797,  0.1071337980924317, -0.0106124218153737,
         0.1551699438380285, -0.0183812537755796,  0.1071337980924318, -0.0106124218153737,
        // idx = [8,:,:]                                                                   
         0.0464707203630091, -0.0443762721584261, -0.0443762721584261,  0.0256206526762994,
        -0.1072531956947873,  0.0443762721584261, -0.0443762721584261,  0.0256206526762994,
        -0.1072531956947873,  0.0443762721584261,  0.0443762721584261, -0.0256206526762994,
         0.0464707203630091, -0.0443762721584261,  0.0443762721584261, -0.0256206526762994,
         0.0464707203630092, -0.0443762721584261, -0.0443762721584261,  0.0256206526762994,
        -0.107253195694787 ,  0.0443762721584261, -0.044376272158426 ,  0.0256206526762994,
        -0.107253195694787 ,  0.0443762721584261,  0.044376272158426 , -0.0256206526762994,
         0.0464707203630092, -0.0443762721584261,  0.0443762721584261, -0.0256206526762994,
      };
      for (int j=0; j<cells[0]; j++) {
        for (int k=0; k<cells[1]; k++) {
          int idx0[] = {j+1,k+1};
          long linidx = gkyl_range_idx(&localRange, idx0);
          const double *phi_p  = gkyl_array_cfetch(phi, linidx);
          for (int m=0; m<basis.num_basis; m++)
            TEST_CHECK( gkyl_compare(sol[(j*cells[1]+k)*basis.num_basis+m], phi_p[m], 1e-13) );
        }
      }
    } else {
    }
  } if (poly_order == 2) {
    if (bcs.lo_type[0] == GKYL_POISSON_PERIODIC && bcs.lo_type[1] == GKYL_POISSON_PERIODIC) {
      // Solution with N=8x8 (checked visually against g2):
      const double sol[512] =  {
//        // idx = [1,:,:]  
//        -0.0274023080968722, -0.0522378610013685,  0.0431773750583577,  0.0233874003813852,  0.0020675606649252,  0.0090857828980906, -0.0011937067064604,  0.0052456792020111,
//         0.1628013629580645,  0.0522378610013685,  0.0431773750583577,  0.0233874003813852, -0.0020675606649251, -0.0090857828980905, -0.0011937067064604, -0.0052456792020111,
//         0.1628013629580644,  0.0522378610013685, -0.0431773750583578, -0.0233874003813852, -0.0020675606649251, -0.0090857828980906,  0.0011937067064604, -0.0052456792020111,
//        -0.0274023080968724, -0.0522378610013685, -0.0431773750583578, -0.0233874003813852,  0.0020675606649252,  0.0090857828980906,  0.0011937067064604,  0.0052456792020111,
//        -0.0274023080968725, -0.0522378610013685,  0.0431773750583578,  0.0233874003813852,  0.0020675606649251,  0.0090857828980906, -0.0011937067064604,  0.0052456792020111,
//         0.1628013629580644,  0.0522378610013685,  0.0431773750583578,  0.0233874003813852, -0.0020675606649251, -0.0090857828980905, -0.0011937067064604, -0.0052456792020111,
//         0.1628013629580645,  0.0522378610013685, -0.0431773750583577, -0.0233874003813852, -0.0020675606649251, -0.0090857828980906,  0.0011937067064604, -0.0052456792020111,
//        -0.0274023080968722, -0.0522378610013685, -0.0431773750583577, -0.0233874003813852,  0.0020675606649252,  0.0090857828980906,  0.0011937067064604,  0.0052456792020111,
//        // idx = [2,:,:]                                                    
//        -0.1618966137063934, -0.0216376304961275,  0.1042394044535571,  0.0096873784266194,  0.0049915329982914,  0.0219350202973477, -0.0028818629202324,  0.0021728314693315,
//         0.2972956685675858,  0.0216376304961275,  0.1042394044535571,  0.0096873784266195, -0.0049915329982914, -0.0219350202973477, -0.0028818629202325, -0.0021728314693315,
//         0.2972956685675855,  0.0216376304961274, -0.1042394044535572, -0.0096873784266195, -0.0049915329982914, -0.0219350202973477,  0.0028818629202324, -0.0021728314693315,
//        -0.1618966137063936, -0.0216376304961274, -0.1042394044535571, -0.0096873784266194,  0.0049915329982914,  0.0219350202973478,  0.0028818629202324,  0.0021728314693315,
//        -0.1618966137063937, -0.0216376304961274,  0.1042394044535571,  0.0096873784266194,  0.0049915329982914,  0.0219350202973477, -0.0028818629202324,  0.0021728314693315,
//         0.2972956685675855,  0.0216376304961274,  0.1042394044535571,  0.0096873784266194, -0.0049915329982914, -0.0219350202973477, -0.0028818629202324, -0.0021728314693315,
//         0.2972956685675856,  0.0216376304961274, -0.1042394044535571, -0.0096873784266194, -0.0049915329982914, -0.0219350202973478,  0.0028818629202324, -0.0021728314693315,
//        -0.1618966137063935, -0.0216376304961274, -0.1042394044535571, -0.0096873784266195,  0.0049915329982914,  0.0219350202973478,  0.0028818629202324,  0.0021728314693315,
//        // idx = [3,:,:]                                                    
//        -0.1618966137063936,  0.0216376304961274,  0.1042394044535571, -0.0096873784266194,  0.0049915329982914,  0.0219350202973477, -0.0028818629202325, -0.0021728314693315,
//         0.2972956685675858, -0.0216376304961275,  0.1042394044535571, -0.0096873784266194, -0.0049915329982914, -0.0219350202973478, -0.0028818629202324,  0.0021728314693315,
//         0.2972956685675855, -0.0216376304961274, -0.1042394044535571,  0.0096873784266195, -0.0049915329982914, -0.0219350202973477,  0.0028818629202325,  0.0021728314693315,
//        -0.1618966137063936,  0.0216376304961274, -0.1042394044535571,  0.0096873784266194,  0.0049915329982914,  0.0219350202973478,  0.0028818629202324, -0.0021728314693315,
//        -0.1618966137063937,  0.0216376304961274,  0.1042394044535571, -0.0096873784266194,  0.0049915329982914,  0.0219350202973477, -0.0028818629202324, -0.0021728314693315,
//         0.2972956685675855, -0.0216376304961274,  0.1042394044535571, -0.0096873784266194, -0.0049915329982914, -0.0219350202973477, -0.0028818629202325,  0.0021728314693315,
//         0.2972956685675855, -0.0216376304961275, -0.1042394044535571,  0.0096873784266194, -0.0049915329982914, -0.0219350202973477,  0.0028818629202325,  0.0021728314693315,
//        -0.1618966137063936,  0.0216376304961274, -0.1042394044535571,  0.0096873784266194,  0.0049915329982914,  0.0219350202973477,  0.0028818629202325, -0.0021728314693315,
//        // idx = [4,:,:]                                                    
//        -0.0274023080968725,  0.0522378610013685,  0.0431773750583578, -0.0233874003813852,  0.0020675606649251,  0.0090857828980905, -0.0011937067064604, -0.0052456792020111,
//         0.1628013629580644, -0.0522378610013685,  0.0431773750583578, -0.0233874003813852, -0.0020675606649251, -0.0090857828980906, -0.0011937067064604,  0.0052456792020111,
//         0.1628013629580644, -0.0522378610013685, -0.0431773750583577,  0.0233874003813852, -0.0020675606649251, -0.0090857828980905,  0.0011937067064604,  0.0052456792020111,
//        -0.0274023080968723,  0.0522378610013685, -0.0431773750583578,  0.0233874003813852,  0.0020675606649251,  0.0090857828980906,  0.0011937067064604, -0.0052456792020111,
//        -0.0274023080968724,  0.0522378610013686,  0.0431773750583577, -0.0233874003813852,  0.0020675606649251,  0.0090857828980906, -0.0011937067064604, -0.0052456792020111,
//         0.1628013629580644, -0.0522378610013685,  0.0431773750583577, -0.0233874003813852, -0.0020675606649251, -0.0090857828980906, -0.0011937067064604,  0.0052456792020111,
//         0.1628013629580643, -0.0522378610013685, -0.0431773750583578,  0.0233874003813852, -0.0020675606649251, -0.0090857828980905,  0.0011937067064604,  0.0052456792020111,
//        -0.0274023080968725,  0.0522378610013685, -0.0431773750583578,  0.0233874003813852,  0.0020675606649251,  0.0090857828980905,  0.0011937067064604, -0.0052456792020111,
//        // idx = [5,:,:]
//         0.1628013629580643,  0.0522378610013685, -0.0431773750583578, -0.0233874003813852, -0.0020675606649251, -0.0090857828980905,  0.0011937067064604, -0.0052456792020111,
//        -0.0274023080968725, -0.0522378610013685, -0.0431773750583578, -0.0233874003813852,  0.0020675606649252,  0.0090857828980906,  0.0011937067064604,  0.0052456792020111,
//        -0.0274023080968724, -0.0522378610013685,  0.0431773750583578,  0.0233874003813852,  0.0020675606649251,  0.0090857828980906, -0.0011937067064604,  0.0052456792020111,
//         0.1628013629580645,  0.0522378610013685,  0.0431773750583578,  0.0233874003813852, -0.0020675606649251, -0.0090857828980906, -0.0011937067064604, -0.0052456792020111,
//         0.1628013629580646,  0.0522378610013686, -0.0431773750583578, -0.0233874003813852, -0.0020675606649251, -0.0090857828980906,  0.0011937067064604, -0.0052456792020111,
//        -0.0274023080968722, -0.0522378610013685, -0.0431773750583578, -0.0233874003813852,  0.0020675606649251,  0.0090857828980906,  0.0011937067064604,  0.0052456792020111,
//        -0.0274023080968723, -0.0522378610013685,  0.0431773750583577,  0.0233874003813852,  0.0020675606649251,  0.0090857828980906, -0.0011937067064604,  0.0052456792020111,
//         0.1628013629580644,  0.0522378610013686,  0.0431773750583578,  0.0233874003813852, -0.0020675606649252, -0.0090857828980906, -0.0011937067064604, -0.0052456792020111,
//        // idx = [6,:,:]
//         0.2972956685675856,  0.0216376304961275, -0.1042394044535571, -0.0096873784266194, -0.0049915329982914, -0.0219350202973477,  0.0028818629202325, -0.0021728314693315,
//        -0.1618966137063936, -0.0216376304961274, -0.1042394044535571, -0.0096873784266195,  0.0049915329982914,  0.0219350202973478,  0.0028818629202324,  0.0021728314693315,
//        -0.1618966137063935, -0.0216376304961274,  0.1042394044535572,  0.0096873784266194,  0.0049915329982914,  0.0219350202973477, -0.0028818629202325,  0.0021728314693315,
//         0.2972956685675858,  0.0216376304961275,  0.1042394044535571,  0.0096873784266194, -0.0049915329982914, -0.0219350202973477, -0.0028818629202324, -0.0021728314693315,
//         0.2972956685675859,  0.0216376304961274, -0.1042394044535571, -0.0096873784266194, -0.0049915329982914, -0.0219350202973477,  0.0028818629202324, -0.0021728314693315,
//        -0.1618966137063933, -0.0216376304961274, -0.1042394044535571, -0.0096873784266194,  0.0049915329982914,  0.0219350202973478,  0.0028818629202324,  0.0021728314693315,
//        -0.1618966137063934, -0.0216376304961274,  0.1042394044535571,  0.0096873784266194,  0.0049915329982914,  0.0219350202973478, -0.0028818629202325,  0.0021728314693315,
//         0.2972956685675858,  0.0216376304961275,  0.1042394044535571,  0.0096873784266195, -0.0049915329982914, -0.0219350202973478, -0.0028818629202325, -0.0021728314693315,
//        // idx = [7,:,:]
//         0.2972956685675858, -0.0216376304961274, -0.1042394044535572,  0.0096873784266194, -0.0049915329982914, -0.0219350202973477,  0.0028818629202324,  0.0021728314693315,
//        -0.1618966137063935,  0.0216376304961275, -0.1042394044535571,  0.0096873784266194,  0.0049915329982914,  0.0219350202973478,  0.0028818629202325, -0.0021728314693315,
//        -0.1618966137063935,  0.0216376304961274,  0.1042394044535571, -0.0096873784266195,  0.0049915329982914,  0.0219350202973477, -0.0028818629202324, -0.0021728314693314,
//         0.2972956685675859, -0.0216376304961274,  0.1042394044535571, -0.0096873784266194, -0.0049915329982914, -0.0219350202973478, -0.0028818629202325,  0.0021728314693315,
//         0.2972956685675858, -0.0216376304961275, -0.1042394044535571,  0.0096873784266194, -0.0049915329982914, -0.0219350202973477,  0.0028818629202325,  0.0021728314693315,
//        -0.1618966137063933,  0.0216376304961274, -0.1042394044535571,  0.0096873784266195,  0.0049915329982914,  0.0219350202973478,  0.0028818629202325, -0.0021728314693315,
//        -0.1618966137063933,  0.0216376304961275,  0.1042394044535571, -0.0096873784266194,  0.0049915329982914,  0.0219350202973477, -0.0028818629202325, -0.0021728314693315,
//         0.297295668567586 , -0.0216376304961273,  0.1042394044535571, -0.0096873784266194, -0.0049915329982914, -0.0219350202973478, -0.0028818629202324,  0.0021728314693315,
//        // idx = [8,:,:]
//         0.1628013629580647, -0.0522378610013685, -0.0431773750583578,  0.0233874003813852, -0.0020675606649251, -0.0090857828980905,  0.0011937067064604,  0.0052456792020111,
//        -0.0274023080968722,  0.0522378610013685, -0.0431773750583578,  0.0233874003813852,  0.0020675606649251,  0.0090857828980906,  0.0011937067064604, -0.0052456792020111,
//        -0.0274023080968723,  0.0522378610013685,  0.0431773750583578, -0.0233874003813852,  0.0020675606649251,  0.0090857828980906, -0.0011937067064604, -0.0052456792020111,
//         0.1628013629580645, -0.0522378610013686,  0.0431773750583577, -0.0233874003813852, -0.0020675606649251, -0.0090857828980906, -0.0011937067064604,  0.0052456792020111,
//         0.1628013629580644, -0.0522378610013685, -0.0431773750583577,  0.0233874003813852, -0.0020675606649251, -0.0090857828980905,  0.0011937067064604,  0.0052456792020111,
//        -0.0274023080968722,  0.0522378610013685, -0.0431773750583577,  0.0233874003813852,  0.0020675606649251,  0.0090857828980906,  0.0011937067064604, -0.0052456792020111,
//        -0.0274023080968721,  0.0522378610013684,  0.0431773750583578, -0.0233874003813852,  0.0020675606649251,  0.0090857828980905, -0.0011937067064604, -0.0052456792020111,
//         0.1628013629580648, -0.0522378610013686,  0.0431773750583578, -0.0233874003813852, -0.0020675606649251, -0.0090857828980905, -0.0011937067064604,  0.0052456792020111,

//        // idx = [1,:,:]
//        -0.1403851149458775, -0.0522378610013686,  0.0431773750583578,  0.0233874003813852,  0.0020675606649251,  0.0090857828980906, -0.0011937067064604,  0.0052456792020111,
//         0.0498185561090594,  0.0522378610013686,  0.0431773750583578,  0.0233874003813852, -0.0020675606649252, -0.0090857828980906, -0.0011937067064604, -0.0052456792020111,
//         0.0498185561090593,  0.0522378610013686, -0.0431773750583578, -0.0233874003813852, -0.0020675606649251, -0.0090857828980906,  0.0011937067064604, -0.0052456792020111,
//        -0.1403851149458776, -0.0522378610013686, -0.0431773750583578, -0.0233874003813852,  0.0020675606649251,  0.0090857828980906,  0.0011937067064604,  0.0052456792020111,
//        -0.1403851149458776, -0.0522378610013686,  0.0431773750583578,  0.0233874003813852,  0.0020675606649251,  0.0090857828980906, -0.0011937067064604,  0.0052456792020111,
//         0.0498185561090594,  0.0522378610013685,  0.0431773750583578,  0.0233874003813852, -0.0020675606649251, -0.0090857828980906, -0.0011937067064604, -0.0052456792020111,
//         0.0498185561090594,  0.0522378610013685, -0.0431773750583578, -0.0233874003813852, -0.0020675606649251, -0.0090857828980906,  0.0011937067064604, -0.0052456792020111,
//        -0.1403851149458775, -0.0522378610013686, -0.0431773750583578, -0.0233874003813852,  0.0020675606649252,  0.0090857828980906,  0.0011937067064604,  0.0052456792020111,
//        // idx = [2,:,:] 
//        -0.2748794205553989, -0.0216376304961275,  0.1042394044535572,  0.0096873784266195,  0.0049915329982914,  0.0219350202973477, -0.0028818629202325,  0.0021728314693315,
//         0.1843128617185807,  0.0216376304961275,  0.1042394044535572,  0.0096873784266194, -0.0049915329982914, -0.0219350202973478, -0.0028818629202324, -0.0021728314693315,
//         0.1843128617185806,  0.0216376304961274, -0.1042394044535572, -0.0096873784266194, -0.0049915329982914, -0.0219350202973477,  0.0028818629202324, -0.0021728314693315,
//        -0.2748794205553989, -0.0216376304961274, -0.1042394044535572, -0.0096873784266195,  0.0049915329982914,  0.0219350202973477,  0.0028818629202324,  0.0021728314693315,
//        -0.274879420555399 , -0.0216376304961274,  0.1042394044535572,  0.0096873784266194,  0.0049915329982914,  0.0219350202973478, -0.0028818629202324,  0.0021728314693315,
//         0.1843128617185807,  0.0216376304961275,  0.1042394044535572,  0.0096873784266195, -0.0049915329982914, -0.0219350202973478, -0.0028818629202324, -0.0021728314693315,
//         0.1843128617185807,  0.0216376304961275, -0.1042394044535572, -0.0096873784266195, -0.0049915329982914, -0.0219350202973478,  0.0028818629202324, -0.0021728314693315,
//        -0.2748794205553988, -0.0216376304961275, -0.1042394044535572, -0.0096873784266195,  0.0049915329982914,  0.0219350202973478,  0.0028818629202325,  0.0021728314693315,
//        // idx = [3,:,:] 
//        -0.2748794205553989,  0.0216376304961274,  0.1042394044535572, -0.0096873784266195,  0.0049915329982914,  0.0219350202973477, -0.0028818629202324, -0.0021728314693315,
//         0.1843128617185806, -0.0216376304961275,  0.1042394044535572, -0.0096873784266194, -0.0049915329982914, -0.0219350202973478, -0.0028818629202324,  0.0021728314693315,
//         0.1843128617185806, -0.0216376304961274, -0.1042394044535572,  0.0096873784266195, -0.0049915329982914, -0.0219350202973477,  0.0028818629202325,  0.0021728314693315,
//        -0.2748794205553989,  0.0216376304961274, -0.1042394044535572,  0.0096873784266195,  0.0049915329982914,  0.0219350202973477,  0.0028818629202325, -0.0021728314693315,
//        -0.274879420555399 ,  0.0216376304961275,  0.1042394044535572, -0.0096873784266195,  0.0049915329982914,  0.0219350202973477, -0.0028818629202325, -0.0021728314693315,
//         0.1843128617185807, -0.0216376304961274,  0.1042394044535572, -0.0096873784266195, -0.0049915329982914, -0.0219350202973478, -0.0028818629202324,  0.0021728314693315,
//         0.1843128617185807, -0.0216376304961275, -0.1042394044535572,  0.0096873784266194, -0.0049915329982914, -0.0219350202973477,  0.0028818629202324,  0.0021728314693315,
//        -0.2748794205553989,  0.0216376304961274, -0.1042394044535572,  0.0096873784266195,  0.0049915329982914,  0.0219350202973478,  0.0028818629202324, -0.0021728314693315,
//        // idx = [4,:,:] 
//        -0.1403851149458776,  0.0522378610013685,  0.0431773750583578, -0.0233874003813852,  0.0020675606649251,  0.0090857828980905, -0.0011937067064604, -0.0052456792020111,
//         0.0498185561090593, -0.0522378610013685,  0.0431773750583578, -0.0233874003813852, -0.0020675606649252, -0.0090857828980906, -0.0011937067064604,  0.0052456792020111,
//         0.0498185561090593, -0.0522378610013685, -0.0431773750583578,  0.0233874003813852, -0.0020675606649251, -0.0090857828980906,  0.0011937067064604,  0.0052456792020111,
//        -0.1403851149458775,  0.0522378610013686, -0.0431773750583578,  0.0233874003813852,  0.0020675606649251,  0.0090857828980906,  0.0011937067064604, -0.0052456792020111,
//        -0.1403851149458775,  0.0522378610013686,  0.0431773750583578, -0.0233874003813852,  0.0020675606649251,  0.0090857828980905, -0.0011937067064604, -0.0052456792020111,
//         0.0498185561090594, -0.0522378610013685,  0.0431773750583578, -0.0233874003813852, -0.0020675606649251, -0.0090857828980906, -0.0011937067064604,  0.0052456792020111,
//         0.0498185561090594, -0.0522378610013685, -0.0431773750583578,  0.0233874003813852, -0.0020675606649251, -0.0090857828980906,  0.0011937067064604,  0.0052456792020111,
//        -0.1403851149458776,  0.0522378610013685, -0.0431773750583578,  0.0233874003813852,  0.0020675606649251,  0.0090857828980905,  0.0011937067064604, -0.0052456792020111,
//        // idx = [5,:,:] 
//         0.0498185561090592,  0.0522378610013686, -0.0431773750583578, -0.0233874003813852, -0.0020675606649251, -0.0090857828980906,  0.0011937067064604, -0.0052456792020111,
//        -0.1403851149458776, -0.0522378610013685, -0.0431773750583578, -0.0233874003813852,  0.0020675606649251,  0.0090857828980906,  0.0011937067064604,  0.0052456792020111,
//        -0.1403851149458775, -0.0522378610013685,  0.0431773750583578,  0.0233874003813852,  0.0020675606649251,  0.0090857828980905, -0.0011937067064604,  0.0052456792020111,
//         0.0498185561090595,  0.0522378610013686,  0.0431773750583578,  0.0233874003813852, -0.0020675606649251, -0.0090857828980906, -0.0011937067064604, -0.0052456792020111,
//         0.0498185561090596,  0.0522378610013686, -0.0431773750583578, -0.0233874003813852, -0.0020675606649251, -0.0090857828980906,  0.0011937067064604, -0.0052456792020111,
//        -0.1403851149458772, -0.0522378610013685, -0.0431773750583578, -0.0233874003813852,  0.0020675606649251,  0.0090857828980905,  0.0011937067064604,  0.0052456792020111,
//        -0.1403851149458774, -0.0522378610013685,  0.0431773750583577,  0.0233874003813852,  0.0020675606649251,  0.0090857828980906, -0.0011937067064604,  0.0052456792020111,
//         0.0498185561090593,  0.0522378610013685,  0.0431773750583578,  0.0233874003813852, -0.0020675606649251, -0.0090857828980906, -0.0011937067064604, -0.0052456792020111,
//        // idx = [6,:,:] 
//         0.1843128617185806,  0.0216376304961275, -0.1042394044535572, -0.0096873784266194, -0.0049915329982914, -0.0219350202973477,  0.0028818629202325, -0.0021728314693315,
//        -0.2748794205553989, -0.0216376304961275, -0.1042394044535572, -0.0096873784266195,  0.0049915329982914,  0.0219350202973477,  0.0028818629202324,  0.0021728314693315,
//        -0.2748794205553988, -0.0216376304961275,  0.1042394044535573,  0.0096873784266194,  0.0049915329982914,  0.0219350202973477, -0.0028818629202325,  0.0021728314693315,
//         0.1843128617185809,  0.0216376304961275,  0.1042394044535573,  0.0096873784266195, -0.0049915329982914, -0.0219350202973477, -0.0028818629202325, -0.0021728314693315,
//         0.1843128617185811,  0.0216376304961275, -0.1042394044535572, -0.0096873784266195, -0.0049915329982914, -0.0219350202973478,  0.0028818629202325, -0.0021728314693315,
//        -0.2748794205553984, -0.0216376304961275, -0.1042394044535572, -0.0096873784266194,  0.0049915329982914,  0.0219350202973477,  0.0028818629202324,  0.0021728314693315,
//        -0.2748794205553987, -0.0216376304961274,  0.1042394044535571,  0.0096873784266194,  0.0049915329982914,  0.0219350202973477, -0.0028818629202324,  0.0021728314693315,
//         0.1843128617185807,  0.0216376304961275,  0.1042394044535572,  0.0096873784266195, -0.0049915329982914, -0.0219350202973477, -0.0028818629202325, -0.0021728314693315,
//        // idx = [7,:,:] 
//         0.1843128617185807, -0.0216376304961274, -0.1042394044535572,  0.0096873784266194, -0.0049915329982914, -0.0219350202973477,  0.0028818629202325,  0.0021728314693315,
//        -0.2748794205553989,  0.0216376304961274, -0.1042394044535572,  0.0096873784266195,  0.0049915329982914,  0.0219350202973477,  0.0028818629202324, -0.0021728314693315,
//        -0.2748794205553989,  0.0216376304961274,  0.1042394044535572, -0.0096873784266195,  0.0049915329982914,  0.0219350202973477, -0.0028818629202324, -0.0021728314693315,
//         0.1843128617185809, -0.0216376304961275,  0.1042394044535573, -0.0096873784266195, -0.0049915329982914, -0.0219350202973478, -0.0028818629202325,  0.0021728314693315,
//         0.184312861718581 , -0.0216376304961275, -0.1042394044535572,  0.0096873784266195, -0.0049915329982914, -0.0219350202973478,  0.0028818629202324,  0.0021728314693315,
//        -0.2748794205553985,  0.0216376304961274, -0.1042394044535572,  0.0096873784266194,  0.0049915329982914,  0.0219350202973477,  0.0028818629202325, -0.0021728314693315,
//        -0.2748794205553985,  0.0216376304961274,  0.1042394044535571, -0.0096873784266194,  0.0049915329982914,  0.0219350202973477, -0.0028818629202325, -0.0021728314693315,
//         0.1843128617185808, -0.0216376304961274,  0.1042394044535572, -0.0096873784266195, -0.0049915329982914, -0.0219350202973477, -0.0028818629202325,  0.0021728314693315,
//        // idx = [8,:,:] 
//         0.0498185561090594, -0.0522378610013686, -0.0431773750583578,  0.0233874003813852, -0.0020675606649251, -0.0090857828980906,  0.0011937067064604,  0.0052456792020111,
//        -0.1403851149458776,  0.0522378610013686, -0.0431773750583578,  0.0233874003813852,  0.0020675606649251,  0.0090857828980905,  0.0011937067064604, -0.0052456792020111,
//        -0.1403851149458776,  0.0522378610013686,  0.0431773750583578, -0.0233874003813852,  0.0020675606649251,  0.0090857828980905, -0.0011937067064604, -0.0052456792020111,
//         0.0498185561090594, -0.0522378610013686,  0.0431773750583578, -0.0233874003813852, -0.0020675606649251, -0.0090857828980906, -0.0011937067064604,  0.0052456792020111,
//         0.0498185561090594, -0.0522378610013686, -0.0431773750583578,  0.0233874003813852, -0.0020675606649251, -0.0090857828980905,  0.0011937067064604,  0.0052456792020111,
//        -0.1403851149458774,  0.0522378610013685, -0.0431773750583578,  0.0233874003813852,  0.0020675606649252,  0.0090857828980905,  0.0011937067064604, -0.0052456792020111,
//        -0.1403851149458774,  0.0522378610013685,  0.0431773750583578, -0.0233874003813852,  0.0020675606649252,  0.0090857828980905, -0.0011937067064604, -0.0052456792020111,
//         0.0498185561090594, -0.0522378610013686,  0.0431773750583578, -0.0233874003813852, -0.0020675606649251, -0.0090857828980905, -0.0011937067064604,  0.0052456792020111,
        // idx = [1,:,:] 
        -0.1612019662117002, -0.0522378610013685,  0.0431773750583578,  0.0233874003813852,  0.0020675606649251,  0.0090857828980906, -0.0011937067064604,  0.0052456792020111,
         0.0290017048432367,  0.0522378610013686,  0.0431773750583578,  0.0233874003813852, -0.0020675606649252, -0.0090857828980906, -0.0011937067064604, -0.0052456792020111,
         0.0290017048432366,  0.0522378610013685, -0.0431773750583579, -0.0233874003813852, -0.0020675606649251, -0.0090857828980906,  0.0011937067064604, -0.0052456792020111,
        -0.1612019662117004, -0.0522378610013686, -0.0431773750583578, -0.0233874003813852,  0.0020675606649251,  0.0090857828980906,  0.0011937067064604,  0.0052456792020111,
        -0.1612019662117004, -0.0522378610013686,  0.0431773750583578,  0.0233874003813852,  0.0020675606649251,  0.0090857828980905, -0.0011937067064604,  0.0052456792020111,
         0.0290017048432366,  0.0522378610013685,  0.0431773750583578,  0.0233874003813852, -0.0020675606649252, -0.0090857828980906, -0.0011937067064604, -0.0052456792020111,
         0.0290017048432367,  0.0522378610013686, -0.0431773750583578, -0.0233874003813852, -0.0020675606649251, -0.0090857828980906,  0.0011937067064604, -0.0052456792020111,
        -0.1612019662117001, -0.0522378610013685, -0.0431773750583578, -0.0233874003813852,  0.0020675606649252,  0.0090857828980906,  0.0011937067064604,  0.0052456792020111,
        // idx = [2,:,:] 
        -0.2956962718212214, -0.0216376304961275,  0.1042394044535572,  0.0096873784266194,  0.0049915329982914,  0.0219350202973478, -0.0028818629202325,  0.0021728314693315,
         0.1634960104527581,  0.0216376304961275,  0.1042394044535571,  0.0096873784266195, -0.0049915329982914, -0.0219350202973478, -0.0028818629202324, -0.0021728314693315,
         0.1634960104527579,  0.0216376304961275, -0.1042394044535573, -0.0096873784266194, -0.0049915329982914, -0.0219350202973477,  0.0028818629202324, -0.0021728314693314,
        -0.2956962718212218, -0.0216376304961274, -0.1042394044535572, -0.0096873784266195,  0.0049915329982914,  0.0219350202973477,  0.0028818629202324,  0.0021728314693314,
        -0.2956962718212218, -0.0216376304961275,  0.1042394044535572,  0.0096873784266194,  0.0049915329982914,  0.0219350202973477, -0.0028818629202325,  0.0021728314693315,
         0.1634960104527579,  0.0216376304961275,  0.1042394044535572,  0.0096873784266195, -0.0049915329982914, -0.0219350202973478, -0.0028818629202324, -0.0021728314693315,
         0.163496010452758 ,  0.0216376304961275, -0.1042394044535572, -0.0096873784266194, -0.0049915329982914, -0.0219350202973478,  0.0028818629202324, -0.0021728314693315,
        -0.2956962718212214, -0.0216376304961274, -0.1042394044535572, -0.0096873784266195,  0.0049915329982914,  0.0219350202973477,  0.0028818629202325,  0.0021728314693315,
        // idx = [3,:,:] 
        -0.2956962718212215,  0.0216376304961274,  0.1042394044535572, -0.0096873784266194,  0.0049915329982914,  0.0219350202973477, -0.0028818629202325, -0.0021728314693315,
         0.163496010452758 , -0.0216376304961275,  0.1042394044535572, -0.0096873784266195, -0.0049915329982914, -0.0219350202973478, -0.0028818629202324,  0.0021728314693315,
         0.1634960104527579, -0.0216376304961274, -0.1042394044535573,  0.0096873784266195, -0.0049915329982914, -0.0219350202973477,  0.0028818629202325,  0.0021728314693314,
        -0.2956962718212217,  0.0216376304961274, -0.1042394044535572,  0.0096873784266195,  0.0049915329982914,  0.0219350202973478,  0.0028818629202324, -0.0021728314693315,
        -0.2956962718212217,  0.0216376304961275,  0.1042394044535572, -0.0096873784266195,  0.0049915329982914,  0.0219350202973478, -0.0028818629202324, -0.0021728314693315,
         0.1634960104527579, -0.0216376304961275,  0.1042394044535572, -0.0096873784266195, -0.0049915329982914, -0.0219350202973478, -0.0028818629202325,  0.0021728314693315,
         0.163496010452758 , -0.0216376304961274, -0.1042394044535572,  0.0096873784266194, -0.0049915329982914, -0.0219350202973478,  0.0028818629202324,  0.0021728314693314,
        -0.2956962718212214,  0.0216376304961273, -0.1042394044535572,  0.0096873784266194,  0.0049915329982914,  0.0219350202973477,  0.0028818629202325, -0.0021728314693315,
        // idx = [4,:,:] 
        -0.1612019662117004,  0.0522378610013685,  0.0431773750583578, -0.0233874003813852,  0.0020675606649251,  0.0090857828980905, -0.0011937067064604, -0.0052456792020111,
         0.0290017048432365, -0.0522378610013686,  0.0431773750583578, -0.0233874003813852, -0.0020675606649252, -0.0090857828980905, -0.0011937067064604,  0.0052456792020111,
         0.0290017048432365, -0.0522378610013686, -0.0431773750583578,  0.0233874003813852, -0.0020675606649251, -0.0090857828980906,  0.0011937067064604,  0.0052456792020111,
        -0.1612019662117004,  0.0522378610013686, -0.0431773750583578,  0.0233874003813852,  0.0020675606649251,  0.0090857828980906,  0.0011937067064604, -0.0052456792020111,
        -0.1612019662117004,  0.0522378610013685,  0.0431773750583578, -0.0233874003813852,  0.0020675606649251,  0.0090857828980905, -0.0011937067064604, -0.0052456792020111,
         0.0290017048432366, -0.0522378610013685,  0.0431773750583578, -0.0233874003813852, -0.0020675606649251, -0.0090857828980906, -0.0011937067064604,  0.0052456792020111,
         0.0290017048432367, -0.0522378610013686, -0.0431773750583578,  0.0233874003813852, -0.0020675606649251, -0.0090857828980906,  0.0011937067064604,  0.0052456792020111,
        -0.1612019662117004,  0.0522378610013685, -0.0431773750583578,  0.0233874003813852,  0.0020675606649252,  0.0090857828980905,  0.0011937067064604, -0.0052456792020111,
        // idx = [5,:,:] 
         0.0290017048432364,  0.0522378610013685, -0.0431773750583578, -0.0233874003813852, -0.0020675606649251, -0.0090857828980906,  0.0011937067064604, -0.0052456792020111,
        -0.1612019662117005, -0.0522378610013686, -0.0431773750583578, -0.0233874003813852,  0.0020675606649251,  0.0090857828980906,  0.0011937067064604,  0.0052456792020111,
        -0.1612019662117004, -0.0522378610013685,  0.0431773750583578,  0.0233874003813852,  0.0020675606649251,  0.0090857828980906, -0.0011937067064604,  0.0052456792020111,
         0.0290017048432366,  0.0522378610013686,  0.0431773750583578,  0.0233874003813852, -0.0020675606649252, -0.0090857828980906, -0.0011937067064604, -0.0052456792020111,
         0.0290017048432366,  0.0522378610013686, -0.0431773750583578, -0.0233874003813852, -0.0020675606649251, -0.0090857828980906,  0.0011937067064604, -0.0052456792020111,
        -0.1612019662117002, -0.0522378610013685, -0.0431773750583578, -0.0233874003813852,  0.0020675606649252,  0.0090857828980906,  0.0011937067064604,  0.0052456792020111,
        -0.1612019662117003, -0.0522378610013685,  0.0431773750583578,  0.0233874003813852,  0.0020675606649251,  0.0090857828980905, -0.0011937067064604,  0.0052456792020111,
         0.0290017048432365,  0.0522378610013685,  0.0431773750583578,  0.0233874003813852, -0.0020675606649252, -0.0090857828980906, -0.0011937067064604, -0.0052456792020111,
        // idx = [6,:,:] 
         0.1634960104527577,  0.0216376304961275, -0.1042394044535572, -0.0096873784266195, -0.0049915329982914, -0.0219350202973477,  0.0028818629202325, -0.0021728314693315,
        -0.2956962718212218, -0.0216376304961274, -0.1042394044535572, -0.0096873784266195,  0.0049915329982914,  0.0219350202973478,  0.0028818629202324,  0.0021728314693315,
        -0.2956962718212217, -0.0216376304961274,  0.1042394044535573,  0.0096873784266194,  0.0049915329982914,  0.0219350202973477, -0.0028818629202324,  0.0021728314693315,
         0.163496010452758 ,  0.0216376304961275,  0.1042394044535572,  0.0096873784266195, -0.0049915329982914, -0.0219350202973478, -0.0028818629202325, -0.0021728314693315,
         0.1634960104527581,  0.0216376304961275, -0.1042394044535572, -0.0096873784266195, -0.0049915329982914, -0.0219350202973478,  0.0028818629202324, -0.0021728314693315,
        -0.2956962718212213, -0.0216376304961274, -0.1042394044535572, -0.0096873784266194,  0.0049915329982914,  0.0219350202973477,  0.0028818629202325,  0.0021728314693315,
        -0.2956962718212214, -0.0216376304961274,  0.1042394044535571,  0.0096873784266194,  0.0049915329982914,  0.0219350202973477, -0.0028818629202325,  0.0021728314693315,
         0.1634960104527578,  0.0216376304961275,  0.1042394044535571,  0.0096873784266195, -0.0049915329982914, -0.0219350202973478, -0.0028818629202325, -0.0021728314693315,
        // idx = [7,:,:] 
         0.1634960104527577, -0.0216376304961274, -0.1042394044535572,  0.0096873784266194, -0.0049915329982914, -0.0219350202973477,  0.0028818629202324,  0.0021728314693315,
        -0.2956962718212218,  0.0216376304961274, -0.1042394044535572,  0.0096873784266194,  0.0049915329982914,  0.0219350202973477,  0.0028818629202324, -0.0021728314693315,
        -0.2956962718212217,  0.0216376304961274,  0.1042394044535573, -0.0096873784266195,  0.0049915329982914,  0.0219350202973477, -0.0028818629202325, -0.0021728314693315,
         0.163496010452758 , -0.0216376304961274,  0.1042394044535572, -0.0096873784266195, -0.0049915329982914, -0.0219350202973478, -0.0028818629202324,  0.0021728314693315,
         0.1634960104527581, -0.0216376304961274, -0.1042394044535572,  0.0096873784266195, -0.0049915329982914, -0.0219350202973478,  0.0028818629202324,  0.0021728314693315,
        -0.2956962718212213,  0.0216376304961274, -0.1042394044535572,  0.0096873784266194,  0.0049915329982914,  0.0219350202973477,  0.0028818629202325, -0.0021728314693315,
        -0.2956962718212214,  0.0216376304961275,  0.1042394044535571, -0.0096873784266194,  0.0049915329982914,  0.0219350202973477, -0.0028818629202324, -0.0021728314693315,
         0.1634960104527579, -0.0216376304961274,  0.1042394044535571, -0.0096873784266195, -0.0049915329982914, -0.0219350202973478, -0.0028818629202325,  0.0021728314693315,
        // idx = [8,:,:] 
         0.0290017048432366, -0.0522378610013685, -0.0431773750583578,  0.0233874003813852, -0.0020675606649251, -0.0090857828980906,  0.0011937067064604,  0.0052456792020111,
        -0.1612019662117003,  0.0522378610013686, -0.0431773750583578,  0.0233874003813852,  0.0020675606649251,  0.0090857828980905,  0.0011937067064604, -0.0052456792020111,
        -0.1612019662117004,  0.0522378610013686,  0.0431773750583578, -0.0233874003813852,  0.0020675606649251,  0.0090857828980905, -0.0011937067064604, -0.0052456792020111,
         0.0290017048432366, -0.0522378610013686,  0.0431773750583578, -0.0233874003813852, -0.0020675606649251, -0.0090857828980906, -0.0011937067064604,  0.0052456792020111,
         0.0290017048432366, -0.0522378610013686, -0.0431773750583578,  0.0233874003813852, -0.0020675606649251, -0.0090857828980905,  0.0011937067064604,  0.0052456792020111,
        -0.1612019662117002,  0.0522378610013685, -0.0431773750583578,  0.0233874003813852,  0.0020675606649251,  0.0090857828980905,  0.0011937067064604, -0.0052456792020111,
        -0.1612019662117001,  0.0522378610013685,  0.0431773750583578, -0.0233874003813852,  0.0020675606649252,  0.0090857828980905, -0.0011937067064604, -0.0052456792020111,
         0.0290017048432367, -0.0522378610013685,  0.0431773750583578, -0.0233874003813852, -0.0020675606649251, -0.0090857828980906, -0.0011937067064604,  0.0052456792020111,
      };

      for (int j=0; j<cells[0]; j++) {
        for (int k=0; k<cells[1]; k++) {
          int idx0[] = {j+1,k+1};
          long linidx = gkyl_range_idx(&localRange, idx0);
          const double *phi_p  = gkyl_array_cfetch(phi, linidx);
          for (int m=0; m<basis.num_basis; m++)
            TEST_CHECK( gkyl_compare(sol[(j*cells[1]+k)*basis.num_basis+m], phi_p[m], 1e-13) );
        }
      }
    } else {
    }
  }

  gkyl_fem_poisson_release(poisson);
  gkyl_proj_on_basis_release(projob);
  gkyl_array_release(rho);
  gkyl_array_release(phi);
  gkyl_array_release(perbuff);
}

void test_1x_p1_periodicx() {
  int cells[] = {16}; // MF 2022/05/31: N=8 is broken.
  struct gkyl_poisson_bc bc_tv;
  bc_tv.lo_type[0] = GKYL_POISSON_PERIODIC;
  bc_tv.up_type[0] = GKYL_POISSON_PERIODIC;
  test_1x(1, &cells[0], bc_tv);
}
void test_1x_p1_dirichletx_dirichletx() {
  int cells[] = {16};
  struct gkyl_poisson_bc bc_tv;
  bc_tv.lo_type[0] = GKYL_POISSON_DIRICHLET;
  bc_tv.up_type[0] = GKYL_POISSON_DIRICHLET;
  bc_tv.lo_value[0].v[0] = 0.;
  bc_tv.up_value[0].v[0] = 0.;
  test_1x(1, &cells[0], bc_tv);
}

void test_1x_p2_periodicx() {
  int cells[] = {8};
  struct gkyl_poisson_bc bc_tv;
  bc_tv.lo_type[0] = GKYL_POISSON_PERIODIC;
  bc_tv.up_type[0] = GKYL_POISSON_PERIODIC;
  test_1x(2, &cells[0], bc_tv);
}

void test_2x_p1_periodicx_periodicy() {
  int cells[] = {8,8};
  struct gkyl_poisson_bc bc_tv;
  bc_tv.lo_type[0] = GKYL_POISSON_PERIODIC;
  bc_tv.up_type[0] = GKYL_POISSON_PERIODIC;
  bc_tv.lo_type[1] = GKYL_POISSON_PERIODIC;
  bc_tv.up_type[1] = GKYL_POISSON_PERIODIC;
  test_2x(1, &cells[0], bc_tv);
}
void test_2x_p2_periodicx_periodicy() {
  int cells[] = {8,8};
  struct gkyl_poisson_bc bc_tv;
  bc_tv.lo_type[0] = GKYL_POISSON_PERIODIC;
  bc_tv.up_type[0] = GKYL_POISSON_PERIODIC;
  bc_tv.lo_type[1] = GKYL_POISSON_PERIODIC;
  bc_tv.up_type[1] = GKYL_POISSON_PERIODIC;
  test_2x(2, &cells[0], bc_tv);
}


TEST_LIST = {
  { "test_1x_p1_periodicx", test_1x_p1_periodicx },
  { "test_1x_p1_dirichletx_dirichletx", test_1x_p1_dirichletx_dirichletx },
  { "test_1x_p2_periodicx", test_1x_p2_periodicx },
  { "test_2x_p1_periodicx_periodicy", test_2x_p1_periodicx_periodicy },
  { "test_2x_p2_periodicx_periodicy", test_2x_p2_periodicx_periodicy },
  { NULL, NULL },
};
