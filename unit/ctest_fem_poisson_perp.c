// Test the perpendicular FEM Helmholtz/Poisson solver.
//
#include <acutest.h>

#include <math.h>
#include <gkyl_proj_on_basis.h>
#include <gkyl_range.h>
#include <gkyl_rect_decomp.h>
#include <gkyl_rect_grid.h>
#include <gkyl_array_rio.h>
#include <gkyl_fem_poisson_perp.h>

#define PERP_DIM 2

void evalFunc_consteps_periodicx_periodicy_sol(double t, const double *xn, double* restrict fout, void *ctx)
{
  // These values have to match those in the test below.
  double gxx = 1.0;
  double gxy = 0.;
  double gyy = 1.0;

  double x = xn[0], y = xn[1], z = xn[2];
  double amn[] = {0., 10., 0., 10., 0., 0., 10., 0., 0.};
  double bmn[] = {0., 10., 0., 10., 0., 0., 10., 0., 0.};
  fout[0] = 0.;
  for (int m=1; m<4; m++) {
    for (int n=1; n<4; n++) {
      double a = amn[(m-1)*3+(n-1)];
      double b = bmn[(m-1)*3+(n-1)];
      double t1 = a*cos(m*x)*cos(n*y);
      double t2 = b*sin(m*x)*sin(n*y);
      fout[0] += t1+t2;
    }
  }
  double kz = 1.;
  fout[0] *= (1.+kz*z);
//  fout[0] *= (1.+kz*z+0.5*pow(z,2));
}
void evalFunc_consteps_periodicx_periodicy(double t, const double *xn, double* restrict fout, void *ctx)
{
  // These values have to match those in the test below.
  double gxx = 1.0;
  double gxy = 0.;
  double gyy = 1.0;

  double x = xn[0], y = xn[1], z = xn[2];
  double amn[] = {0., 10., 0., 10., 0., 0., 10., 0., 0.};
  double bmn[] = {0., 10., 0., 10., 0., 0., 10., 0., 0.};
  fout[0] = 0.;
  for (int m=1; m<4; m++) {
    for (int n=1; n<4; n++) {
      double a = amn[(m-1)*3+(n-1)];
      double b = bmn[(m-1)*3+(n-1)];
      double t1 = (a*gxx*pow(m,2) - 2*b*gxy*m*n + a*gyy*pow(n,2))*cos(m*x)*cos(n*y);
      double t2 = (b*gxx*pow(m,2) - 2*a*gxy*m*n + b*gyy*pow(n,2))*sin(m*x)*sin(n*y);
      fout[0] += t1+t2;
    }
  }
  double kz = 1.;
  fout[0] *= (1.+kz*z);
//  fout[0] *= (1.+kz*z+0.5*pow(z,2));
}


double poly_test_func_1x(double x, double a, double *c)
{
  // Function that can be used to produce homogeneous Dirichlet or Neumann
  // boundary values depending on the choice of a and c. It assumes x \in [0,1].
  return pow(x,2)/2.-a*pow(x,4)/12.+c[0]*x+c[1];
}

void evalFunc_consteps_dirichletx_dirichlety(double t, const double *xn, double* restrict fout, void *ctx)
{
  double x = xn[0], y = xn[1], z = xn[2];
  double a = 2.;
  double c[] = {a/12.-1./2., 0.};
  double b = 2.;
  double d[] = {b/12.-1./2., 0.};
  double kz = 1.;
  double xp = x, yp = y, zp = z;
  fout[0] = -( (1 - b*pow(yp,2))*poly_test_func_1x(xp, a, c)
              +(1 - a*pow(xp,2))*poly_test_func_1x(yp, b, d) )
//              *sin(kz*z);
              *(1.+kz*z);
//              *(1.+kz*z+0.5*pow(z,2));
}
void evalFunc_consteps_dirichletx_dirichlety_sol(double t, const double *xn, double* restrict fout, void *ctx)
{
  double x = xn[0], y = xn[1], z = xn[2];
  double a = 2.;
  double c[] = {a/12.-1./2., 0.};
  double b = 2.;
  double d[] = {b/12.-1./2., 0.};
  double kz = 1.;
  double xp = x, yp = y, zp = z;
  fout[0] = poly_test_func_1x(xp, a, c)*poly_test_func_1x(yp, b, d)
//           *sin(kz*z);
           *(1.+kz*z);
//           *(1.+kz*z+0.5*pow(z,2));
}

// allocate array (filled with zeros)
static struct gkyl_array*
mkarr(long nc, long size)
{
  struct gkyl_array* a = gkyl_array_new(GKYL_DOUBLE, nc, size);
  return a;
}

static struct gkyl_array*
mkarr_cu(long nc, long size)
{
  struct gkyl_array* a = gkyl_array_cu_dev_new(GKYL_DOUBLE, nc, size);
  return a;
}

struct skin_ghost_ranges {
  struct gkyl_range lower_skin[GKYL_MAX_DIM];
  struct gkyl_range lower_ghost[GKYL_MAX_DIM];

  struct gkyl_range upper_skin[GKYL_MAX_DIM];
  struct gkyl_range upper_ghost[GKYL_MAX_DIM];
};

// Create ghost and skin sub-ranges given a parent range
static void
skin_ghost_ranges_init(struct skin_ghost_ranges *sgr,
  const struct gkyl_range *parent, const int *ghost)
{
  int ndim = parent->ndim;

  for (int d=0; d<ndim; ++d) {
    gkyl_skin_ghost_ranges(&sgr->lower_skin[d], &sgr->lower_ghost[d],
      d, GKYL_LOWER_EDGE, parent, ghost);
    gkyl_skin_ghost_ranges(&sgr->upper_skin[d], &sgr->upper_ghost[d],
      d, GKYL_UPPER_EDGE, parent, ghost);
  }
}

void
test_fem_poisson_perp_consteps(int poly_order, const int *cells, struct gkyl_poisson_bc bcs, bool use_gpu)
{
  double epsilon_0 = 1.0;
  double lower[] = {-M_PI,-M_PI,-M_PI}, upper[] = {M_PI,M_PI,M_PI};
  if ((bcs.lo_type[0]==GKYL_POISSON_DIRICHLET && bcs.up_type[0]==GKYL_POISSON_DIRICHLET) &&
      (bcs.lo_type[1]==GKYL_POISSON_DIRICHLET && bcs.up_type[1]==GKYL_POISSON_DIRICHLET)) {
    lower[0] = 0.;  upper[0] = 1.;
    lower[1] = 0.;  upper[1] = 1.;
  }
  int dim = sizeof(lower)/sizeof(lower[0]);

  // Grids.
  struct gkyl_rect_grid grid;
  gkyl_rect_grid_init(&grid, dim, lower, upper, cells);

  // Basis functions.
  struct gkyl_basis basis;
  gkyl_cart_modal_serendip(&basis, dim, poly_order);

  int ghost[] = { 1, 1, 1 };
  struct gkyl_range localRange, localRange_ext; // local, local-ext ranges.
  gkyl_create_grid_ranges(&grid, ghost, &localRange_ext, &localRange);
  struct skin_ghost_ranges skin_ghost; // skin/ghost.
  skin_ghost_ranges_init(&skin_ghost, &localRange_ext, ghost);

  // Projection updater for DG field.
  gkyl_proj_on_basis *projob, *projob_sol;
  if ((bcs.lo_type[0]==GKYL_POISSON_PERIODIC && bcs.up_type[0]==GKYL_POISSON_PERIODIC) &&
      (bcs.lo_type[1]==GKYL_POISSON_PERIODIC && bcs.up_type[1]==GKYL_POISSON_PERIODIC)) {
    projob = gkyl_proj_on_basis_new(&grid, &basis,
      poly_order+1, 1, evalFunc_consteps_periodicx_periodicy, NULL);
    projob_sol = gkyl_proj_on_basis_new(&grid, &basis,
      2*(poly_order+1), 1, evalFunc_consteps_periodicx_periodicy_sol, NULL);
  } else if ((bcs.lo_type[0]==GKYL_POISSON_DIRICHLET && bcs.up_type[0]==GKYL_POISSON_DIRICHLET) &&
             (bcs.lo_type[1]==GKYL_POISSON_DIRICHLET && bcs.up_type[1]==GKYL_POISSON_DIRICHLET)) {
    projob = gkyl_proj_on_basis_new(&grid, &basis,
      poly_order+1, 1, evalFunc_consteps_dirichletx_dirichlety, NULL);
    projob_sol = gkyl_proj_on_basis_new(&grid, &basis,
      2*(poly_order+1), 1, evalFunc_consteps_dirichletx_dirichlety_sol, NULL);
  }

  // Create DG field we wish to make continuous.
  struct gkyl_array *rho = mkarr(basis.num_basis, localRange_ext.volume);
  // Create array holding continuous field we'll compute.
  struct gkyl_array *phi = mkarr(basis.num_basis, localRange_ext.volume);
  // Create DG field for permittivity tensor.
  int epsnum = PERP_DIM+ceil((pow(3.,PERP_DIM-1)-PERP_DIM)/2);
  struct gkyl_array *eps = use_gpu? mkarr_cu(epsnum*basis.num_basis, localRange_ext.volume)
                                  : mkarr(   epsnum*basis.num_basis, localRange_ext.volume);
  // Analytic solution.
  struct gkyl_array *phisol = mkarr(basis.num_basis, localRange_ext.volume);
  // Device copies:
  struct gkyl_array *rho_cu, *phi_cu;
  if (use_gpu) {
    rho_cu = mkarr_cu(basis.num_basis, localRange_ext.volume);
    phi_cu = mkarr_cu(basis.num_basis, localRange_ext.volume);
  }

  // Project RHS charge density on basis.
  gkyl_proj_on_basis_advance(projob, 0.0, &localRange, rho);
  if (use_gpu) gkyl_array_copy(rho_cu, rho);

  // Project the permittivity onto the basis.
  double dg0norm = pow(sqrt(2.),dim);
  gkyl_array_shiftc(eps, epsilon_0*dg0norm, 0*basis.num_basis);
  gkyl_array_shiftc(eps,        0.*dg0norm, 1*basis.num_basis);
  gkyl_array_shiftc(eps, epsilon_0*dg0norm, 2*basis.num_basis);

  // Project the analytic solution.
  gkyl_proj_on_basis_advance(projob_sol, 0.0, &localRange, phisol);

  // FEM poisson solver.
  gkyl_fem_poisson_perp *poisson = gkyl_fem_poisson_perp_new(&grid, basis, &bcs, eps, NULL, use_gpu);

  // Set the RHS source.
  if (use_gpu)
    gkyl_fem_poisson_perp_set_rhs(poisson, rho_cu);
  else
    gkyl_fem_poisson_perp_set_rhs(poisson, rho);

  // Solve the problem.
  if (use_gpu) {
    gkyl_fem_poisson_perp_solve(poisson, phi_cu);
    gkyl_array_copy(phi, phi_cu);
#ifdef GKYL_HAVE_CUDA
    cudaDeviceSynchronize();
#endif
  } else {
    gkyl_fem_poisson_perp_solve(poisson, phi);
  }

  if (bcs.lo_type[0] == GKYL_POISSON_PERIODIC && bcs.lo_type[1] == GKYL_POISSON_PERIODIC) {
    // This is not strictly necessary, as the potential is only known up to 
    // constant shift, but it makes unit testing more robust across CPU/GPU.
    struct gkyl_array *sol_cellavg = gkyl_array_new(GKYL_DOUBLE, 1, localRange_ext.volume);
    double* sol_avg = (double*) gkyl_malloc(sizeof(double));
    // Factor accounting for normalization when subtracting a constant from a
    // DG field and the 1/N to properly compute the volume averaged RHS.
    double mavgfac = -pow(sqrt(2.),dim)/localRange.volume;
    // Subtract the volume averaged sol from the sol.
    gkyl_array_clear(sol_cellavg, 0.0);
    gkyl_dg_calc_average_range(basis, 0, sol_cellavg, 0, phi, localRange);
    for (int kIdx=0; kIdx<cells[2]; kIdx++) {
      struct gkyl_range perp_range;
      gkyl_range_deflate(&perp_range, &localRange, (int[]){0,0,1}, (int[]){0,0,kIdx+1});
      gkyl_array_reduce_range(sol_avg, sol_cellavg, GKYL_SUM, perp_range);
      gkyl_array_shiftc_range(phi, mavgfac*sol_avg[0], 0, perp_range);
    }
    // Now do the same to the analytic solution.
    gkyl_array_clear(sol_cellavg, 0.0);
    gkyl_dg_calc_average_range(basis, 0, sol_cellavg, 0, phisol, localRange);
    for (int kIdx=0; kIdx<cells[2]; kIdx++) {
      struct gkyl_range perp_range;
      gkyl_range_deflate(&perp_range, &localRange, (int[]){0,0,1}, (int[]){0,0,kIdx+1});
      gkyl_array_reduce_range(sol_avg, sol_cellavg, GKYL_SUM, perp_range);
      gkyl_array_shiftc_range(phisol, mavgfac*sol_avg[0], 0, perp_range);
    }
    gkyl_free(sol_avg);
    gkyl_array_release(sol_cellavg);
  }

  if (poly_order == 1) {
    if ((bcs.lo_type[0] == GKYL_POISSON_PERIODIC && bcs.up_type[0] == GKYL_POISSON_PERIODIC) &&
        (bcs.lo_type[1] == GKYL_POISSON_PERIODIC && bcs.up_type[1] == GKYL_POISSON_PERIODIC)) {
      // Solution; checked convergence:
      const double sol[512] = {
        6.6733979824544519e+01, 1.4901880978824147e+00, -7.9807205716866203e-01, -1.6924047069711307e+01, 4.4550438362487238e-01, -1.8970690865185447e+00,
        1.0159776679335704e+00, -5.6714490961524955e-01, 6.1479872024428538e+01, 1.5806583638107361e+00, -2.2353884955796057e+00, -1.0235357568701435e+01,
        -3.9327135123749946e-01, -2.0122413557009455e+00, 2.8457390160003007e+00, 5.0065016899960901e-01, 5.8188489555517414e+01, -3.7249385009261476e-01,
        3.3510794114774328e-01, -6.0452959633556187e+00, -7.3438160522791363e-01, 4.7419957851839617e-01, -4.2660582023277777e-01, 9.3489717369603287e-01,
        6.1525660224671093e+01, -1.6444801024913476e+00, 1.5916084430198620e+00, -1.0293647780071975e+01, 8.3738264463134659e-16, 2.0934889832124717e+00,
        -2.0261812447606484e+00, 1.2086577382315717e-15, 6.2926927669325373e+01, -8.3545796611353929e-01, -7.8258630664205964e-01, -1.2077517316391553e+01,
        4.6708914821809111e-01, 1.0635714262191946e+00, 9.9626368776736896e-01, -5.9462317877319293e-01, 5.8833667829384758e+01, 2.9007785717557725e-15,
        -1.5806583638107332e+00, -6.8666337262772172e+00, 1.5262733414182595e-02, 2.0934566115783664e-15, 2.0122413557009455e+00, -1.9430070456851564e-02,
        5.8253243849297057e+01, -2.8223628167625781e-01, 1.2455504226629870e+00, -6.1277307708294417e+00, -1.7821192661504992e-01, 3.5929808178096379e-01,
        -1.5856355354681642e+00, 2.2687091469240570e-01, 6.4263440820199946e+01, 6.3821738680605491e-02, 2.2244384163704685e+00, -1.3778952045237286e+01,
        3.7800861782331557e-01, -8.1247627511517040e-02, -2.8317991269405964e+00, -4.8122009854275433e-01, 6.5443254873912451e+01, -2.2353884955796057e+00,
        1.5806583638107390e+00, -1.5280902552236121e+01, 9.2785626525713727e-01, 2.8457390160003020e+00, -2.0122413557009518e+00, -1.1811981588452865e+00,
        6.5664708264854255e+01, 8.3545796611353929e-01, -1.4528021889375404e+00, -1.5562821581556875e+01, 8.4509776604140874e-01, -1.0635714262191871e+00,
        1.8494753282329304e+00, -1.0758432773159485e+00, 6.1525660224671093e+01, 2.2992102342602143e+00, -9.3687831125099519e-01, -1.0293647780071984e+01,
        0.0000000000000000e+00, -2.9269866435118219e+00, 1.1926835844612971e+00, -7.2519464293894292e-16, 6.2060296004516225e+01, 1.9531522139033450e+00,
        1.2455504226629901e+00, -1.0974260524149182e+01, -1.9979669120826693e-01, -2.4864409342193365e+00, -1.5856355354681582e+00, 2.5434918385035249e-01,
        6.4217652619957420e+01, 1.5806583638107246e+00, 0.0000000000000000e+00, -1.3720661833866718e+01, -1.5262733414181339e-02, -2.0122413557009384e+00,
        -1.6747652892626932e-15, 1.9430070456851564e-02, 6.0124392780016827e+01, 7.4520039769718527e-01, -2.3632446704527901e+00, -8.5097782437523932e+00,
        -4.6708914821808944e-01, -9.4866992948175388e-01, 3.0085050434683107e+00, 5.9462317877318926e-01, 5.4916073180143378e+01, -1.6444801024913416e+00,
        -6.4378005255974380e-01, -1.8793789541130723e+00, -9.1259353184295722e-01, 2.0934889832124681e+00, 8.1955777123965357e-01, 1.1617680883884383e+00,
        5.8253243849297057e+01, -3.5338105777140698e+00, 2.5704964367273377e+00, -6.1277307708294355e+00, -1.7821192661504823e-01, 4.4986822899202821e+00,
        -3.2723448362330823e+00, 2.2687091469240425e-01, 5.8188489555517386e+01, -1.9531522139033421e+00, 1.9157663049584752e+00, -6.0452959633556125e+00,
        -7.3438160522791107e-01, 2.4864409342193370e+00, -2.4388471759337245e+00, 9.3489717369603287e-01, 6.1525660224671093e+01, -3.2251384663020750e+00,
        1.0950079209135989e-02, -1.0293647780071979e+01, -8.3738264463134659e-16, 4.1057303389134159e+00, -1.3939889059702615e-02, 4.8346309529262865e-16,
        6.0189147073796484e+01, -3.0708464616931450e+00, -7.8258630664206252e-01, -8.5922130512262367e+00, 8.9080530394774260e-02, 3.9093104422194940e+00,
        9.9626368776737062e-01, -1.1340308023043644e-01, 6.1571448424913633e+01, -2.2353884955795973e+00, 1.5806583638107348e+00, -1.0351937991442522e+01,
        3.9327135123749946e-01, 2.8457390160002993e+00, -2.0122413557009420e+00, -5.0065016899960979e-01, 6.7600611489353639e+01, 3.7249385009262054e-01,
        1.9002805544318597e+00, -1.8027303861953634e+01, 1.1123902230512284e+00, -4.7419957851839745e-01, -2.4191331957675168e+00, -1.4161172722387867e+00,
        6.8135247269198800e+01, 3.8798685980709506e+00, -1.5916084430198649e+00, -1.8707916606030853e+01, 9.1259353184295766e-01, -4.9392279992127666e+00,
        2.0261812447606462e+00, -1.1617680883884363e+00, 6.0124392780016827e+01, 4.6515048255038787e+00, -3.0334605527482692e+00, -8.5097782437523986e+00,
        -4.6708914821808778e-01, -5.9215517979204373e+00, 3.8617166839338704e+00, 5.9462317877318693e-01, 5.4870284979900838e+01, 1.5806583638107332e+00,
        -8.7023357152673167e-15, -1.8210887427425291e+00, -1.3058648830804582e+00, -2.0122413557009495e+00, 8.3738264463134659e-16, 1.6624182573880468e+00,
        6.1525660224671078e+01, 3.8798685980709475e+00, 6.4378005255973803e-01, -1.0293647780071975e+01, -1.2560739669470199e-15, -4.9392279992127683e+00,
        -8.1955777123965101e-01, 4.8346309529262865e-16, 6.2060296004516225e+01, 3.5338105777140756e+00, -3.3510794114773751e-01, -1.0974260524149187e+01,
        -1.9979669120826860e-01, -4.4986822899202821e+00, 4.2660582023278365e-01, 2.5434918385035010e-01, 5.7608065575429727e+01, 1.5806583638107361e+00,
        -2.2353884955796000e+00, -5.3063930079078254e+00, -9.2785626525713982e-01, -2.0122413557009433e+00, 2.8457390160002993e+00, 1.1811981588452887e+00,
        5.3514805735489134e+01, -2.4161163299242698e+00, -1.2785617487318271e-01, -9.5509417793498114e-02, -1.3796826800610495e+00, 3.0758127819201322e+00,
        1.6276602746800942e-01, 1.7563912671616275e+00, 5.8787879629142246e+01, -5.4605269618816754e+00, 3.1722668068305908e+00, -6.8083435149066531e+00,
        -3.7800861782331724e-01, 6.9514693549137094e+00, -4.0384226004615851e+00, 4.8122009854275599e-01, 6.7600611489353668e+01, -4.1885407094829450e+00,
        1.9157663049584650e+00, -1.8027303861953634e+01, 1.1123902230512275e+00, 5.3321799502196381e+00, -2.4388471759337249e+00, -1.4161172722387863e+00,
        6.8181035469441355e+01, -2.9007785717557725e-15, -1.5806583638107303e+00, -1.8766206817401418e+01, 1.3058648830804549e+00, 6.6990611570507727e-15,
        2.0122413557009344e+00, -1.6624182573880431e+00, 6.2926927669325359e+01, 3.0708464616931450e+00, -1.4528021889375433e+00, -1.2077517316391555e+01,
        4.6708914821809444e-01, -3.9093104422194838e+00, 1.8494753282329319e+00, -5.9462317877319437e-01, 6.2926927669325359e+01, -3.0708464616931450e+00,
        1.4528021889375462e+00, -1.2077517316391555e+01, 4.6708914821809444e-01, 3.9093104422194891e+00, -1.8494753282329286e+00, -5.9462317877319371e-01,
        6.8181035469441326e+01, 8.7023357152673167e-15, 1.5806583638107332e+00, -1.8766206817401422e+01, 1.3058648830804567e+00, -4.1869132231567329e-15,
        -2.0122413557009402e+00, -1.6624182573880453e+00, 6.7600611489353668e+01, 4.1885407094829477e+00, -1.9157663049584737e+00, -1.8027303861953634e+01,
        1.1123902230512241e+00, -5.3321799502196354e+00, 2.4388471759337302e+00, -1.4161172722387854e+00, 5.8787879629142232e+01, 5.4605269618816807e+00,
        -3.1722668068305837e+00, -6.8083435149066531e+00, -3.7800861782331391e-01, -6.9514693549137094e+00, 4.0384226004615824e+00, 4.8122009854275455e-01,
        5.3514805735489162e+01, 2.4161163299242783e+00, 1.2785617487318707e-01, -9.5509417793509715e-02, -1.3796826800610484e+00, -3.0758127819201349e+00,
        -1.6276602746801005e-01, 1.7563912671616275e+00, 5.7608065575429727e+01, -1.5806583638107303e+00, 2.2353884955795928e+00, -5.3063930079078308e+00,
        -9.2785626525714238e-01, 2.0122413557009380e+00, -2.8457390160002953e+00, 1.1811981588452889e+00, 6.2060296004516225e+01, -3.5338105777140782e+00,
        3.3510794114773457e-01, -1.0974260524149182e+01, -1.9979669120826987e-01, 4.4986822899202812e+00, -4.2660582023278570e-01, 2.5434918385035227e-01,
        6.1525660224671078e+01, -3.8798685980709506e+00, -6.4378005255973803e-01, -1.0293647780071973e+01, -1.6747652892626932e-15, 4.9392279992127675e+00,
        8.1955777123964890e-01, 4.8346309529262865e-16, 5.4870284979900838e+01, -1.5806583638107274e+00, 1.0152725001145203e-14, -1.8210887427425348e+00,
        -1.3058648830804576e+00, 2.0122413557009402e+00, -2.9308392562097129e-15, 1.6624182573880455e+00, 6.0124392780016827e+01, -4.6515048255038787e+00,
        3.0334605527482750e+00, -8.5097782437524110e+00, -4.6708914821809067e-01, 5.9215517979204293e+00, -3.8617166839338712e+00, 5.9462317877319149e-01,
        6.8135247269198800e+01, -3.8798685980709444e+00, 1.5916084430198592e+00, -1.8707916606030860e+01, 9.1259353184296266e-01, 4.9392279992127639e+00,
        -2.0261812447606413e+00, -1.1617680883884383e+00, 6.7600611489353668e+01, -3.7249385009261476e-01, -1.9002805544318540e+00, -1.8027303861953644e+01,
        1.1123902230512233e+00, 4.7419957851839073e-01, 2.4191331957675120e+00, -1.4161172722387858e+00, 6.1571448424913662e+01, 2.2353884955795973e+00,
        -1.5806583638107303e+00, -1.0351937991442533e+01, 3.9327135123749946e-01, -2.8457390160002989e+00, 2.0122413557009438e+00, -5.0065016899960779e-01,
        6.0189147073796512e+01, 3.0708464616931450e+00, 7.8258630664205386e-01, -8.5922130512262331e+00, 8.9080530394775523e-02, -3.9093104422194882e+00,
        -9.9626368776736685e-01, -1.1340308023043644e-01, 6.1525660224671093e+01, 3.2251384663020808e+00, -1.0950079209131637e-02, -1.0293647780071975e+01,
        2.0934566115783664e-15, -4.1057303389134168e+00, 1.3939889059700521e-02, -1.9338523811705146e-15, 5.8188489555517400e+01, 1.9531522139033510e+00,
        -1.9157663049584766e+00, -6.0452959633556151e+00, -7.3438160522791363e-01, -2.4864409342193441e+00, 2.4388471759337240e+00, 9.3489717369603242e-01,
        5.8253243849297071e+01, 3.5338105777140756e+00, -2.5704964367273435e+00, -6.1277307708294675e+00, -1.7821192661505283e-01, -4.4986822899202856e+00,
        3.2723448362330787e+00, 2.2687091469240545e-01, 5.4916073180143385e+01, 1.6444801024913358e+00, 6.4378005255973803e-01, -1.8793789541130983e+00,
        -9.1259353184295977e-01, -2.0934889832124712e+00, -8.1955777123964768e-01, 1.1617680883884378e+00, 6.0124392780016841e+01, -7.4520039769719393e-01,
        2.3632446704528016e+00, -8.5097782437524110e+00, -4.6708914821808650e-01, 9.4866992948174844e-01, -3.0085050434683129e+00, 5.9462317877318960e-01,
        6.4217652619957448e+01, -1.5806583638107332e+00, -5.8015571435115450e-15, -1.3720661833866741e+01, -1.5262733414182177e-02, 2.0122413557009393e+00,
        1.6747652892626932e-15, 1.9430070456854465e-02, 6.2060296004516239e+01, -1.9531522139033510e+00, -1.2455504226629901e+00, -1.0974260524149194e+01,
        -1.9979669120827070e-01, 2.4864409342193392e+00, 1.5856355354681633e+00, 2.5434918385034982e-01, 6.1525660224671093e+01, -2.2992102342602201e+00,
        9.3687831125099230e-01, -1.0293647780071975e+01, 3.3495305785253864e-15, 2.9269866435118241e+00, -1.1926835844612913e+00, 4.8346309529262865e-16,
        6.5664708264854227e+01, -8.3545796611354506e-01, 1.4528021889375347e+00, -1.5562821581556863e+01, 8.4509776604140463e-01, 1.0635714262191922e+00,
        -1.8494753282329337e+00, -1.0758432773159463e+00, 6.5443254873912451e+01, 2.2353884955796000e+00, -1.5806583638107274e+00, -1.5280902552236126e+01,
        9.2785626525714648e-01, -2.8457390160003002e+00, 2.0122413557009411e+00, -1.1811981588452922e+00, 6.4263440820199946e+01, -6.3821738680617093e-02,
        -2.2244384163704769e+00, -1.3778952045237309e+01, 3.7800861782331935e-01, 8.1247627511529183e-02, 2.8317991269405960e+00, -4.8122009854275527e-01,
        5.8253243849297071e+01, 2.8223628167625781e-01, -1.2455504226629901e+00, -6.1277307708294613e+00, -1.7821192661504739e-01, -3.5929808178095662e-01,
        1.5856355354681666e+00, 2.2687091469240400e-01, 5.8833667829384758e+01, 0.0000000000000000e+00, 1.5806583638107419e+00, -6.8666337262772341e+00,
        1.5262733414178827e-02, 2.5121479338940399e-15, -2.0122413557009451e+00, -1.9430070456850114e-02, 6.2926927669325373e+01, 8.3545796611353640e-01,
        7.8258630664205675e-01, -1.2077517316391562e+01, 4.6708914821809150e-01, -1.0635714262191875e+00, -9.9626368776736518e-01, -5.9462317877319315e-01,
        6.1525660224671093e+01, 1.6444801024913445e+00, -1.5916084430198649e+00, -1.0293647780071979e+01, 8.3738264463134659e-16, -2.0934889832124690e+00,
        2.0261812447606484e+00, 7.2519464293894292e-16, 5.8188489555517414e+01, 3.7249385009261188e-01, -3.3510794114773895e-01, -6.0452959633556098e+00,
        -7.3438160522791407e-01, -4.7419957851839495e-01, 4.2660582023278193e-01, 9.3489717369603165e-01, 6.1479872024428538e+01, -1.5806583638107332e+00,
        2.2353884955795973e+00, -1.0235357568701419e+01, -3.9327135123749524e-01, 2.0122413557009438e+00, -2.8457390160002998e+00, 5.0065016899960857e-01,
        6.6733979824544519e+01, -1.4901880978824147e+00, 7.9807205716867657e-01, -1.6924047069711310e+01, 4.4550438362486572e-01, 1.8970690865185462e+00,
        -1.0159776679335797e+00, -5.6714490961524522e-01,
      };
      long i = 0;
      struct gkyl_range_iter iter;
      gkyl_range_iter_init(&iter, &localRange);
      while (gkyl_range_iter_next(&iter)) {
        long loc = gkyl_range_idx(&localRange, iter.idx);
        const double *phi_p = gkyl_array_cfetch(phi, loc);
        if (iter.idx[2] == 3) {
          // Only check one cell in z:
          for (int m=0; m<basis.num_basis; m++) {
            TEST_CHECK( gkyl_compare(sol[i], phi_p[m], 1e-12) );
            TEST_MSG("Expected: %.13e in cell (%d,%d,%d)", sol[i], iter.idx[0], iter.idx[1], iter.idx[2]);
            TEST_MSG("Produced: %.13e", phi_p[m]);
            i += 1;
          }
        }
      }
    } else if ((bcs.lo_type[0] == GKYL_POISSON_DIRICHLET && bcs.up_type[0] == GKYL_POISSON_DIRICHLET) &&
               (bcs.lo_type[1] == GKYL_POISSON_DIRICHLET && bcs.up_type[1] == GKYL_POISSON_DIRICHLET)) {
      // Solution; checked convergence:
      const double sol[512] = {
        -1.4857902425065184e-04, -8.5782139646996372e-05, -8.5782139646865672e-05, 1.8914704406197892e-04, -4.9526341416772864e-05, 1.0920409680558287e-04,
        1.0920409680550554e-04, 6.3049014687256998e-05, -3.7869881831633913e-04, -2.1864186469671895e-04, -4.7077585402820190e-05, 4.8209875139245301e-04,
        -2.7180256605144123e-05, 2.7833984389239624e-04, 5.9931650281304105e-05, 3.4601554422903200e-05, -4.8238508035628331e-04, -2.7850515599677118e-04,
        -1.2785705897207671e-05, 6.1409551253425998e-04, -7.3818307415179943e-06, 3.5454820946987623e-04, 1.6276715296076932e-05, 9.3973659577562421e-06,
        -4.7821812488875947e-04, -2.7609936313588445e-04, 1.5191498758083683e-05, 6.0879081146090802e-04, 8.7708158973654205e-06, 3.5148553887719326e-04,
        -1.9339385888747259e-05, -1.1165599648880918e-05, -3.9208040614287438e-04, -2.2636772803058295e-04, 3.4540136347233381e-05, 4.9913404823207755e-04,
        1.9941757017920681e-05, 2.8817517710849280e-04, -4.3970975879881029e-05, -2.5386654760770837e-05, -2.5807022372215224e-04, -1.4899691313582957e-04,
        4.2830678547521361e-05, 3.2853372287024223e-04, 2.4728303788985857e-05, 1.8967903333702248e-04, -5.4525167891612326e-05, -3.1480120359827638e-05,
        -1.1891747993225567e-04, -6.8657039050248661e-05, 3.7509195538050490e-05, 1.5138671107812069e-04, 2.1655944140984915e-05, 8.7403158392697900e-05,
        -4.7750707052706831e-05, -2.7568883570882659e-05, -2.6974823754671981e-05, -1.5573921756102582e-05, 1.5573921756086665e-05, 3.4340030182754069e-05,
        8.9916079182148039e-06, 1.9826225669992933e-05, -1.9826225669985302e-05, -1.1446676727580283e-05, -3.7869881831637274e-04, -4.7077585402708903e-05,
        -2.1864186469670288e-04, 4.8209875139248608e-04, -2.7180256605210324e-05, 5.9931650281245863e-05, 2.7833984389239038e-04, 3.4601554422944427e-05,
        -9.6593915317034899e-04, -1.2040150071024966e-04, -1.2040150071024630e-04, 1.2296791992509439e-03, -1.5153325635635661e-05, 1.5327592891960440e-04,
        1.5327592891959123e-04, 1.9290789976223312e-05, -1.2313170233906195e-03, -1.5389090291881229e-04, -3.2814484098396489e-05, 1.5675158485681691e-03,
        -4.1817897444776702e-06, 1.9590927819016461e-04, 4.1774151505829872e-05, 5.3235857015899117e-06, -1.2211748055640191e-03, -1.5284687644820770e-04,
        3.8670096290763775e-05, 1.5546043993793627e-03, 4.7845587083223804e-06, 1.9458019071073231e-04, -4.9228580170615438e-05, -6.0909347156166817e-06,
        -1.0016098602570024e-03, -1.2554426638121464e-04, 8.8095783986847693e-05, 1.2750894369280114e-03, 1.0978610563435414e-05, 1.5982287543424525e-04,
        -1.1214945864320036e-04, -1.3976210615571825e-05, -6.5979684339352812e-04, -8.2940058872077652e-05, 1.0925005331179741e-04, 8.3994778696934870e-04,
        1.3618940110575512e-05, 1.0558601423795712e-04, -1.3907969009605144e-04, -1.7337455796105482e-05, -3.0491150826769746e-04, -3.8726663276881513e-05,
        9.5643090454551556e-05, 3.8816455270337567e-04, 1.1907675738098372e-05, 4.9300592207781632e-05, -1.2175748182276777e-04, -1.5158947764468026e-05,
        -6.9626408103776196e-05, -9.0509819492167675e-06, 4.0198825461396472e-05, 8.8637203992388735e-05, 5.2255868648144249e-06, 1.1522262245235528e-05,
        -5.1174713585175428e-05, -6.6523812089424644e-06, -4.8238508035620151e-04, -1.2785705897252288e-05, -2.7850515599680664e-04, 6.1409551253430368e-04,
        -7.3818307414815423e-06, 1.6276715296141225e-05, 3.5454820946987097e-04, 9.3973659577153728e-06, -1.2313170233906072e-03, -3.2814484098386040e-05,
        -1.5389090291881698e-04, 1.5675158485681897e-03, -4.1817897444823730e-06, 4.1774151505828591e-05, 1.9590927819015664e-04, 5.3235857015929212e-06,
        -1.5708705777981958e-03, -4.2150433122696279e-05, -4.2150433122698495e-05, 1.9997811123959371e-03, -1.2083229378437410e-06, 5.3659188242121851e-05,
        5.3659188242117866e-05, 1.5382434574345833e-06, -1.5587645637327890e-03, -4.2060661306192221e-05, 4.9139843602174565e-05, 1.9843696720032254e-03,
        1.2601527202679231e-06, 5.3544905127007844e-05, -6.2556987501449741e-05, -1.6042248447095148e-06, -1.2792161864866266e-03, -3.4731820796201924e-05,
        1.1225748725242052e-04, 1.6284934001327763e-03, 2.9711553210228856e-06, 4.4214997854706335e-05, -1.4290827386115453e-04, -3.7823996304679761e-06,
        -8.4357750896041524e-04, -2.3165757864813304e-05, 1.3925862048675021e-04, 1.0739079292105724e-03, 3.7065142258784857e-06, 2.9490936864656485e-05,
        -1.7728179706443526e-04, -4.7185409457017731e-06, -3.9114247992314450e-04, -1.1058811420873844e-05, 1.2195486531873429e-04, 4.9794003061819580e-04,
        3.2834345625943677e-06, 1.4078309516759583e-05, -1.5525342423245637e-04, -4.1799436025258761e-06, -8.9955228480428413e-05, -2.6858679675509360e-06,
        5.1935675378201352e-05, 1.1451660589930813e-04, 1.5506865940911167e-06, 3.4192174121908953e-06, -6.6116193242601623e-05, -1.9740860933638614e-06,
        -4.7821812488872613e-04, 1.5191498758100369e-05, -2.7609936313588413e-04, 6.0879081146098728e-04, 8.7708158973496454e-06, -1.9339385888790925e-05,
        3.5148553887716583e-04, -1.1165599648852878e-05, -1.2211748055639972e-03, 3.8670096290759126e-05, -1.5284687644821456e-04, 1.5546043993793848e-03,
        4.7845587083257541e-06, -4.9228580170613290e-05, 1.9458019071072680e-04, -6.0909347156182750e-06, -1.5587645637327831e-03, 4.9139843602175452e-05,
        -4.2060661306194789e-05, 1.9843696720032327e-03, 1.2601527202678208e-06, -6.2556987501449768e-05, 5.3544905127004523e-05, -1.6042248447091459e-06,
        -1.5474982642617466e-03, 4.8565262338569481e-05, 4.8565262338568776e-05, 1.9700272218948593e-03, -1.5918873674820159e-06, -6.1825522557911871e-05,
        -6.1825522557912508e-05, 2.0265363267635107e-06, -1.2706869384245629e-03, 3.9656184460819470e-05, 1.1125183114826664e-04, 1.6176353260059105e-03,
        -3.5517711434683191e-06, -5.0483909874733382e-05, -1.4162803339381479e-04, 4.5215468089140504e-06, -8.3879554668975795e-04, 2.5926625069031862e-05,
        1.3810078013050519e-04, 1.0678202998640151e-03, -4.3749936672351580e-06, -3.3005631306618052e-05, -1.7580781995370960e-04, 5.5695420273585997e-06,
        -3.8988499721200347e-04, 1.1784819402652368e-05, 1.2107784645253936e-04, 4.9633920480195821e-04, -3.7897816410764171e-06, -1.5002546732690018e-05,
        -1.5413694411715089e-04, 4.8245436976423641e-06, -9.0086007742574192e-05, 2.6103625253466520e-06, 5.2011180820413507e-05, 1.1468309313383139e-04,
        -1.5070935067046508e-06, -3.3230959625222529e-06, -6.6212314692308015e-05, 1.9185903485009741e-06, -3.9208040614284722e-04, 3.4540136347213093e-05,
        -2.2636772803059100e-04, 4.9913404823208253e-04, 1.9941757017931554e-05, -4.3970975879880263e-05, 2.8817517710850375e-04, -2.5386654760776736e-05,
        -1.0016098602569918e-03, 8.8095783986845972e-05, -1.2554426638121602e-04, 1.2750894369280275e-03, 1.0978610563435211e-05, -1.1214945864320599e-04,
        1.5982287543424081e-04, -1.3976210615569642e-05, -1.2792161864866210e-03, 1.1225748725241937e-04, -3.4731820796203604e-05, 1.6284934001327808e-03,
        2.9711553210233968e-06, -1.4290827386115594e-04, 4.4214997854704112e-05, -3.7823996304677249e-06, -1.2706869384245618e-03, 1.1125183114826646e-04,
        3.9656184460818718e-05, 1.6176353260059101e-03, -3.5517711434682683e-06, -1.4162803339381555e-04, -5.0483909874733890e-05, 4.5215468089141537e-06,
        -1.0441173998824859e-03, 9.1153799606617992e-05, 9.1153799606618073e-05, 1.3292032360397348e-03, -8.0518327772840401e-06, -1.1604243491016443e-04,
        -1.1604243491016380e-04, 1.0250305362999503e-05, -6.9005433895489503e-04, 5.9949151256281410e-05, 1.1326460393002962e-04, 8.7846678973585207e-04,
        -9.9641793477503907e-06, -7.6317668737877270e-05, -1.4419037369695810e-04, 1.2684799080065410e-05, -3.2161392308227690e-04, 2.7631503624010198e-05,
        9.9454569354364179e-05, 4.0942739519954688e-04, -8.6944232123168641e-06, -3.5176009937019723e-05, -1.2660964699911679e-04, 1.1068348703517426e-05,
        -7.4676777957819192e-05, 6.2861604388864368e-06, 4.3114657856159156e-05, 9.5066526934358737e-05, -3.6293164215592856e-06, -8.0025338133193964e-06,
        -5.4886684916474010e-05, 4.6202650513188232e-06, -2.5807022372216449e-04, 4.2830678547518969e-05, -1.4899691313582071e-04, 3.2853372287025562e-04,
        2.4728303788984804e-05, -5.4525167891608260e-05, 1.8967903333701682e-04, -3.1480120359831297e-05, -6.5979684339352498e-04, 1.0925005331179476e-04,
        -8.2940058872077706e-05, 8.3994778696934924e-04, 1.3618940110576470e-05, -1.3907969009605478e-04, 1.0558601423795538e-04, -1.7337455796106072e-05,
        -8.4357750896041372e-04, 1.3925862048674929e-04, -2.3165757864814100e-05, 1.0739079292105683e-03, 3.7065142258784857e-06, -1.7728179706443878e-04,
        2.9490936864655540e-05, -4.7185409457013005e-06, -8.3879554668975860e-04, 1.3810078013050441e-04, 2.5926625069031462e-05, 1.0678202998640096e-03,
        -4.3749936672350818e-06, -1.7580781995371169e-04, -3.3005631306617849e-05, 5.5695420273589242e-06, -6.9005433895489578e-04, 1.1326460393002904e-04,
        5.9949151256281458e-05, 8.7846678973584904e-04, -9.9641793477503653e-06, -1.4419037369695927e-04, -7.6317668737876267e-05, 1.2684799080065638e-05,
        -4.5700790975607651e-04, 7.4600267375337498e-05, 7.4600267375337959e-05, 5.8178935875592588e-04, -1.2358685770139086e-05, -9.4969125900869786e-05,
        -9.4969125900869000e-05, 1.5733101584855904e-05, -2.1405750025111815e-04, 3.4466226050632516e-05, 6.5667216952079626e-05, 2.7250376448509594e-04,
        -1.0812713792346902e-05, -4.3876885114389393e-05, -8.3596995207867956e-05, 1.3765017386719724e-05, -5.0159272049234077e-05, 7.8690281972934216e-06,
        2.8959469219980895e-05, 6.3854760712488500e-05, -4.5431855479681580e-06, -1.0017587816761052e-05, -3.6866563286394175e-05, 5.7836570226375672e-06,
        -1.1891747993226251e-04, 3.7509195538055992e-05, -6.8657039050244378e-05, 1.5138671107812595e-04, 2.1655944140983332e-05, -4.7750707052715593e-05,
        8.7403158392689037e-05, -2.7568883570880843e-05, -3.0491150826769691e-04, 9.5643090454552613e-05, -3.8726663276881581e-05, 3.8816455270336027e-04,
        1.1907675738097432e-05, -1.2175748182277376e-04, 4.9300592207778536e-05, -1.5158947764468221e-05, -3.9114247992314591e-04, 1.2195486531873341e-04,
        -1.1058811420874908e-05, 4.9794003061817552e-04, 3.2834345625941889e-06, -1.5525342423246220e-04, 1.4078309516759917e-05, -4.1799436025256102e-06,
        -3.8988499721200818e-04, 1.2107784645253757e-04, 1.1784819402651616e-05, 4.9633920480194390e-04, -3.7897816410767364e-06, -1.5413694411715395e-04,
        -1.5002546732686913e-05, 4.8245436976436923e-06, -3.2161392308228053e-04, 9.9454569354363149e-05, 2.7631503624011527e-05, 4.0942739519954103e-04,
        -8.6944232123161492e-06, -1.2660964699911720e-04, -3.5176009937017941e-05, 1.1068348703517651e-05, -2.1405750025111896e-04, 6.5667216952079626e-05,
        3.4466226050632868e-05, 2.7250376448509437e-04, -1.0812713792346967e-05, -8.3596995207868051e-05, -4.3876885114388695e-05, 1.3765017386719678e-05,
        -1.0163877852160976e-04, 3.0438753201852812e-05, 3.0438753201852917e-05, 1.2939023268193514e-04, -9.5264492369834572e-06, -3.8749750996843554e-05,
        -3.8749750996843378e-05, 1.2127551130928198e-05, -2.4458655728475410e-05, 6.9692295538358886e-06, 1.4121211468851588e-05, 3.1136847587379800e-05,
        -4.0236865589514017e-06, -8.8721081333432448e-06, -1.7976867336290102e-05, 5.1223140190652031e-06, -2.6974823754661329e-05, 1.5573921756091266e-05,
        -1.5573921756096677e-05, 3.4340030182743030e-05, 8.9916079182173179e-06, -1.9826225669985950e-05, 1.9826225669986620e-05, -1.1446676727580623e-05,
        -6.9626408103756491e-05, 4.0198825461406474e-05, -9.0509819492174502e-06, 8.8637203992336435e-05, 5.2255868648150289e-06, -5.1174713585190749e-05,
        1.1522262245218026e-05, -6.6523812089505900e-06, -8.9955228480439079e-05, 5.1935675378196955e-05, -2.6858679675677970e-06, 1.1451660589925285e-04,
        1.5506865940821917e-06, -6.6116193242616016e-05, 3.4192174122066818e-06, -1.9740860933552026e-06, -9.0086007742595225e-05, 5.2011180820405816e-05,
        2.6103625253575236e-06, 1.1468309313381435e-04, -1.5070935066976264e-06, -6.6212314692306511e-05, -3.3230959625159697e-06, 1.9185903485014870e-06,
        -7.4676777957820601e-05, 4.3114657856161548e-05, 6.2861604388869069e-06, 9.5066526934354780e-05, -3.6293164215604896e-06, -5.4886684916472533e-05,
        -8.0025338133181208e-06, 4.6202650513183065e-06, -5.0159272049234396e-05, 2.8959469219981146e-05, 7.8690281972935876e-06, 6.3854760712487497e-05,
        -4.5431855479681952e-06, -3.6866563286393782e-05, -1.0017587816760623e-05, 5.7836570226374503e-06, -2.4458655728475423e-05, 1.4121211468851677e-05,
        6.9692295538358971e-06, 3.1136847587379671e-05, -4.0236865589514525e-06, -1.7976867336290004e-05, -8.8721081333431685e-06, 5.1223140190651497e-06,
        -6.1937980258105384e-06, 3.5759909575078880e-06, 3.5759909575078880e-06, 7.8849527650921135e-06, -2.0645993419368465e-06, -4.5523796014734159e-06,
        -4.5523796014734159e-06, 2.6283175883640376e-06,
      };
      long i = 0;
      struct gkyl_range_iter iter;
      gkyl_range_iter_init(&iter, &localRange);
      while (gkyl_range_iter_next(&iter)) {
        long loc = gkyl_range_idx(&localRange, iter.idx);
        const double *phi_p = gkyl_array_cfetch(phi, loc);
        if (iter.idx[2] == 3) {
          // Only check one cell in z:
          for (int m=0; m<basis.num_basis; m++) {
            TEST_CHECK( gkyl_compare(sol[i], phi_p[m], 1e-12) );
            TEST_MSG("Expected: %.13e in cell (%d,%d,%d)", sol[i], iter.idx[0], iter.idx[1], iter.idx[2]);
            TEST_MSG("Produced: %.13e", phi_p[m]);
            i += 1;
          }
        }
      }
    }
  } else if (poly_order == 2) {
    if ((bcs.lo_type[0] == GKYL_POISSON_PERIODIC && bcs.up_type[0] == GKYL_POISSON_PERIODIC) &&
        (bcs.lo_type[1] == GKYL_POISSON_PERIODIC && bcs.up_type[1] == GKYL_POISSON_PERIODIC)) {
      // Solution; checked convergence but note that p=2 serendipity doesn't
      // converge as p+1. One must use tensor basis and a RHS in the space of
      // the basis for that.
      const double sol[640] = {
        9.1994869871553213e+00, 1.4782758980221793e+00, -1.0143961216287405e+00, -6.3839154872933115e+00, 4.1786262474674196e-01, -1.8819043793655383e+00,
        1.2913668593654493e+00, 1.4300160023058242e-01, -4.3919645391728451e-01, -1.9330590373010010e+00, 2.2867838330434229e+00, 1.6993190682438211e+00,
        -2.2418353145413410e+00, 2.4162322769922677e+00, -3.4316478965842906e-01, -2.1633011812923657e+00, 2.8539460745428227e+00, 5.2659329213503847e-01,
        1.2999235352023858e-01, -1.9330590373009868e+00, -1.3739075881044782e+00, -3.9077797649552898e-01, 4.6941444639961344e-01, 7.0764389584251042e+00,
        -6.5917730762051729e-01, 4.9747600316723956e-01, -5.9758337641762016e-01, 5.4963863363049148e-01, 3.9419202503096168e-01, -1.9330590373009717e+00,
        3.7492710927634949e+00, -1.7069809072513826e+00, 1.8181896694868833e+00, 5.5442746605282345e-01, -3.4890943526306153e-17, 2.1730550089788023e+00,
        -2.3146282139230347e+00, 1.2499260451994691e-01, -1.2499260451994729e-01, -1.9330590373009773e+00, 6.4771432426136206e+00, -7.0755542166833474e-01,
        -5.2355818804679921e-01, -2.9182629512235483e+00, 4.1518369083043127e-01, 9.0074636843026556e-01, 6.6651052638833952e-01, -3.2079725539104981e-01,
        -3.4211688329996620e-01, -1.9330590373009855e+00, 1.8242833702772732e+00, 1.6136475856828053e-01, -1.4711148381874981e+00, 3.0050138755441371e+00,
        -1.8942923385733466e-03, -2.0542379553857620e-01, 1.8727880636075585e+00, -4.5294792043656290e-01, 1.9363822721812982e-01, -1.9330590373009775e+00,
        6.9436172938949503e-01, -3.7994249985831463e-01, 1.0685398632759264e+00, 4.4434493443031045e+00, -1.7386900795665608e-01, 4.8368200776802417e-01,
        -1.3602940093361680e+00, -3.7184297847002329e-01, 3.8712131218628837e-01, -1.9330590373009775e+00, 7.1367460749697651e+00, -1.5370291956071835e-01,
        1.8947604832419560e+00, -3.7579637543778759e+00, 3.4505908199700286e-01, 1.9566996785213189e-01, -2.4121059242273470e+00, -1.9863797621842180e-01,
        -1.9863797621842161e-01, -1.9330590373009939e+00, 1.0002371414519242e+01, -2.2418353145413401e+00, 1.6993190682438220e+00, -7.4060194950783949e+00,
        8.3115202323860060e-01, 2.8539460745428222e+00, -2.1633011812923657e+00, -8.0750981210547534e-01, -4.1090887349067545e-01, -1.9330590373009935e+00,
        9.8646182248199068e+00, 9.3575965172465769e-01, -1.5569123679262624e+00, -7.2306541716542734e+00, 7.6024277282743391e-01, -1.1912594861150763e+00,
        1.9820117526159109e+00, -8.2119407263786359e-01, -2.3899601848999627e-01, -1.9330590373009924e+00, 3.7492710927634967e+00, 2.2494971535489037e+00,
        -1.2756734231893618e+00, 5.5442746605282456e-01, -2.1806839703941321e-16, -2.8636999022292637e+00, 1.6239833206725718e+00, -3.0175884102839168e-01,
        3.0175884102839162e-01, -1.9330590373009782e+00, 3.4167054739312039e+00, 1.7005280561147440e+00, 8.4033563321960181e-01, 9.7779680823329895e-01,
        -1.7119007404034639e-01, -2.1648402712362187e+00, -1.0697808916513611e+00, 2.6872211366005339e-01, 1.1327550506052561e-01, -1.9330590373009842e+00,
        5.6742588152497007e+00, 1.4711148381874968e+00, -1.6136475856828308e-01, -1.8961589434384727e+00, 1.8942923385739049e-03, -1.8727880636075545e+00,
        2.0542379553857484e-01, 6.2971415694500765e-01, -3.7040446372657460e-01, -1.9330590373009953e+00, 1.0213989429133545e+00, 9.2492417508744407e-01,
        -2.1560377848025762e+00, 4.0271178833292076e+00, -4.1518369083043200e-01, -1.1774654907158630e+00, 2.7447223855344682e+00, 7.4754870093938686e-01,
        -8.4634562248371986e-02, -1.9330590373009868e+00, -4.4288169514784803e+00, -1.4787766771950606e+00, -2.6228088648617798e-01, 1.0965460836675373e+01,
        -8.3304631557717390e-01, 1.8825418912939922e+00, 3.3389406508121999e-01, 4.7955449618885920e-01, 4.7955449618885992e-01, -1.9330590373009682e+00,
        6.9436172938949769e-01, -3.5612118829268455e+00, 2.8726145195092374e+00, 4.4434493443030956e+00, -1.7386900795665605e-01, 4.5335652480671547e+00,
        -3.6569532464990187e+00, -1.9507674196157709e-01, 2.1035507567784281e-01, -1.9330590373009724e+00, -1.3739075881044789e+00, -2.0232575732513061e+00,
        2.1018940431553919e+00, 7.0764389584251042e+00, -6.5917730762051818e-01, 2.5756878623133668e+00, -2.6757952355637471e+00, 9.7639007917882992e-01,
        -3.2559420517375502e-02, -1.9330590373009826e+00, 3.7492710927634914e+00, -3.0167309868705989e+00, 5.0843958986766580e-01, 5.5442746605283311e-01,
        -3.1401849173675498e-16, 3.8404192770477854e+00, -6.4726394585405234e-01, 3.0175884102839190e-01, -3.0175884102839090e-01, -1.9330590373009886e+00,
        3.0896682604073433e+00, -2.7880259776413983e+00, -2.9535395799047620e-01, 1.3941282692071895e+00, 7.0124608833427984e-02, 3.5492686474345216e+00,
        3.7599740870352816e-01, -4.2391812020101916e-01, 1.5827993394684664e-01, -1.9330590373009862e+00, 5.2117583524835558e+00, -2.2418353145413441e+00,
        1.6993190682438206e+00, -1.3073773448865962e+00, 3.4316478965842984e-01, 2.8539460745428276e+00, -2.1633011812923639e+00, -9.5334473768337680e-01,
        2.9675909202809891e-01, -1.9330590373009904e+00, 1.2259924755837741e+01, 1.6257374643920416e-01, 1.6110561095734450e+00, -1.0279975246750174e+01,
        1.0042363896175204e+00, -2.0696288548242750e-01, -2.0509389025866334e+00, -1.0500354508773042e+00, -2.9107116022099322e-01, -1.9330590373010024e+00,
        1.1927359137005450e+01, 3.7874514632244427e+00, -2.0463938995432045e+00, -9.8566059045696974e+00, 8.3304631557717468e-01, -4.8215772879830521e+00,
        2.6051413316078462e+00, -4.7955449618885959e-01, -4.7955449618885959e-01, -1.9330590373010064e+00, 1.0213989429133548e+00, 4.6487098044534978e+00,
        -3.4175961947383637e+00, 4.0271178833292129e+00, -4.1518369083043161e-01, -5.9179936242654509e+00, 4.3507367294468482e+00, 4.9756349189949323e-01,
        1.6535064679152264e-01, -1.9330590373009855e+00, -5.8913042111985385e+00, 1.4711148381874986e+00, -1.6136475856828034e-01, 1.2827265647614789e+01,
        -1.1762111052356028e+00, -1.8727880636075553e+00, 2.0542379553857459e-01, 1.1311403928438437e+00, 4.8455424518915025e-01, -1.9330590373009708e+00,
        3.7492710927634976e+00, 3.5592472331681186e+00, 3.4076656429852192e-02, 5.5442746605283011e-01, -1.7445471763153057e-16, -4.5310641702982393e+00,
        -4.3380947396403212e-02, -1.2499260451994640e-01, 1.2499260451994611e-01, -1.9330590373009944e+00, 3.4167054739311977e+00, 3.3330076528705233e+00,
        -7.9214396353617711e-01, 9.7779680823332127e-01, -1.7119007404034625e-01, -4.2430521303823445e+00, 1.0084309674947700e+00, 6.9547355920839227e-01,
        -3.1347594048781280e-01, -1.9330590373010048e+00, -2.5038292289922657e+00, 1.6993190682438204e+00, -2.2418353145413432e+00, 8.5148744271840826e+00,
        -8.3115202323860005e-01, -2.1633011812923590e+00, 2.8539460745428240e+00, 1.2342612576538132e+00, -1.5842572057663946e-02, -1.9330590373010026e+00,
        -7.1566891013286176e+00, -2.2455097313438772e+00, 2.4716228830704615e-01, 1.4438151253951753e+01, -1.2482300064076055e+00, 2.8586237541840607e+00,
        -3.1464748454693564e-01, 1.1021105926083008e+00, 5.1991253846043495e-01, -1.9330590373009910e+00, 3.6179611055720184e-01, -5.4199310599802208e+00,
        3.6788734962989857e+00, 4.8668186864835681e+00, -3.4505908199700158e-01, 6.8997891471291792e+00, -4.6833531907539729e+00, 1.9863797621842333e-01,
        1.9863797621842125e-01, -1.9330590373009904e+00, 1.2259924755837741e+01, -4.1037281292243657e+00, 2.3300982732117177e+00, -1.0279975246750165e+01,
        1.0042363896175188e+00, 5.2242101413176201e+00, -2.9663083532485532e+00, -8.7326921436885874e-01, -4.6783739672943808e-01, -1.9330590373010024e+00,
        1.3389846396725520e+01, 1.6136475856828153e-01, -1.4711148381874970e+00, -1.1718410715509121e+01, 1.1762111052356028e+00, -2.0542379553857562e-01,
        1.8727880636075476e+00, -1.3079066293522899e+00, -3.0778800868070427e-01, -1.9330590373009999e+00, 6.4771432426136286e+00, 3.0162302076977179e+00,
        -1.7851165979825843e+00, -2.9182629512235518e+00, 4.1518369083043161e-01, -3.8397817651193278e+00, 2.2725248703007228e+00, -9.2431493744783333e-01,
        2.6140079875681632e-01, -1.9330590373009899e+00, 6.4771432426136260e+00, -3.0162302076977183e+00, 1.7851165979825847e+00, -2.9182629512235265e+00,
        4.1518369083043294e-01, 3.8397817651193300e+00, -2.2725248703007148e+00, -9.2431493744783200e-01, 2.6140079875681660e-01, -1.9330590373009957e+00,
        1.3389846396725517e+01, -1.6136475856827953e-01, 1.4711148381874954e+00, -1.1718410715509096e+01, 1.1762111052356032e+00, 2.0542379553857748e-01,
        -1.8727880636075547e+00, -1.3079066293522874e+00, -3.0778800868070627e-01, -1.9330590373010164e+00, 1.2259924755837737e+01, 4.1037281292243675e+00,
        -2.3300982732117155e+00, -1.0279975246750144e+01, 1.0042363896175199e+00, -5.2242101413176192e+00, 2.9663083532485568e+00, -8.7326921436885940e-01,
        -4.6783739672943836e-01, -1.9330590373010252e+00, 3.6179611055719585e-01, 5.4199310599802253e+00, -3.6788734962989853e+00, 4.8668186864835832e+00,
        -3.4505908199700297e-01, -6.8997891471291855e+00, 4.6833531907539649e+00, 1.9863797621842202e-01, 1.9863797621842372e-01, -1.9330590373010066e+00,
        -7.1566891013286122e+00, 2.2455097313438741e+00, -2.4716228830704279e-01, 1.4438151253951739e+01, -1.2482300064076062e+00, -2.8586237541840549e+00,
        3.1464748454692920e-01, 1.1021105926083008e+00, 5.1991253846043384e-01, -1.9330590373009833e+00, -2.5038292289922612e+00, -1.6993190682438226e+00,
        2.2418353145413401e+00, 8.5148744271840684e+00, -8.3115202323860060e-01, 2.1633011812923648e+00, -2.8539460745428205e+00, 1.2342612576538128e+00,
        -1.5842572057662697e-02, -1.9330590373009877e+00, 3.4167054739311955e+00, -3.3330076528705246e+00, 7.9214396353617578e-01, 9.7779680823331205e-01,
        -1.7119007404034584e-01, 4.2430521303823481e+00, -1.0084309674947707e+00, 6.9547355920839116e-01, -3.1347594048781224e-01, -1.9330590373009957e+00,
        3.7492710927634914e+00, -3.5592472331681226e+00, -3.4076656429852380e-02, 5.5442746605283055e-01, -2.4423660468414268e-16, 4.5310641702982490e+00,
        4.3380947396409110e-02, -1.2499260451994673e-01, 1.2499260451994676e-01, -1.9330590373009904e+00, -5.8913042111985412e+00, -1.4711148381875006e+00,
        1.6136475856828228e-01, 1.2827265647614817e+01, -1.1762111052356032e+00, 1.8727880636075580e+00, -2.0542379553857060e-01, 1.1311403928438428e+00,
        4.8455424518915063e-01, -1.9330590373009795e+00, 1.0213989429133579e+00, -4.6487098044534987e+00, 3.4175961947383637e+00, 4.0271178833292405e+00,
        -4.1518369083043094e-01, 5.9179936242654554e+00, -4.3507367294468517e+00, 4.9756349189949389e-01, 1.6535064679152142e-01, -1.9330590373009955e+00,
        1.1927359137005446e+01, -3.7874514632244414e+00, 2.0463938995432054e+00, -9.8566059045696708e+00, 8.3304631557717534e-01, 4.8215772879830503e+00,
        -2.6051413316078427e+00, -4.7955449618885926e-01, -4.7955449618885854e-01, -1.9330590373010201e+00, 1.2259924755837741e+01, -1.6257374643920350e-01,
        -1.6110561095734466e+00, -1.0279975246750155e+01, 1.0042363896175190e+00, 2.0696288548243441e-01, 2.0509389025866254e+00, -1.0500354508773047e+00,
        -2.9107116022099178e-01, -1.9330590373010172e+00, 5.2117583524835549e+00, 2.2418353145413419e+00, -1.6993190682438215e+00, -1.3073773448865935e+00,
        3.4316478965842839e-01, -2.8539460745428218e+00, 2.1633011812923630e+00, -9.5334473768337691e-01, 2.9675909202809936e-01, -1.9330590373009957e+00,
        3.0896682604073367e+00, 2.7880259776413956e+00, 2.9535395799047359e-01, 1.3941282692071935e+00, 7.0124608833429705e-02, -3.5492686474345159e+00,
        -3.7599740870352644e-01, -4.2391812020101916e-01, 1.5827993394684697e-01, -1.9330590373009926e+00, 3.7492710927634851e+00, 3.0167309868705985e+00,
        -5.0843958986766669e-01, 5.5442746605284399e-01, -8.0249170110504034e-16, -3.8404192770477774e+00, 6.4726394585405456e-01, 3.0175884102839134e-01,
        -3.0175884102839196e-01, -1.9330590373009979e+00, -1.3739075881044873e+00, 2.0232575732513052e+00, -2.1018940431553910e+00, 7.0764389584251246e+00,
        -6.5917730762051774e-01, -2.5756878623133646e+00, 2.6757952355637484e+00, 9.7639007917882825e-01, -3.2559420517374961e-02, -1.9330590373009879e+00,
        6.9436172938949681e-01, 3.5612118829268486e+00, -2.8726145195092365e+00, 4.4434493443031124e+00, -1.7386900795665683e-01, -4.5335652480671653e+00,
        3.6569532464990187e+00, -1.9507674196157776e-01, 2.1035507567784326e-01, -1.9330590373009822e+00, -4.4288169514784723e+00, 1.4787766771950615e+00,
        2.6228088648618086e-01, 1.0965460836675387e+01, -8.3304631557717368e-01, -1.8825418912940013e+00, -3.3389406508122033e-01, 4.7955449618885920e-01,
        4.7955449618885881e-01, -1.9330590373009739e+00, 1.0213989429133630e+00, -9.2492417508744296e-01, 2.1560377848025758e+00, 4.0271178833292218e+00,
        -4.1518369083043255e-01, 1.1774654907158579e+00, -2.7447223855344669e+00, 7.4754870093938741e-01, -8.4634562248370945e-02, -1.9330590373009895e+00,
        5.6742588152497051e+00, -1.4711148381874961e+00, 1.6136475856827981e-01, -1.8961589434384531e+00, 1.8942923385738700e-03, 1.8727880636075485e+00,
        -2.0542379553857468e-01, 6.2971415694500799e-01, -3.7040446372657426e-01, -1.9330590373010044e+00, 3.4167054739311959e+00, -1.7005280561147456e+00,
        -8.4033563321960447e-01, 9.7779680823331450e-01, -1.7119007404034647e-01, 2.1648402712362200e+00, 1.0697808916513611e+00, 2.6872211366005333e-01,
        1.1327550506052592e-01, -1.9330590373010001e+00, 3.7492710927634869e+00, -2.2494971535489037e+00, 1.2756734231893618e+00, 5.5442746605284754e-01,
        5.2336415289459156e-17, 2.8636999022292682e+00, -1.6239833206725693e+00, -3.0175884102839173e-01, 3.0175884102839173e-01, -1.9330590373009993e+00,
        9.8646182248198926e+00, -9.3575965172465803e-01, 1.5569123679262611e+00, -7.2306541716542441e+00, 7.6024277282743402e-01, 1.1912594861150811e+00,
        -1.9820117526159082e+00, -8.2119407263786359e-01, -2.3899601848999669e-01, -1.9330590373010084e+00, 1.0002371414519232e+01, 2.2418353145413419e+00,
        -1.6993190682438193e+00, -7.4060194950783620e+00, 8.3115202323860127e-01, -2.8539460745428178e+00, 2.1633011812923595e+00, -8.0750981210547623e-01,
        -4.1090887349067462e-01, -1.9330590373010021e+00, 7.1367460749697669e+00, 1.5370291956071866e-01, -1.8947604832419556e+00, -3.7579637543778812e+00,
        3.4505908199700303e-01, -1.9566996785213361e-01, 2.4121059242273444e+00, -1.9863797621842200e-01, -1.9863797621842180e-01, -1.9330590373009944e+00,
        6.9436172938950214e-01, 3.7994249985831396e-01, -1.0685398632759247e+00, 4.4434493443030982e+00, -1.7386900795665688e-01, -4.8368200776803005e-01,
        1.3602940093361691e+00, -3.7184297847002296e-01, 3.8712131218628787e-01, -1.9330590373009733e+00, 1.8242833702772825e+00, -1.6136475856828050e-01,
        1.4711148381874977e+00, 3.0050138755441327e+00, -1.8942923385731024e-03, 2.0542379553857182e-01, -1.8727880636075569e+00, -4.5294792043656285e-01,
        1.9363822721812946e-01, -1.9330590373009719e+00, 6.4771432426136251e+00, 7.0755542166833529e-01, 5.2355818804679577e-01, -2.9182629512235443e+00,
        4.1518369083043166e-01, -9.0074636843026901e-01, -6.6651052638833663e-01, -3.2079725539104975e-01, -3.4211688329996709e-01, -1.9330590373009857e+00,
        3.7492710927634887e+00, 1.7069809072513831e+00, -1.8181896694868831e+00, 5.5442746605283233e-01, 3.1401849173675493e-16, -2.1730550089788063e+00,
        2.3146282139230339e+00, 1.2499260451994619e-01, -1.2499260451994623e-01, -1.9330590373009908e+00, -1.3739075881044864e+00, 3.9077797649552948e-01,
        -4.6941444639961383e-01, 7.0764389584251219e+00, -6.5917730762051763e-01, -4.9747600316724561e-01, 5.9758337641762416e-01, 5.4963863363049004e-01,
        3.9419202503096273e-01, -1.9330590373009902e+00, 2.2867838330434145e+00, -1.6993190682438197e+00, 2.2418353145413397e+00, 2.4162322769922939e+00,
        -3.4316478965842850e-01, 2.1633011812923590e+00, -2.8539460745428191e+00, 5.2659329213503792e-01, 1.2999235352023900e-01, -1.9330590373009997e+00,
        9.1994869871553107e+00, -1.4782758980221780e+00, 1.0143961216287443e+00, -6.3839154872932875e+00, 4.1786262474674096e-01, 1.8819043793655295e+00,
        -1.2913668593654586e+00, 1.4300160023058195e-01, -4.3919645391728313e-01, -1.9330590373010077e+00,
      };
      long i = 0;
      struct gkyl_range_iter iter;
      gkyl_range_iter_init(&iter, &localRange);
      while (gkyl_range_iter_next(&iter)) {
        long loc = gkyl_range_idx(&localRange, iter.idx);
        const double *phi_p = gkyl_array_cfetch(phi, loc);
        if (iter.idx[2] == 3) {
          // Only check one cell in z:
          for (int m=0; m<basis.num_basis/2; m++) {
            TEST_CHECK( gkyl_compare(sol[i], phi_p[m], 1e-12) );
            TEST_MSG("Expected: %.13e in cell (%d,%d,%d)", sol[i], iter.idx[0], iter.idx[1], iter.idx[2]);
            TEST_MSG("Produced: %.13e", phi_p[m]);
            i += 1;
          }
        }
      }
    } else if ((bcs.lo_type[0] == GKYL_POISSON_DIRICHLET && bcs.up_type[0] == GKYL_POISSON_DIRICHLET) &&
               (bcs.lo_type[1] == GKYL_POISSON_DIRICHLET && bcs.up_type[1] == GKYL_POISSON_DIRICHLET)) {
      // Solution; checked convergence but note that p=2 serendipity doesn't
      // converge as p+1. One must use tensor basis and a RHS in the space of
      // the basis for that.
      const double sol[640] = {
        -1.6736386918814842e-04, -8.9993566755474939e-05, -8.9993566755553327e-05, 2.1306090344382802e-04, -4.8127663587508573e-05, 1.1456541205790448e-04,
        1.1456541205785753e-04, 5.1386806341961409e-06, 5.1386806342542322e-06, 1.3021735293941976e-16, -4.0904809409466058e-04, -2.1943276528524800e-04,
        -4.9944248969825226e-05, 5.2073459404767034e-04, -2.6835819803993821e-05, 2.7934669199395864e-04, 6.3581027727126449e-05, 1.2959979779996389e-05,
        4.8277858685092419e-06, 2.5963965559206471e-18, -5.1818273509544963e-04, -2.7802320360133129e-04, -1.3907438669093784e-05, 6.5966735965373763e-04,
        -7.4779609092899315e-06, 3.5393466478226404e-04, 1.7704726007174729e-05, 1.6382516606644185e-05, 4.1749764935150647e-06, -6.3547404895491045e-17,
        -5.1295357548712922e-04, -2.7521036368747691e-04, 1.5668491170627079e-05, 6.5301043019852262e-04, 8.3756457236890595e-06, 3.5035380700139911e-04,
        -1.9946616319957822e-05, 1.6222781764510503e-05, 3.2005306256819650e-06, 2.2995172754667680e-16, -4.2024623592899952e-04, -2.2547403683496499e-04,
        3.6177829984709971e-05, 5.3499027675668620e-04, 1.9370676929407923e-05, 2.8703747245083336e-04, -4.6055825421175033e-05, 1.3288392231881120e-05,
        1.9005356520037570e-06, 3.1362767201675851e-16, -2.7595668815097143e-04, -1.4805299908269591e-04, 4.5030778835311037e-05, 3.5130390791152642e-04,
        2.4117676294458697e-05, 1.8847739297140733e-04, -5.7325983606757273e-05, 8.7302227497018262e-06, 2.7620610285165812e-07, -2.5080839944164045e-17,
        -1.2491297408360295e-04, -6.7053537941976415e-05, 3.9653588273064960e-05, 1.5901921507471145e-04, 2.1192021856326956e-05, 8.5361837309139718e-05,
        -5.0480604823932580e-05, 3.9233331137339112e-06, -1.6763676439127430e-06, -1.9950606076705151e-17, -2.1186748034872204e-05, -1.1173638897301938e-05,
        1.7314566130892644e-05, 2.6971578150237605e-05, 9.3854234968676341e-06, 1.4224489489855110e-05, -2.2042135620260495e-05, 8.1993829229793671e-07,
        -3.9368034886668810e-06, 1.3826372781016619e-17, -4.0904809409451714e-04, -4.9944248969747733e-05, -2.1943276528526315e-04, 5.2073459404797934e-04,
        -2.6835819804019046e-05, 6.3581027727065517e-05, 2.7934669199371020e-04, 4.8277858685077774e-06, 1.2959979779994376e-05, 6.9723122910651338e-17,
        -9.9858541584180540e-04, -1.2197991056199567e-04, -1.2197991056206587e-04, 1.2712391981478468e-03, -1.4892793976961156e-05, 1.5528530782951420e-04,
        1.5528530782953203e-04, 1.2151963571855302e-05, 1.2151963571851188e-05, 5.5315123985650645e-17, -1.2650670719583249e-03, -1.5452803962138343e-04,
        -3.3989146299085161e-05, 1.6104810110849606e-03, -4.1472845964592906e-06, 1.9672037871097946e-04, 4.3269543497749215e-05, 1.5346594041114546e-05,
        1.0513071189119953e-05, 8.1224921361588226e-17, -1.2522942054227102e-03, -1.5296725544019501e-04, 3.8195274286687170e-05, 1.5942206408098643e-03,
        4.6718088449734621e-06, 1.9473343798517319e-04, -4.8624112756910573e-05, 1.5201005557162338e-05, 8.0589243504866540e-06, 1.2646430323484297e-16,
        -1.0259673331826800e-03, -1.2532171759625012e-04, 8.8249173983067660e-05, 1.3060974747577253e-03, 1.0787713458074866e-05, 1.5953956192457048e-04,
        -1.1234473024707882e-04, 1.2449879038406603e-05, 4.7859185315923841e-06, 1.2492617262243828e-16, -6.7370284092416264e-04, -8.2291875715507218e-05,
        1.0985003716686473e-04, 8.5765067834920466e-04, 1.3428120325720441e-05, 1.0476085113908371e-04, -1.3984349355511364e-04, 8.1833370321413966e-06,
        6.9543751779662684e-07, 7.0997481676593796e-17, -3.0500488785042019e-04, -3.7252512702599006e-05, 9.6677053695450602e-05, 3.8828342864919080e-04,
        1.1825246932944356e-05, 4.7423939530637341e-05, -1.2307375840803705e-04, 3.6677659788390534e-06, -4.2161030397036606e-06, -3.8675472809755950e-18,
        -5.1280526705659661e-05, -6.2839193715145735e-06, 4.2430283014355643e-05, 6.5282162763118009e-05, 5.1630088156727532e-06, 7.9996808448424854e-06,
        -5.4015448353894996e-05, 7.5571876572633797e-07, -9.9330071707124047e-06, -8.6830981711185261e-17, -5.1818273509495415e-04, -1.3907438669079623e-05,
        -2.7802320360142870e-04, 6.5966735965313611e-04, -7.4779609092294263e-06, 1.7704726006891892e-05, 3.5393466478249959e-04, 4.1749764934271104e-06,
        1.6382516606623020e-05, 4.0749186165041001e-17, -1.2650670719581497e-03, -3.3989146299039705e-05, -1.5452803962143685e-04, 1.6104810110848080e-03,
        -4.1472845964594609e-06, 4.3269543497699613e-05, 1.9672037871103638e-04, 1.0513071189135437e-05, 1.5346594041119834e-05, 7.9240261984326072e-17,
        -1.6026670347201000e-03, -4.3053493382510712e-05, -4.3053493382558044e-05, 2.0402592745641132e-03, -1.1564832204205967e-06, 5.4808820093699731e-05,
        5.4808820093733822e-05, 1.3279889860017377e-05, 1.3279889860022863e-05, 9.2097956645809326e-17, -1.5864825433925698e-03, -4.2619862890565045e-05,
        4.8395012432343505e-05, 2.0196557693944101e-03, 1.3017448917312349e-06, 5.4256791123399684e-05, -6.1608787613830381e-05, 1.3153443349271750e-05,
        1.0179488166753925e-05, 1.0205130438863518e-16, -1.2997582939416842e-03, -3.4916529755849637e-05, 1.1180845736502144e-04, 1.6546443250261163e-03,
        3.0057340765579082e-06, 4.4450139752483907e-05, -1.4233664084413466e-04, 1.0772906330799025e-05, 6.0455797587637271e-06, 9.1330888093378114e-17,
        -8.5348426805717222e-04, -2.2928719752622003e-05, 1.3917704869122568e-04, 1.0865196300130122e-03, 3.7402936569764150e-06, 2.9189177861487167e-05,
        -1.7717795290418068e-04, 7.0805126791898829e-06, 8.7830508376714211e-07, 5.6615583707764242e-17, -3.8639859219410038e-04, -1.0375616284744785e-05,
        1.2249026701637098e-04, 4.9190087168677211e-04, 3.2966811714911069e-06, 1.3208574766734493e-05, -1.5593501202052922e-04, 3.1755470736365147e-06,
        -5.3221282290210776e-06, 5.8555555451602192e-18, -6.4987942613438211e-05, -1.7584195977303762e-06, 5.3733951100266865e-05, 8.2732251790000952e-05,
        1.4372749293382423e-06, 2.2385385205262093e-06, -6.8405470204461853e-05, 6.5629254036916556e-07, -1.2558648067133677e-05, -6.2643782381705725e-17,
        -5.1295357548637873e-04, 1.5668491170882496e-05, -2.7521036368765222e-04, 6.5301043019802346e-04, 8.3756457234651734e-06, -1.9946616319747704e-05,
        3.5035380700151241e-04, 3.2005306256888069e-06, 1.6222781764533938e-05, 1.1021652978936597e-16, -1.2522942054223754e-03, 3.8195274286697429e-05,
        -1.5296725544028156e-04, 1.5942206408096325e-03, 4.6718088449811464e-06, -4.8624112756891437e-05, 1.9473343798523865e-04, 8.0589243504738045e-06,
        1.5201005557168734e-05, 8.5918816888484507e-17, -1.5864825433924558e-03, 4.8395012432365846e-05, -4.2619862890609910e-05, 2.0196557693943381e-03,
        1.3017448917293096e-06, -6.1608787613840504e-05, 5.4256791123429228e-05, 1.0179488166751226e-05, 1.3153443349275177e-05, 8.8436997644373772e-17,
        -1.5704614601383636e-03, 4.7905128339743241e-05, 4.7905128339721455e-05, 1.9992602892418077e-03, -1.4574932682125792e-06, -6.0985145558572417e-05,
        -6.0985145558559136e-05, 1.0082546116344673e-05, 1.0082546116347507e-05, 8.7079524843457519e-17, -1.2866320417064825e-03, 3.9248066346110315e-05,
        1.1067785968105715e-04, 1.6379340806129848e-03, -3.3712632304338978e-06, -4.9964359181647862e-05, -1.4089734474548839e-04, 8.2578616887689264e-06,
        5.9880257100210153e-06, 7.5321941371283178e-17, -8.4486437881703771e-04, 2.5771383674393462e-05, 1.3776937488854907e-04, 1.0755461660389958e-03,
        -4.1977162667747768e-06, -3.2808002798411447e-05, -1.7538592781772406e-04, 5.4274990248750375e-06, 8.6992119349358339e-07, 5.0348534537109036e-17,
        -3.8249295195446459e-04, 1.1673090903164162e-05, 1.2125163449742982e-04, 4.8692883535647754e-04, -3.6878033555764420e-06, -1.4860311881417390e-05,
        -1.5435818325335691e-04, 2.4339111771927973e-06, -5.2720559362171523e-06, 1.5157875640171339e-17, -6.4327335572091798e-05, 1.9416918503506198e-06,
        5.3193484611823988e-05, 8.1891272588506745e-05, -1.6349233391438523e-06, -2.4718514327569146e-06, -6.7717434735062581e-05, 5.0282216664009615e-07,
        -1.2435436975576558e-05, -9.9002448715467669e-18, -4.2024623592846105e-04, 3.6177829984429400e-05, -2.2547403683507238e-04, 5.3499027675656065e-04,
        1.9370676929591888e-05, -4.6055825421170601e-05, 2.8703747245078457e-04, 1.9005356520859239e-06, 1.3288392231919035e-05, 9.9271504070519187e-17,
        -1.0259673331823702e-03, 8.8249173983027626e-05, -1.2532171759632019e-04, 1.3060974747575818e-03, 1.0787713458090848e-05, -1.1234473024706425e-04,
        1.5953956192458536e-04, 4.7859185315675474e-06, 1.2449879038409287e-05, 7.5617121957013773e-17, -1.2997582939415506e-03, 1.1180845736501496e-04,
        -3.4916529755881803e-05, 1.6546443250260369e-03, 3.0057340765646887e-06, -1.4233664084413027e-04, 4.4450139752502529e-05, 6.0455797587646961e-06,
        1.0772906330801502e-05, 7.4237365136813508e-17, -1.2866320417064361e-03, 1.1067785968106318e-04, 3.9248066346090854e-05, 1.6379340806129577e-03,
        -3.3712632304321939e-06, -1.4089734474549226e-04, -4.9964359181636593e-05, 5.9880257100190332e-06, 8.2578616887703291e-06, 7.2093480822636435e-17,
        -1.0540980928973197e-03, 9.0676106148561848e-05, 9.0676106148553960e-05, 1.3419090576788013e-03, -7.7938401140048707e-06, -1.1543431202056919e-04,
        -1.1543431202056450e-04, 4.9043496343493622e-06, 4.9043496343501398e-06, 6.3037991309102385e-17, -6.9217011202356304e-04, 5.9541218839865003e-05,
        1.1287158611772119e-04, 8.8116025352627286e-04, -9.7032178227066747e-06, -7.5798354446155174e-05, -1.4369004629315670e-04, 3.2234047118027443e-06,
        7.1260045700449238e-07, 4.4875646352635977e-17, -3.1336327392571109e-04, 2.6963244897811973e-05, 9.9338449335989494e-05, 3.9892398862896702e-04,
        -8.5312831858724501e-06, -3.4325289834583248e-05, -1.2646182156855073e-04, 1.4457563333310716e-06, -4.3177809666449573e-06, 2.0591662977301158e-17,
        -5.2701904096224544e-05, 4.5069561575177094e-06, 4.3578076238989909e-05, 6.7091633065451405e-05, -3.7645201112378417e-06, -5.7375355586665948e-06,
        -5.5476635063979589e-05, 2.9887242508465092e-07, -1.0186424686089527e-05, -4.2994398398959147e-18, -2.7595668815092784e-04, 4.5030778835202332e-05,
        -1.4805299908260343e-04, 3.5130390791139420e-04, 2.4117676294505365e-05, -5.7325983606700216e-05, 1.8847739297142972e-04, 2.7620610285355521e-07,
        8.7302227496579397e-06, 2.2068417882700666e-17, -6.7370284092403904e-04, 1.0985003716684141e-04, -8.2291875715501757e-05, 8.5765067834911381e-04,
        1.3428120325718364e-05, -1.3984349355510245e-04, 1.0476085113909073e-04, 6.9543751780616676e-07, 8.1833370321377933e-06, 4.8437492265353730e-17,
        -8.5348426805707486e-04, 1.3917704869120990e-04, -2.2928719752636328e-05, 1.0865196300129493e-03, 3.7402936569831785e-06, -1.7717795290417499e-04,
        2.9189177861496532e-05, 8.7830508376708133e-07, 7.0805126791911475e-06, 5.2844436006943742e-17, -8.4486437881698816e-04, 1.3776937488854695e-04,
        2.5771383674380513e-05, 1.0755461660389629e-03, -4.1977162667738222e-06, -1.7538592781772452e-04, -3.2808002798403451e-05, 8.6992119349322436e-07,
        5.4274990248764156e-06, 5.3857020936747595e-17, -6.9217011202354765e-04, 1.1287158611772247e-04, 5.9541218839857820e-05, 8.8116025352626148e-04,
        -9.7032178227062241e-06, -1.4369004629315852e-04, -7.5798354446150322e-05, 7.1260045700381200e-07, 3.2234047118037552e-06, 4.7224205907133811e-17,
        -4.5451002284198453e-04, 7.4115147977006358e-05, 7.4115147977004203e-05, 5.7860944874782883e-04, -1.2080644800994201e-05, -9.4351549492118655e-05,
        -9.4351549492116771e-05, 4.6835828133488412e-07, 4.6835828133561553e-07, 3.4282674743364552e-17, -2.0576429737189132e-04, 3.3563630657697868e-05,
        6.5229065397315528e-05, 2.6194618532257558e-04, -1.0621583438880923e-05, -4.2727845056957630e-05, -8.3039210743648229e-05, 2.0994736147339859e-07,
        -2.8385484135676012e-06, 1.7422616860709244e-17, -3.4602943899175216e-05, 5.6125950401316104e-06, 2.8616778662176850e-05, 4.4050932407094513e-05,
        -4.6829279478430336e-06, -7.1450581043514569e-06, -3.6430304491689317e-05, 4.3342012469426337e-08, -6.6915544801017071e-06, -3.5904178472779480e-18,
        -1.2491297408348596e-04, 3.9653588273158940e-05, -6.7053537942000783e-05, 1.5901921507466678e-04, 2.1192021856246867e-05, -5.0480604823934877e-05,
        8.5361837309134270e-05, -1.6763676439549742e-06, 3.9233331137395939e-06, 4.4671544762584355e-18, -3.0500488785035785e-04, 9.6677053695436562e-05,
        -3.7252512702608323e-05, 3.8828342864913893e-04, 1.1825246932935438e-05, -1.2307375840802916e-04, 4.7423939530636514e-05, -4.2161030396958425e-06,
        3.6677659788430429e-06, 2.4128934571038136e-17, -3.8639859219403587e-04, 1.2249026701636486e-04, -1.0375616284750664e-05, 4.9190087168672289e-04,
        3.2966811714913877e-06, -1.5593501202052686e-04, 1.3208574766736104e-05, -5.3221282290233434e-06, 3.1755470736278715e-06, 3.1432284870142483e-17,
        -3.8249295195442838e-04, 1.2125163449742528e-04, 1.1673090903159696e-05, 4.8692883535644642e-04, -3.6878033555725236e-06, -1.5435818325335593e-04,
        -1.4860311881412347e-05, -5.2720559362166873e-06, 2.4339111771886909e-06, 3.2077275460478534e-17, -3.1336327392569852e-04, 9.9338449335986784e-05,
        2.6963244897806884e-05, 3.9892398862895548e-04, -8.5312831858720622e-06, -1.2646182156854913e-04, -3.4325289834580172e-05, -4.3177809666453419e-06,
        1.4457563333301612e-06, 2.8122834349512110e-17, -2.0576429737189064e-04, 6.5229065397313983e-05, 3.3563630657696838e-05, 2.6194618532257119e-04,
        -1.0621583438879969e-05, -8.3039210743649097e-05, -4.2727845056955679e-05, -2.8385484135681285e-06, 2.0994736147304273e-07, 2.0500639862063439e-17,
        -9.3151209302059127e-05, 2.9542138267396792e-05, 2.9542138267397802e-05, 1.1858521738957481e-04, -9.3312153718748475e-06, -3.7608324302396471e-05,
        -3.7608324302396125e-05, -1.2706382352886107e-06, -1.2706382352886850e-06, 1.0852179600489556e-17, -1.5684011184944028e-05, 4.9183748803106635e-06,
        1.2939562203297638e-05, 1.9966373918734288e-05, -4.1420646084805540e-06, -6.2612880579344652e-06, -1.6472580531169222e-05, -2.6020768542684102e-07,
        -3.0088387502362375e-06, 2.9995937327780627e-18, -2.1186748034736431e-05, 1.7314566130796099e-05, -1.1173638897437015e-05, 2.6971578150202090e-05,
        9.3854234968672513e-06, -2.2042135620263812e-05, 1.4224489489858336e-05, -3.9368034887195114e-06, 8.1993829231012340e-07, 7.6416996781065047e-18,
        -5.1280526705648921e-05, 4.2430283014323821e-05, -6.2839193714807337e-06, 6.5282162763124067e-05, 5.1630088157216431e-06, -5.4015448353865011e-05,
        7.9996808448244386e-06, -9.9330071707169702e-06, 7.5571876571604143e-07, 9.7641800636517703e-18, -6.4987942613452184e-05, 5.3733951100238621e-05,
        -1.7584195977080992e-06, 8.2732251789935588e-05, 1.4372749293546847e-06, -6.8405470204479200e-05, 2.2385385205287847e-06, -1.2558648067127453e-05,
        6.5629254041339423e-07, 9.0893247680704442e-18, -6.4327335572037439e-05, 5.3193484611841084e-05, 1.9416918503227109e-06, 8.1891272588485915e-05,
        -1.6349233391667857e-06, -6.7717434735056211e-05, -2.4718514327320817e-06, -1.2435436975574417e-05, 5.0282216664938090e-07, 9.9415504832613775e-18,
        -5.2701904096233008e-05, 4.3578076238977095e-05, 4.5069561575094119e-06, 6.7091633065443219e-05, -3.7645201112378235e-06, -5.5476635063977041e-05,
        -5.7375355586687267e-06, -1.0186424686092530e-05, 2.9887242509399168e-07, 8.8524613742982187e-18, -3.4602943899185231e-05, 2.8616778662172665e-05,
        5.6125950401316646e-06, 4.4050932407092101e-05, -4.6829279478433995e-06, -3.6430304491688470e-05, -7.1450581043495511e-06, -6.6915544801019002e-06,
        4.3342012473073687e-08, 6.6378527613512372e-18, -1.5684011184945674e-05, 1.2939562203297628e-05, 4.9183748803111208e-06, 1.9966373918733990e-05,
        -4.1420646084811334e-06, -1.6472580531168789e-05, -6.2612880579338876e-06, -3.0088387502362185e-06, -2.6020768542654058e-07, 3.8580014055187301e-18,
        -2.4631643688340385e-06, 2.2363599383471548e-06, 2.2363599383472056e-06, 3.1357068183325297e-06, -1.7612712352079330e-06, -2.8469757015205160e-06,
        -2.8469757015205410e-06, -6.3071636577514211e-07, -6.3071636577518499e-07, 1.2372631589442725e-18,
      };
      long i = 0;
      struct gkyl_range_iter iter;
      gkyl_range_iter_init(&iter, &localRange);
      while (gkyl_range_iter_next(&iter)) {
        long loc = gkyl_range_idx(&localRange, iter.idx);
        const double *phi_p = gkyl_array_cfetch(phi, loc);
        if (iter.idx[2] == 3) {
          // Only check one cell in z:
          for (int m=0; m<basis.num_basis/2; m++) {
            TEST_CHECK( gkyl_compare(sol[i], phi_p[m], 1e-12) );
            TEST_MSG("Expected: %.13e in cell (%d,%d,%d)", sol[i], iter.idx[0], iter.idx[1], iter.idx[2]);
            TEST_MSG("Produced: %.13e", phi_p[m]);
            i += 1;
          }
        }
      }
    }
  }

//  gkyl_grid_sub_array_write(&grid, &localRange, rho, "ctest_fem_poisson_perp_rho_1.gkyl");
//  gkyl_grid_sub_array_write(&grid, &localRange, phi, "ctest_fem_poisson_perp_phi_8x8x8_p2.gkyl");
//  gkyl_grid_sub_array_write(&grid, &localRange, phisol, "ctest_fem_poisson_perp_phisol_8x8x8_p2.gkyl");

  gkyl_fem_poisson_perp_release(poisson);
  gkyl_proj_on_basis_release(projob);
  gkyl_proj_on_basis_release(projob_sol);
  gkyl_array_release(rho);
  gkyl_array_release(eps);
  gkyl_array_release(phi);
  gkyl_array_release(phisol);
  if (use_gpu) {
    gkyl_array_release(rho_cu);
    gkyl_array_release(phi_cu);
  }

}

void test_p1_periodicx_periodicy_consteps() {
  int cells[] = {8,8,8};
  struct gkyl_poisson_bc bc_tv;
  bc_tv.lo_type[0] = GKYL_POISSON_PERIODIC;
  bc_tv.up_type[0] = GKYL_POISSON_PERIODIC;
  bc_tv.lo_type[1] = GKYL_POISSON_PERIODIC;
  bc_tv.up_type[1] = GKYL_POISSON_PERIODIC;
  test_fem_poisson_perp_consteps(1, cells, bc_tv, false);
}

void test_p1_dirichletx_dirichlety_consteps() {
  int cells[] = {8,8,8};
  struct gkyl_poisson_bc bc_tv;
  bc_tv.lo_type[0] = GKYL_POISSON_DIRICHLET;
  bc_tv.up_type[0] = GKYL_POISSON_DIRICHLET;
  bc_tv.lo_type[1] = GKYL_POISSON_DIRICHLET;
  bc_tv.up_type[1] = GKYL_POISSON_DIRICHLET;
  bc_tv.lo_value[0].v[0] = 0.;
  bc_tv.up_value[0].v[0] = 0.;
  bc_tv.lo_value[1].v[0] = 0.;
  bc_tv.up_value[1].v[0] = 0.;
  test_fem_poisson_perp_consteps(1, cells, bc_tv, false);
}

void test_p2_periodicx_periodicy_consteps() {
  int cells[] = {8,8,8};
  struct gkyl_poisson_bc bc_tv;
  bc_tv.lo_type[0] = GKYL_POISSON_PERIODIC;
  bc_tv.up_type[0] = GKYL_POISSON_PERIODIC;
  bc_tv.lo_type[1] = GKYL_POISSON_PERIODIC;
  bc_tv.up_type[1] = GKYL_POISSON_PERIODIC;
  test_fem_poisson_perp_consteps(2, cells, bc_tv, false);
}

void test_p2_dirichletx_dirichlety_consteps() {
  int cells[] = {8,8,8};
  struct gkyl_poisson_bc bc_tv;
  bc_tv.lo_type[0] = GKYL_POISSON_DIRICHLET;
  bc_tv.up_type[0] = GKYL_POISSON_DIRICHLET;
  bc_tv.lo_type[1] = GKYL_POISSON_DIRICHLET;
  bc_tv.up_type[1] = GKYL_POISSON_DIRICHLET;
  bc_tv.lo_value[0].v[0] = 0.;
  bc_tv.up_value[0].v[0] = 0.;
  bc_tv.lo_value[1].v[0] = 0.;
  bc_tv.up_value[1].v[0] = 0.;
  test_fem_poisson_perp_consteps(2, cells, bc_tv, false);
}

TEST_LIST = {
  { "test_p1_periodicx_periodicy", test_p1_periodicx_periodicy_consteps },
  { "test_p1_dirichletx_dirichlety", test_p1_dirichletx_dirichlety_consteps },
  { "test_p2_periodicx_periodicy", test_p2_periodicx_periodicy_consteps },
  { "test_p2_dirichletx_dirichlety", test_p2_dirichletx_dirichlety_consteps },
  { NULL, NULL },
};

